# AMLO 场景2 测试步骤 - ATR (资产抵押大额交易)

## 测试目标
触发 AMLO-1-01 + AMLO-1-02 双报告预约

## 测试数据
- **客户姓名**: 李四
- **证件号码**: P987654321
- **交易金额**: 8,750,000 THB (相当于约 250,000 USD，汇率 35.00)
- **交易类型**: 资产抵押交易
- **资金来源**: 必须选择（如：salary, business, investment等）

---

## 详细测试步骤

### 1️⃣ 打开标准兑换表单
路径：菜单 → 外币兑换 → 标准兑换

### 2️⃣ 步骤1：选择外币
- 选择外币：**美元 (USD)**

### 3️⃣ 步骤2：选择交易方向
- 选择：**卖出美元** (界面左侧的选项)
  - 说明：这表示客户买入外币，网点卖出外币

### 4️⃣ 步骤3：选择用途
- 选择任意有效用途（如：旅游、购物等）

### 5️⃣ 步骤4：输入金额
有两种输入方式，选择其中一种：

#### 方式A：顾客有本币（推荐）
1. 点击"**顾客有外币**"选项
2. 在"顾客支付泰铢(THB)"输入框中输入：**8750000**
3. ✨ **此时会立即显示"交易类型选择"区块**（无需点击计算）

#### 方式B：顾客需要外币
1. 点击"**顾客需要**"选项
2. 在"顾客需要美元(USD)"输入框中输入对应的美元金额（约 250000）
3. ✨ **此时会立即显示"交易类型选择"区块**（无需点击计算）

---

### 6️⃣ 关键步骤：选择交易类型
输入金额后，**自动显示**以下区块：

```
╔══════════════════════════════════════════════════════╗
║ 📄 交易类型选择 (大额交易监管要求)                     ║
╠══════════════════════════════════════════════════════╣
║ ◉ 普通交易 - 正常的外币兑换业务                        ║
║ ◯ 资产抵押交易 - 使用房产、车辆等资产抵押的大额兑换     ║
║                                                      ║
║ 资金来源: [下拉选择框]                                 ║
╚══════════════════════════════════════════════════════╝
```

**操作**：
1. 选择 **"资产抵押交易"** 单选按钮
2. 在"资金来源"下拉框中选择一个选项（如：salary/工资收入）
   - ⚠️ **必填项**：如果不选择资金来源，提交时会提示错误

---

### 7️⃣ 步骤5：确认兑换
1. 点击"**确认兑换**"按钮（绿色按钮）
2. 在确认对话框中填写客户信息：
   - **客户姓名**: 李四
   - **证件号码**: P987654321
   - **地址**（可选）
   - **备注**（可选）
3. 点击"**确认**"按钮

---

### 8️⃣ 预期结果

#### ✅ 成功触发预约
系统会显示预约提示：
```
检测到以下触发条件：
- AMLO-1-01: 大额现金交易报告 (金额 >= 2,000,000 THB)
- AMLO-1-02: 资产抵押交易报告 (金额 >= 8,000,000 THB 且为资产抵押类型)

需要提交预约申请，等待管理员审核
```

用户会看到一个**预约详情对话框**，包含：
- 交易信息
- 客户信息
- 触发的报告类型
- 预约编号（自动生成）

#### ✅ 查看预约记录
1. 进入 **AMLO管理 → 预约列表**
2. 应该能看到刚创建的预约记录：
   - 状态：**待审核 (pending)**
   - 报告类型：**AMLO-1-01, AMLO-1-02**
   - 客户：李四 (P987654321)
   - 金额：8,750,000 THB

---

## 故障排查

### ❌ 问题1：没有看到"交易类型选择"区块
**可能原因**：
- 输入的金额 < 2,000,000 THB
- 没有选择交易方向
- 浏览器缓存未清除

**解决方法**：
1. 确认输入的本币金额 >= 2,000,000 THB
2. 刷新浏览器（Ctrl+F5 强制刷新）
3. 检查控制台是否有错误

### ❌ 问题2："资金来源"选项为空
**可能原因**：
- 后端 `funding_sources` 表没有数据

**解决方法**：
```sql
-- 检查资金来源数据
SELECT * FROM funding_sources WHERE is_active = 1;

-- 如果为空，添加测试数据
INSERT INTO funding_sources (source_code, source_name_cn, source_name_en, source_name_th, is_active)
VALUES
  ('salary', '工资收入', 'Salary', 'เงินเดือน', 1),
  ('business', '经营收入', 'Business Income', 'รายได้จากธุรกิจ', 1),
  ('investment', '投资收益', 'Investment', 'การลงทุน', 1);
```

### ❌ 问题3：提交时提示"请选择资金来源"
**原因**：选择了"资产抵押交易"但未选择资金来源

**解决方法**：在"资金来源"下拉框中选择任意一个选项

---

## 数据验证

### 检查预约记录
```sql
SELECT
  id,
  reservation_no,
  customer_name,
  customer_id,
  local_amount,
  report_type,
  exchange_type,
  funding_source,
  status,
  created_at
FROM Reserved_Transaction
WHERE customer_id = 'P987654321'
ORDER BY created_at DESC
LIMIT 1;
```

### 预期结果
```
reservation_no: RES-YYYYMMDD-XXX
customer_name: 李四
customer_id: P987654321
local_amount: 8750000.00
report_type: AMLO-1-01,AMLO-1-02
exchange_type: asset_backed
funding_source: salary (或其他选择的来源)
status: pending
```

---

## 后续操作：管理员审核

### 审核通过流程
1. 管理员登录系统
2. 进入 **AMLO管理 → 预约列表**
3. 找到状态为"待审核"的记录
4. 点击"**审核通过**"按钮
5. 预约状态变为"已通过 (approved)"
6. 柜员可以继续完成交易

### 审核拒绝流程
1. 点击"**审核拒绝**"按钮
2. 填写拒绝原因（必填）
3. 提交后状态变为"已拒绝 (rejected)"
4. 柜员无法使用此预约进行交易

---

## 测试完成检查清单

- [ ] 输入 8,750,000 THB 后，自动显示"交易类型选择"
- [ ] 可以选择"普通交易"和"资产抵押交易"
- [ ] 选择"资产抵押交易"后，"资金来源"变为必填
- [ ] 不选择资金来源时，提交会提示错误
- [ ] 选择资金来源后，可以成功提交
- [ ] 系统提示需要预约审核
- [ ] 预约列表中能看到新记录
- [ ] 预约记录包含正确的报告类型（AMLO-1-01, AMLO-1-02）
- [ ] 管理员可以审核通过或拒绝
- [ ] 审核拒绝时必须填写原因

---

## 关键技术点

### 交易类型自动显示逻辑
```javascript
// 文件：src/views/exchange/mixins/standardExchangeLogic.js

shouldShowExchangeType() {
  // 当本币金额 > 2,000,000 THB 时自动显示
  return this.showExchangeType && this.calculatedLocalAmount > this.LARGE_AMOUNT_THRESHOLD;
}

calculatedLocalAmount() {
  // 实时计算本币金额（根据输入金额和汇率）
  // 支持"顾客有"和"顾客需要"两种模式
  // 无需点击"计算"按钮即可触发
}
```

### 触发规则
```python
# 后端触发检查逻辑
if total_amount >= 2_000_000:
    # 触发 CTR (大额现金交易报告)
    trigger_reports.append('AMLO-1-01')

if total_amount >= 8_000_000 and exchange_type == 'asset_backed':
    # 触发 ATR (资产抵押交易报告)
    trigger_reports.append('AMLO-1-02')
```

---

## 更新日志

**2025-10-20**
- ✅ 修复交易类型选择框不显示的问题
- ✅ 改进本币金额计算逻辑，支持实时判断
- ✅ 无需点击"计算"按钮即可触发交易类型选择
- ✅ 详细说明测试步骤和故障排查方法
