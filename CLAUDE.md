# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a **Currency Exchange Management System** with a Vue 3 frontend and Flask (Python) backend. The system manages foreign currency exchanges, transactions, reporting, and compliance (AMLO/BOT) for currency exchange businesses. It supports multi-branch operations, multi-language (Chinese, Thai, English), role-based access control, and comprehensive end-of-day (EOD) reporting.

**Platform**: Windows-specific (uses batch files, Windows path separators, and Windows file locking solutions)

## Quick Start

For a new developer setting up the project:

```bash
# 1. Configure environment
# Edit .env file with your database credentials and network settings
python setup_environment.py

# 2. Install dependencies
pip install -r requirements.txt
npm install

# 3. Initialize database
python src/init_db.py

# 4. Start backend (in one terminal)
python src/main.py

# 5. Start frontend (in another terminal)
npm run serve

# 6. Access the application
# Frontend: http://localhost:8080 or http://[CURRENT_IP]:8080
# Backend: http://localhost:5001
# Default credentials: admin / admin123
```

## Technology Stack

- **Frontend**: Vue 3, Vue Router, Pinia/Vuex, Ant Design Vue, Chart.js, Vue I18n
- **Backend**: Flask 2.3.3, SQLAlchemy 2.0.23, Flask-JWT-Extended, ReportLab (PDF generation)
- **Database**: MySQL (default) or SQLite (configurable via `.env`)
- **Python**: 3.11.5
- **Node.js**: 18.20.4

## Development Commands

### Frontend (Vue)
```bash
# Start development server (with network access)
npm run serve
# Windows alternative:
start-dev.bat

# Build for production
npm run build

# Lint code
npm run lint

# Run tests
npm test                # Run all tests (Jest)
npm run test:watch      # Watch mode
npm run test:coverage   # With coverage report
npm run test:unit       # Unit tests only
```

**Test Configuration:**
- Test framework: Jest with `@vue/test-utils` for Vue 3
- Config file: `jest.config.js`
- Test location: `tests/unit/**/*.spec.js`
- Coverage excluded: `src/main.js`, `src/router/index.js`
- Setup file: `tests/setup.js`

**Dev Server Details:**
- Frontend runs on: `http://0.0.0.0:8080` (configurable via `vue.config.js`)
- Proxies `/api`, `/static`, `/flags`, `/help` requests to backend
- Backend target: Reads from `VUE_APP_API_BASE_URL` in `.env.local` (auto-generated by `setup_environment.py`)
- Network IP display: `vue.config.js` reads `CURRENT_IP` from environment variables (set by `setup_environment.py`)
- Build output: `src/static/dist_frontend/`
- Overlay errors: ResizeObserver errors from Ant Design Vue are filtered out (lines 34-44)

### Backend (Flask)
```bash
# Install dependencies
pip install -r requirements.txt
pip install -r requirements-test.txt  # Test dependencies (pytest, etc.)

# Run backend server
python src/main.py

# Run tests (pytest)
pytest                           # Run all backend tests
pytest tests/backend/test_*.py   # Run specific test file
pytest -m unit                   # Run unit tests only
pytest -m integration            # Run integration tests only
pytest -m amlo                   # Run AMLO compliance tests only
pytest -m bot                    # Run BOT reporting tests only
pytest -m routes                 # Run API route tests only
pytest -m services               # Run service layer tests only
pytest -v --tb=short             # Verbose with short traceback
pytest --cov=src --cov-report=html  # With coverage report
```

**Backend Details:**
- Default port: `5001` (configurable in `.env`)
- Main entry point: `src/main.py`
- Database migrations: `src/migrations/migrate.py`
- Test structure: `tests/backend/` with pytest configuration in `pytest.ini`
- Python version: 3.11+ required (minimum version enforced in `pytest.ini`)
- Test dependencies: Install separately with `pip install -r requirements-test.txt` (includes pytest, pytest-cov, etc.)

### Database Setup
```bash
# Initialize database with schema
python src/init_db.py

# Run migrations
python run_migration.py

# Initialize countries data
python init_countries_simple.py
```

**Database Configuration Notes:**
- **IMPORTANT**: The system uses `MYSQL_*` environment variables for MySQL connections (e.g., `MYSQL_HOST`, `MYSQL_DATABASE`, `MYSQL_USER`, `MYSQL_PASSWORD`)
- The generic `DB_*` variables (`DB_HOST`, `DB_NAME`, etc.) are legacy and may not be actively used
- Ensure `MYSQL_DATABASE` in `.env` matches your actual database name
- Character set should be `utf8mb4` for proper multilingual support (Thai, Chinese characters)
- For SQLite, set `DB_TYPE=sqlite` (MySQL is default)

### Environment Configuration
```bash
# Sync all config files from .env settings
python setup_environment.py
# Windows alternative:
setup_environment.bat
```

**Environment System (Single Source of Truth: `.env`):**
- The system uses **single `.env` file** in project root as the **only manual configuration**
- **Workflow**: Edit `.env` → Restart backend (`python src/main.py`) → Restart frontend (`npm run serve`)
- **Auto-sync on backend startup**: `main.py` automatically detects `.env` changes and syncs all config files
- **Auto-generated files** (synced automatically on backend startup):
  - `.env.local`: Frontend environment variables (read by Vue CLI)
  - `environment_config.json`: Backend CORS configuration (used by Flask)
  - `src/static/env-config.js`: Frontend runtime configuration
- **NEVER manually edit** auto-generated files - they will be overwritten on next backend restart
- **Optional**: `setup_environment.py` can still be run manually to sync configs without starting backend
- **Important**: `.env` contains actual database credentials - **DO NOT commit sensitive passwords to git**

**Key Environment Variables** (in project root `.env` - the ONLY file you should edit):
- `CURRENT_IP`: Network IP address (e.g., `10.11.32.111`, critical for network access)
- `BACKEND_PORT`: Backend server port (default: `5001`)
- `FRONTEND_PORT`: Frontend dev server port (default: `8080`)
- `BACKEND_URL`: Full backend URL (e.g., `http://10.11.32.111:5001`)
- `FRONTEND_URL`: Full frontend URL (e.g., `http://10.11.32.111:8080`)
- `DB_TYPE`: `mysql` or `sqlite`
- `DB_HOST`, `DB_PORT`, `DB_NAME`, `DB_USER`, `DB_PASSWORD`: Generic database settings (legacy, may not be used)
- `MYSQL_HOST`, `MYSQL_PORT`, `MYSQL_DATABASE`, `MYSQL_USER`, `MYSQL_PASSWORD`: MySQL-specific settings (actively used)
- `MYSQL_CHARSET`: Character set for MySQL (default: `utf8mb4`)
- `LOG_MODE`: `development` or `production` (switches log verbosity)
- `LOG_LEVEL`: Logging level (e.g., `INFO`, `DEBUG`, `WARNING`)
- `SECRET_KEY`: Flask secret key for session management
- `DEFAULT_BRANCH`: Default branch code (e.g., `A005`)

**Auto-Generated Configuration Files (DO NOT EDIT MANUALLY):**
- `.env.local`: Frontend environment variables (synced from `.env` by `setup_environment.py`)
- `environment_config.json`: Backend CORS origins (synced from `.env` by `setup_environment.py`)
- `src/static/env-config.js`: Frontend runtime config (synced from `.env` by `setup_environment.py`)
- **Important**: When IP/network changes, only edit `.env` then run `setup_environment.py`

**Initial Setup Process:**
1. **Create `.env`**: Copy from existing `.env` or create manually with required variables (see above)
2. **Edit `.env`**: Configure `CURRENT_IP`, database credentials, ports, etc.
3. **Sync configuration**: `python setup_environment.py` (syncs `.env` → all config files)
4. **Install dependencies**:
   - Backend: `pip install -r requirements.txt`
   - Frontend: `npm install`
5. **Initialize database**: `python src/init_db.py`
6. **Start servers**:
   - Backend: `python src/main.py`
   - Frontend: `npm run serve` (in separate terminal)

**Configuration Workflow (Single Source of Truth):**
- **To change any network/environment setting**:
  1. Edit `.env` file (the ONLY manual config)
  2. Restart backend: `python src/main.py` (automatically syncs all config files on startup)
  3. Restart frontend: `npm run serve`
- **Auto-sync**: Backend startup automatically detects `.env` changes and updates all config files
- **Never manually edit** `.env.local`, `environment_config.json`, or `src/static/env-config.js`
- These files are auto-generated and will be overwritten on next backend restart
- **Optional**: Run `python setup_environment.py` to sync configs without starting backend

## Architecture

### Backend Structure

**Core Directories:**
- `src/routes/`: Flask blueprints for API endpoints (42 route files)
  - Main routes: `app_exchange.py`, `app_auth.py`, `app_dashboard.py`
  - Query routes: `app_query_transactions.py`, `app_query_balances.py`, `app_*_query.py`
  - Management routes: `app_user_management.py`, `app_currency_management.py`, `app_standards_management.py`
  - Compliance routes: `app_amlo.py`, `app_bot.py`, `app_compliance.py`, `app_repform.py`
  - EOD routes: `app_end_of_day.py`, `app_eod_step.py`
  - Utility routes: `app_feature_flags.py`, `app_i18n_checker.py`, `app_report_numbers.py`
- `src/models/`: SQLAlchemy ORM models (3 main model files)
  - `exchange_models.py`: Core models (Branch, Currency, ExchangeTransaction, Operator, Role, Permission, etc.)
  - `denomination_models.py`: Denomination/rate publishing models
  - `report_models.py`: Reporting and compliance models
- `src/services/`: Business logic layer (38+ service files)
  - `db_service.py`: Database connection and session management
  - `auth_service.py`: JWT authentication, token validation, permissions
  - PDF generators: `pdf_service.py`, `*_pdf_generator.py` (exchange, reversal, balance, EOD reports, etc.)
  - `balance_service.py`: Currency balance tracking
  - `eod_step_service.py`, `eod_service.py`: End-of-day process orchestration
  - `log_service.py`, `multilingual_log_service.py`, `unified_log_service.py`: Logging with i18n
  - BOT/AMLO services: `bot_*.py`, `amlo_trigger_service.py`
- `src/migrations/`: Database migration scripts
- `src/utils/`: Helper utilities (safe_error_handler.py, safe_log_handler.py, permissions.py, etc.)
- `src/config/`: Configuration files (log_config.py, features.py, environment.py)
- `src/data/`: Static data (ISO countries, currency templates)

**Key Backend Patterns:**
1. **Blueprint Registration**: All routes are Flask blueprints registered in `src/main.py`
2. **Database Sessions**: Use `DatabaseService.get_session()` context managers for all DB operations
3. **Authentication**: `@token_required` decorator from `auth_service.py`
4. **Permissions**: `@has_permission('permission_name')` decorator for authorization
5. **Error Handling**: Use `safe_error_response()` from `utils/safe_error_handler.py`

### Frontend Structure

**Core Directories:**
- `src/views/`: Vue page components (40+ views)
  - App* views: Mobile-optimized views for "App" role users (teller operations)
  - Standard views: Desktop-optimized views for "System" role users (management)
  - Major views: `ExchangeView.vue`, `DualDirectionExchangeView.vue`, `DashboardView.vue`
  - Query views: `*QueryView.vue` for transaction, balance, stock queries
  - Compliance views: `amlo/`, `bot/` subdirectories
- `src/components/`: Reusable Vue components
  - `eod/`: End-of-day workflow components (8 steps)
  - `amlo/`: AMLO compliance form components with `DynamicForm/` subdirectory
  - `PrintSettings/`: Receipt customization components
  - `exchange/`, `standards/`: Feature-specific components
- `src/router/`: Vue Router configuration (`index.js`)
- `src/stores/`: Pinia stores for state management
- `src/services/api/`: API service modules (typed wrappers for backend endpoints)
  - Examples: `authService.js`, `transactionService.js`, `amloService.js`, `botService.js`
- `src/i18n/`: Internationalization files
  - Modular structure: `modules/{feature}/{locale}.js`
  - Supported: `en-US`, `zh-CN`, `th-TH`
  - Features: exchange, menu, transaction, amlo, bot, customer_history, reservation, standards, system_maintenance
- `src/utils/`: Frontend utilities (permissions.js, validation helpers, formatters)
- `src/static/`: Static assets including country flags, help files, and build output

**Key Frontend Patterns:**
1. **Dual Role System**:
   - **App Role** (`/app/*` routes): Mobile-optimized UI for tellers/cashiers
     - Simplified navigation, large touch-friendly buttons
     - Primary functions: Exchange transactions, balance queries
     - Views: `src/views/App*.vue` files
   - **System Role** (`/system/*` routes): Desktop UI for managers/admins
     - Full feature access: reports, settings, user management
     - Complex data tables, charts, multi-step workflows
     - Views: Standard `src/views/*.vue` files
   - Role assignment: Set in `operators` table, enforced by router guards
2. **API Services**: Centralized in `src/services/api/*Service.js` (e.g., `authService.js`, `transactionService.js`)
3. **I18n**: Use `$t('module.key')` for translations (e.g., `$t('transaction.buy')`)
4. **Permission Checking**: `hasPermission(permission)` util from `src/utils/permissions.js`

## Key Business Logic

### Transaction Flow
1. User selects currencies and enters amount
2. System calculates exchange using current rates from `exchange_rates` table
3. Transaction is validated against balance limits and purpose limits
4. Transaction is recorded in `exchange_transactions` table
5. Currency balances are updated in `currency_balances` table
6. PDF receipt is generated via `pdf_service.py`
7. System logs are created via `log_service.py`

### End-of-Day (EOD) Process
The EOD workflow is an 8-step process managed by `eod_step_service.py`:

1. **Start**: Initialize EOD session, lock the branch
2. **Balance Input**: Tellers enter physical currency counts
3. **Calculate**: System compares physical vs. system balances
4. **Verify**: Review differences and approve/reject
5. **Result**: Generate difference report
6. **Cash Out**: Record cash deposits/withdrawals
7. **Report**: Generate comprehensive EOD PDF report
8. **Complete**: Finalize EOD, unlock branch

**Critical**: EOD creates a session lock to prevent concurrent operations. See `src/utils/cleanup_eod_session.py` for emergency unlock.

### AMLO/BOT Compliance
- **AMLO**: Anti-Money Laundering Office compliance forms with dynamic form generation
- **BOT**: Bank of Thailand reporting system with Excel/template-based report generation
- Dynamic form generation based on `amlo_101_corrected_layout.json`
- Components in `src/components/amlo/DynamicForm/`
- Forms are versioned and auditable
- Routes: `src/routes/app_amlo.py`, `app_bot.py`, `app_compliance.py`, `app_repform.py`
- BOT Services:
  - `bot_report_service.py`: Core BOT reporting logic
  - `bot_excel_service.py`: Excel generation for BOT reports
  - `bot_template_based_generator.py`, `bot_template_generator_v3.py`: Template-based generators
  - `bot_trigger_service.py`: Automatic BOT report triggering based on transaction rules
  - `amlo_trigger_service.py`: AMLO form triggering logic

### PDF Generation
Multiple PDF generation systems exist for different purposes (all in `src/services/`):

**Architecture:**
- **Base Layer**: `pdf_service.py` (ReportLab wrapper with multilingual support)
- **Layout System**: `html_pdf_service.py` (HTML-to-PDF using layout definitions from `src/data/`)
- **Configuration**: Per-branch `PrintSettings` model stores receipt customization

**Transaction Receipts** (stored in `src/receipts/YYYY/MM/`):
1. `exchange_pdf_generator.py`: Standard single-direction exchange receipts
2. `dual_direction_pdf_generator.py`: Dual-direction (buy+sell) exchange receipts
3. `thermal_exchange_pdf_generator.py`: Thermal printer format (58mm/80mm width)
4. `reversal_pdf_generator.py`: Transaction reversal/cancellation receipts
5. `html_pdf_service.py`: Modern HTML-based receipts with flexible layouts

**EOD Reports** (stored in `src/manager/YYYY/MM/`):
1. `eod_report_pdf_generator.py`: Comprehensive end-of-day reports
2. `balance_pdf_generator.py`: Currency balance summaries
3. `difference_report_service.py`: Physical vs system balance differences
4. `summary_pdf_generator.py`: Aggregated reports

**Compliance Reports**:
1. `bot_excel_service.py`: BOT Excel reports
2. `bot_template_based_generator.py`: Template-driven BOT reports
3. `bot_template_generator_v3.py`: Latest BOT template generator
4. Font support: Thai fonts in `src/fonts/Sarabun-*.ttf` for multilingual PDFs

**Testing PDFs:**
- Test scripts in `src/services/pdf/test_pdf_generator.py`
- Debug endpoint: `POST /api/exchange/transactions/{id}/print-receipt`
- Debug page: `http://localhost:5001/debug_print_receipt.html`

## Database Models

**Core Tables:**
- `branches`: Branch/location information
- `currencies`: Currency master data (USD, THB, EUR, etc.)
- `exchange_rates`: Daily exchange rates per branch/currency
- `exchange_transactions`: All exchange transactions
- `currency_balances`: Current balance per currency/branch
- `operators`: User accounts
- `roles` / `permissions` / `role_permissions`: RBAC system
- `system_logs`: Audit trail with multilingual support
- `eod_sessions`: End-of-day session tracking
- `print_settings`: Per-branch receipt customization

**Relationships:**
- Branches have many: operators, transactions, rates, balances
- Transactions belong to: branch, operator, currencies (buy/sell)
- EOD sessions contain: balance snapshots, cash operations, difference reports

## Multi-Language Support

The system supports 3 languages with a modular i18n structure:
- **Locales**: `en-US`, `zh-CN`, `th-TH`
- **Frontend**: Vue I18n with modules in `src/i18n/modules/`
- **Backend**: Multilingual logging via `multilingual_log_service.py`

**Important Scripts:**
- `scripts/i18n_fix_missing_keys.js`: Fix missing translation keys
- `scripts/verify_translations.js`: Validate translation completeness
- `src/utils/i18n_checker.py`: Backend translation checker

## Testing & Debugging

**Test Structure:**
- **Frontend**: Jest with Vue Test Utils (`tests/unit/`)
  - Config: `jest.config.js`
  - Setup: `tests/setup.js`
  - Run: `npm test`
- **Backend**: Pytest (`tests/backend/`)
  - Config: `pytest.ini`
  - Test markers: `unit`, `integration`, `slow`, `amlo`, `bot`, `routes`, `services`
  - Run: `pytest` or `pytest -m <marker>`

**Debug Pages:**
- Main entry: `http://localhost:5001` (shows system status page)
- Print receipt debug: `http://localhost:5001/debug_print_receipt.html` (embedded in `src/main.py:146-499`)
- Route inspector: `http://localhost:5001/debug/routes` (lists all registered endpoints)
- Health check: `http://localhost:5001/health`
- Test authentication: Default admin credentials `admin` / `admin123`

**Frontend Debug:**
- Token check page: `frontend_token_check.html` (in project root)
- Check permissions: `http://localhost:5001/check_permissions.html`

**Data Validation:**
```bash
# Check database integrity
python check_data.py
python db_check.py
python comprehensive_check.py

# Check specific systems
python src/check_compliance_status.py          # Compliance data
python src/check_trigger_conditions.py         # AMLO trigger rules
python src/check_country_data.py              # Country/currency data
```

**Log Management:**
- Logs in: Project root (configured via `LogConfig`)
- Switch modes: `python src/switch_log_mode.py`
- Cleanup: `src/scripts/log_cleanup.py`

## File & Directory Organization

**Generated/Runtime Files** (not in git, auto-created):
- `src/receipts/YYYY/MM/*.pdf`: Transaction receipts organized by date
- `src/manager/YYYY/MM/*.pdf`: EOD manager reports organized by date
- `src/exports/`: Temporary export files
- `.env.local`: Auto-generated frontend environment (by `setup_environment.py`)
- `environment_config.json`: Network configuration (auto-detected)
- Log files: `*.log`, `*.log.*` in project root

**Static Assets Routing:**
- `/flags/*` → `src/public/flags/` or `public/flags/` (country flags, served by Flask)
- `/images/*` → `src/public/images/` or `public/images/` (served by Flask)
- `/help/*` → `src/help/` (PDF help documents, served by Flask)
- `/static/*` → Proxied to backend during dev, served from `src/static/dist_frontend/` in production

**Important Configuration Files:**
- `.env`: Backend environment (DB credentials, log mode) - **contains sensitive data**
- `environment_config.json`: Network settings (auto-generated)
- `vue.config.js`: Frontend dev server and proxy configuration
- `pytest.ini`: Backend test configuration
- `jest.config.js`: Frontend test configuration
- `src/config/log_config.py`: Logging behavior
- `src/config/features.py`: Feature flags
- `src/data/`: Static data (countries, currency templates, PDF layouts)

**Naming Conventions:**
- Routes: `src/routes/app_*.py` (e.g., `app_exchange.py`, `app_amlo.py`)
- Services: `src/services/*_service.py` (e.g., `auth_service.py`, `eod_service.py`)
- API Services: `src/services/api/*Service.js` (e.g., `authService.js`)
- Models: `src/models/*_models.py` (e.g., `exchange_models.py`)
- Views: `src/views/*View.vue` (e.g., `ExchangeView.vue`)
- Components: Organized by feature in `src/components/{feature}/`

## Common Workflows

### Adding a New Currency
1. Add to `currencies` table via UI or migration
2. Update `currency_templates` if using denomination tracking
3. Initialize exchange rates in `exchange_rates`
4. Add translations to i18n files

### Creating a New Route
1. Create blueprint in `src/routes/app_*.py`
2. Import and register in `src/main.py`
3. Add frontend route in `src/router/index.js`
4. Create view component in `src/views/`
5. Add API service method in `src/services/api/`

### Modifying Print Receipts
1. Edit layout in `PrintSettings` via UI
2. Or modify templates in `pdf_service.py` or `html_pdf_service.py`
3. Test with `src/services/pdf/test_pdf_generator.py` scripts

## Critical Files

- **Backend Entry**: `src/main.py`
- **Frontend Entry**: `src/main.js` (Vue app initialization)
- **Router**: `src/router/index.js`
- **DB Models**: `src/models/exchange_models.py`
- **Auth**: `src/services/auth_service.py`
- **Config**: `.env`, `environment_config.json`, `config.js`

## Task Scheduling & Background Jobs

**APScheduler Integration:**
- Initialized in `src/main.py` at startup (lines 949-956)
- Task definitions: `src/tasks/scheduler.py`
- **Automated Jobs**:
  - EOD session cleanup: Runs hourly to remove orphaned sessions
  - More tasks can be added via scheduler API

**Manual Cleanup Commands:**
```bash
# Clean up stuck EOD sessions
python src/utils/cleanup_eod_session.py
# or
python src/scripts/cleanup_stuck_eod.py
```

## Known Issues & Maintenance

- **Windows File Locking**: The logging system uses `create_safe_file_handler` from `src/utils/safe_log_handler.py` to avoid Windows file lock issues (see `src/main.py:82-103`)
- **EOD Session Locks**: If EOD gets stuck, use cleanup scripts above or wait for hourly auto-cleanup
- **Migration Order**: Always check dependency order in `src/migrations/migrate.py`
- **CORS Configuration**:
  - Managed by `src/config/environment.py` with auto-detection
  - Regex patterns in `environment_config.json` support dynamic ports
  - Hardcoded fallback IPs in `environment.py:73-79` - update for production
- **Network IP Changes**: Re-run `setup_environment.py` after network changes or deployment
- **Database Credentials**: Never commit `.env` with production passwords to version control

## Important Development Patterns

### Working with Database Sessions
**Always use context managers for database operations:**
```python
from services.db_service import DatabaseService

# Correct pattern
with DatabaseService.get_session() as session:
    result = session.query(Model).filter_by(id=1).first()
    # Session automatically commits and closes

# Avoid: Manual session management (error-prone)
```

### Authentication & Authorization
```python
from services.auth_service import token_required, has_permission

# Require authentication
@app.route('/api/protected')
@token_required
def protected_route():
    return jsonify({"message": "Authenticated"})

# Require specific permission
@app.route('/api/admin')
@token_required
@has_permission('admin_access')
def admin_route():
    return jsonify({"message": "Authorized"})
```

### Error Handling
```python
from utils.safe_error_handler import safe_error_response

# Always use safe error responses to avoid leaking internal details
try:
    result = perform_operation()
except Exception as e:
    return safe_error_response(e, "用户友好的错误消息", 500)
```

### Multilingual Logging
```python
from utils.multilingual_log_service import multilingual_logger

# Log with i18n support
multilingual_logger.log_transaction(
    'transaction_created',
    transaction_id=123,
    details={'amount': 1000, 'currency': 'USD'},
    language='zh-CN'  # or 'en-US', 'th-TH'
)
```

### Adding New Routes
1. Create blueprint in `src/routes/app_*.py` with `/api` prefix:
   ```python
   from flask import Blueprint
   bp = Blueprint('feature', __name__, url_prefix='/api/feature')
   ```
2. Register in `src/main.py` (around line 562-602)
3. Add frontend API service in `src/services/api/featureService.js`
4. Add Vue route in `src/router/index.js`

### I18n Key Naming Convention
- Module-based: `module.key` (e.g., `transaction.buy`, `menu.dashboard`)
- Location: `src/i18n/modules/{module}/{locale}.js`
- Backend keys: `src/i18n/backend/{locale}.json`

## Deployment Notes

- Frontend builds to `src/static/dist_frontend/`
- Flask serves frontend static files in production
- Use `gunicorn` for production (included in requirements.txt)
- Database migrations must be run manually on deployment
- Feature flags managed via `src/routes/app_feature_flags.py`
- **Before deployment**: Update `src/config/environment.py` fallback IPs (lines 73-79)
- **After deployment**: Run `python setup_environment.py` to configure network settings
