# ç½‘ç‚¹æ•°æ®å®Œå…¨éš”ç¦»æµ‹è¯•æ–‡æ¡£ (P2-3)
# Branch Data Complete Isolation Testing Documentation

## æµ‹è¯•ç›®çš„ (Testing Objectives)

éªŒè¯ç³»ç»Ÿçš„å¤šç½‘ç‚¹æ•°æ®å®Œå…¨éš”ç¦»åŠŸèƒ½ï¼Œç¡®ä¿ï¼š
1. Branch 1åˆ›å»ºçš„é¢„çº¦ï¼ŒBranch 2çœ‹ä¸åˆ°
2. Branch 1ç”Ÿæˆçš„æŠ¥å‘Šï¼ŒBranch 2çœ‹ä¸åˆ°
3. Branch 1çš„äº¤æ˜“è®°å½•ï¼ŒBranch 2çœ‹ä¸åˆ°
4. è§¦å‘è§„åˆ™æŒ‰ç½‘ç‚¹éš”ç¦»
5. æ‰€æœ‰è®°å½•åŒ…å«æ­£ç¡®çš„branch_id
6. è·¨ç½‘ç‚¹ç›´æ¥è®¿é—®è¢«æ‹’ç»

Verify that the system's multi-branch data isolation is complete, ensuring:
1. Reservations created by Branch 1 are invisible to Branch 2
2. Reports generated by Branch 1 are invisible to Branch 2
3. Transaction records from Branch 1 are invisible to Branch 2
4. Trigger rules are isolated by branch
5. All records contain the correct branch_id
6. Direct cross-branch access is denied

## ä¸šåŠ¡èƒŒæ™¯ (Business Context)

### ä¸ºä»€ä¹ˆéœ€è¦ç½‘ç‚¹éš”ç¦»ï¼Ÿ (Why Branch Isolation?)

åœ¨å¤šç½‘ç‚¹å¤–æ±‡ç®¡ç†ç³»ç»Ÿä¸­ï¼Œ**æ•°æ®éš”ç¦»**æ˜¯å…³é”®çš„å®‰å…¨å’Œåˆè§„è¦æ±‚ï¼š

1. **æ•°æ®å®‰å…¨**: å„ç½‘ç‚¹ä¸åº”çœ‹åˆ°å…¶ä»–ç½‘ç‚¹çš„å®¢æˆ·æ•°æ®
2. **éšç§ä¿æŠ¤**: é˜²æ­¢å®¢æˆ·ä¿¡æ¯è·¨ç½‘ç‚¹æ³„éœ²
3. **åˆè§„è¦æ±‚**: ç¬¦åˆæ•°æ®ä¿æŠ¤æ³•è§„ï¼ˆPDPA, GDPRç­‰ï¼‰
4. **å®¡è®¡è¿½è¸ª**: æ¯æ¡è®°å½•å¿…é¡»æ˜ç¡®å½’å±åˆ°å…·ä½“ç½‘ç‚¹
5. **æƒé™ç®¡ç†**: ç”¨æˆ·åªèƒ½æ“ä½œè‡ªå·±ç½‘ç‚¹çš„æ•°æ®

In a multi-branch foreign exchange management system, **data isolation** is a critical security and compliance requirement:

1. **Data Security**: Each branch should not see other branches' customer data
2. **Privacy Protection**: Prevent customer information leakage across branches
3. **Compliance Requirements**: Comply with data protection regulations (PDPA, GDPR, etc.)
4. **Audit Trail**: Every record must be clearly attributed to a specific branch
5. **Permission Management**: Users can only operate on their own branch's data

### éš”ç¦»çº§åˆ« (Isolation Levels)

| æ•°æ®ç±»å‹ | éš”ç¦»æ–¹å¼ | éªŒè¯æ–¹æ³• |
|---------|---------|---------|
| é¢„çº¦è®°å½• (Reservations) | branch_idè¿‡æ»¤ | è·¨ç½‘ç‚¹æŸ¥è¯¢è¿”å›ç©º |
| AMLOæŠ¥å‘Š (Reports) | branch_idè¿‡æ»¤ | è·¨ç½‘ç‚¹æŸ¥è¯¢è¿”å›ç©º |
| äº¤æ˜“è®°å½• (Transactions) | branch_idè¿‡æ»¤ | è·¨ç½‘ç‚¹æŸ¥è¯¢è¿”å›ç©º |
| BOTæŠ¥å‘Š (BOT Reports) | branch_idè¿‡æ»¤ | è·¨ç½‘ç‚¹æŸ¥è¯¢è¿”å›ç©º |
| è§¦å‘è§„åˆ™ (Trigger Rules) | branch_idæˆ–NULL | NULL=å…¨å±€è§„åˆ™ |

## è¿è¡Œæµ‹è¯• (Running Tests)

### å¿«é€Ÿå¼€å§‹ (Quick Start)

```bash
# 1. å¯åŠ¨åç«¯æœåŠ¡
python src/main.py

# 2. è¿è¡Œç½‘ç‚¹éš”ç¦»æµ‹è¯•
cd D:\code\exchangenew
python src/tests/test_branch_isolation.py
```

### å‰ç½®æ¡ä»¶ (Prerequisites)

1. **åç«¯æœåŠ¡è¿è¡Œ**: `http://localhost:5001`
2. **æ•°æ®åº“å·²åˆå§‹åŒ–**: `python src/init_db.py`
3. **Branch 1ç”¨æˆ·**: admin/admin123
4. **Branch 2ç”¨æˆ·**:
   - å¦‚æœä¸å­˜åœ¨ï¼Œæµ‹è¯•ä¼šè‡ªåŠ¨åˆ›å»º
   - æˆ–æ‰‹åŠ¨åˆ›å»º: login_code=branch2_user, password=branch2_pass, branch_id=2

### æ‰‹åŠ¨åˆ›å»ºBranch 2ç”¨æˆ· (Manual Branch 2 User Creation)

å¦‚æœæµ‹è¯•æ— æ³•è‡ªåŠ¨åˆ›å»ºBranch 2ç”¨æˆ·ï¼Œå¯ä»¥æ‰‹åŠ¨åˆ›å»ºï¼š

```sql
-- 1. åˆ›å»ºBranch 2ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
INSERT INTO branches (name, code, address, contact_person, phone_number, status)
VALUES ('Branch 2', 'BR002', 'Test Branch 2 Address', 'Manager 2', '1234567890', 'active');

-- 2. åˆ›å»ºBranch 2ç”¨æˆ·
INSERT INTO operators (login_code, password_hash, name, branch_id, role_id, status)
VALUES (
  'branch2_user',
  -- éœ€è¦ç”¨bcryptåŠ å¯†å¯†ç : branch2_pass
  '$2b$12$...',  -- æ›¿æ¢ä¸ºå®é™…åŠ å¯†åçš„å¯†ç 
  'Branch 2 Test User',
  2,
  2,  -- é»˜è®¤è§’è‰²ID
  'active'
);
```

æˆ–ä½¿ç”¨APIåˆ›å»ºï¼š
```bash
POST /api/user-management/operators
Authorization: Bearer {admin_token}
{
  "login_code": "branch2_user",
  "password": "branch2_pass",
  "name": "Branch 2 Test User",
  "branch_id": 2,
  "role_id": 2,
  "status": "active"
}
```

## æµ‹è¯•åœºæ™¯è¯¦è§£ (Test Scenarios Explained)

---

### Test 1: é¢„çº¦æ•°æ®éš”ç¦» (Reservation Data Isolation)

**æµ‹è¯•ç›®çš„**: éªŒè¯Branch 1åˆ›å»ºçš„é¢„çº¦ï¼ŒBranch 2å®Œå…¨çœ‹ä¸åˆ°

**æµ‹è¯•æ­¥éª¤**:

#### Step 1.1: Branch 1åˆ›å»ºé¢„çº¦
```bash
POST /api/amlo/reservations
Authorization: Bearer {branch1_token}
{
  "customer_id": "BRANCH1_TEST_001",
  "customer_name": "Branch 1 Test Customer",
  "currency_code": "USD",
  "direction": "buy",
  "amount": 70000,
  "local_amount": 2380000,
  "report_type": "AMLO-1-01"
}
```

**é¢„æœŸ**:
- è¿”å›201 Created
- å“åº”åŒ…å«reservation_id
- è®°å½•çš„branch_id = 1

#### Step 1.2: Branch 1æŸ¥è¯¢è‡ªå·±çš„é¢„çº¦
```bash
GET /api/amlo/reservations?customer_id=BRANCH1_TEST_001
Authorization: Bearer {branch1_token}
```

**é¢„æœŸ**:
- âœ… è¿”å›200 OK
- âœ… itemsæ•°ç»„åŒ…å«åˆšåˆ›å»ºçš„é¢„çº¦
- âœ… é¢„çº¦çš„branch_id = 1

#### Step 1.3: Branch 2å°è¯•æŸ¥è¯¢
```bash
GET /api/amlo/reservations?customer_id=BRANCH1_TEST_001
Authorization: Bearer {branch2_token}
```

**é¢„æœŸï¼ˆéš”ç¦»æˆåŠŸï¼‰**:
- âœ… è¿”å›200 OKä½†itemsä¸ºç©ºæ•°ç»„ `[]`
- æˆ–è¿”å›403 Forbiddenï¼ˆæƒé™é™åˆ¶ï¼‰
- **å…³é”®**: Branch 2çœ‹ä¸åˆ°Branch 1çš„é¢„çº¦

**é¢„æœŸï¼ˆéš”ç¦»å¤±è´¥ï¼‰**:
- âŒ itemsæ•°ç»„åŒ…å«Branch 1çš„é¢„çº¦
- è¿™è¡¨ç¤ºéš”ç¦»æœºåˆ¶è¢«ç ´å

**æ•°æ®åº“å±‚éªŒè¯**:
```sql
-- Branch 1çš„é¢„çº¦åº”è¯¥åªæœ‰branch_id=1
SELECT id, customer_id, branch_id
FROM Reserved_Transaction
WHERE customer_id = 'BRANCH1_TEST_001';

-- ç»“æœåº”è¯¥æ˜¯:
-- id | customer_id       | branch_id
-- 123| BRANCH1_TEST_001  | 1
```

---

### Test 2: æŠ¥å‘Šæ•°æ®éš”ç¦» (Report Data Isolation)

**æµ‹è¯•ç›®çš„**: éªŒè¯Branch 1ç”Ÿæˆçš„AMLOæŠ¥å‘Šï¼ŒBranch 2å®Œå…¨çœ‹ä¸åˆ°

**æµ‹è¯•æ­¥éª¤**:

#### Step 2.1: Branch 1åˆ›å»ºé¢„çº¦å¹¶å®Œæˆäº¤æ˜“ï¼ˆç”ŸæˆæŠ¥å‘Šï¼‰
```bash
# 1. åˆ›å»ºé¢„çº¦
POST /api/amlo/reservations
Authorization: Bearer {branch1_token}
{
  "customer_id": "BRANCH1_REPORT_TEST",
  ...
}

# 2. å®¡æ ¸é€šè¿‡
POST /api/amlo/reservations/{id}/audit
{
  "action": "approve"
}

# 3. æ‰§è¡Œäº¤æ˜“
POST /api/exchange/transactions
{
  "customer_id": "BRANCH1_REPORT_TEST",
  "reservation_id": {reservation_id},
  ...
}
```

**é¢„æœŸ**: AMLOæŠ¥å‘Šè‡ªåŠ¨ç”Ÿæˆï¼Œbranch_id = 1

#### Step 2.2: Branch 1æŸ¥è¯¢AMLOæŠ¥å‘Š
```bash
GET /api/amlo/reports
Authorization: Bearer {branch1_token}
```

**é¢„æœŸ**:
- âœ… èƒ½çœ‹åˆ°customer_id='BRANCH1_REPORT_TEST'çš„æŠ¥å‘Š
- âœ… æŠ¥å‘Šçš„branch_id = 1

#### Step 2.3: Branch 2æŸ¥è¯¢AMLOæŠ¥å‘Š
```bash
GET /api/amlo/reports
Authorization: Bearer {branch2_token}
```

**é¢„æœŸï¼ˆéš”ç¦»æˆåŠŸï¼‰**:
- âœ… æŸ¥è¯¢ç»“æœä¸­**ä¸åŒ…å«**'BRANCH1_REPORT_TEST'çš„æŠ¥å‘Š
- Branch 2åªèƒ½çœ‹åˆ°è‡ªå·±ç½‘ç‚¹çš„æŠ¥å‘Š

**æ•°æ®åº“å±‚éªŒè¯**:
```sql
-- éªŒè¯AMLOæŠ¥å‘Šçš„branch_id
SELECT id, customer_id, branch_id, is_reported
FROM AMLOReport
WHERE customer_id = 'BRANCH1_REPORT_TEST';

-- ç»“æœåº”è¯¥æ˜¯:
-- id | customer_id          | branch_id | is_reported
-- 456| BRANCH1_REPORT_TEST  | 1         | false
```

---

### Test 3: äº¤æ˜“æ•°æ®éš”ç¦» (Transaction Data Isolation)

**æµ‹è¯•ç›®çš„**: éªŒè¯Branch 1çš„äº¤æ˜“è®°å½•ï¼ŒBranch 2å®Œå…¨çœ‹ä¸åˆ°

**æµ‹è¯•æ­¥éª¤**:

#### Step 3.1: Branch 1åˆ›å»ºäº¤æ˜“
```bash
POST /api/exchange/transactions
Authorization: Bearer {branch1_token}
{
  "customer_id": "BRANCH1_TRANS_001",
  "exchange_mode": "buy_foreign",
  "amount_type": "want",
  "target_amount": 5000,
  ...
}
```

**é¢„æœŸ**: äº¤æ˜“åˆ›å»ºæˆåŠŸï¼Œbranch_id = 1

#### Step 3.2: Branch 1æŸ¥è¯¢è‡ªå·±çš„äº¤æ˜“
```bash
GET /api/query-transactions/all?customer_id=BRANCH1_TRANS_001
Authorization: Bearer {branch1_token}
```

**é¢„æœŸ**:
- âœ… èƒ½æŸ¥è¯¢åˆ°customer_id='BRANCH1_TRANS_001'çš„äº¤æ˜“
- âœ… transaction.branch_id = 1

#### Step 3.3: Branch 2å°è¯•æŸ¥è¯¢
```bash
GET /api/query-transactions/all?customer_id=BRANCH1_TRANS_001
Authorization: Bearer {branch2_token}
```

**é¢„æœŸï¼ˆéš”ç¦»æˆåŠŸï¼‰**:
- âœ… æŸ¥è¯¢ç»“æœä¸ºç©ºæˆ–ä¸åŒ…å«Branch 1çš„äº¤æ˜“
- Branch 2çœ‹ä¸åˆ°Branch 1çš„äº¤æ˜“è®°å½•

**æ•°æ®åº“å±‚éªŒè¯**:
```sql
-- éªŒè¯äº¤æ˜“çš„branch_id
SELECT id, customer_id, branch_id, transaction_no
FROM exchange_transactions
WHERE customer_id = 'BRANCH1_TRANS_001';

-- ç»“æœåº”è¯¥æ˜¯:
-- id  | customer_id        | branch_id | transaction_no
-- 789 | BRANCH1_TRANS_001  | 1         | A00520251013...
```

---

### Test 4: è§¦å‘è§„åˆ™ç½‘ç‚¹éš”ç¦» (Trigger Rule Branch Isolation)

**æµ‹è¯•ç›®çš„**: éªŒè¯è§¦å‘è§„åˆ™æ˜¯å¦æ”¯æŒç½‘ç‚¹çº§åˆ«éš”ç¦»

**è§„åˆ™ç±»å‹**:
1. **å…¨å±€è§„åˆ™** (branch_id = NULL): é€‚ç”¨äºæ‰€æœ‰ç½‘ç‚¹
2. **ç½‘ç‚¹ç‰¹å®šè§„åˆ™** (branch_id = 1, 2, ...): ä»…é€‚ç”¨äºæŒ‡å®šç½‘ç‚¹

**æµ‹è¯•æ­¥éª¤**:

#### Step 4.1: æŸ¥è¯¢è§¦å‘è§„åˆ™é…ç½®
```bash
GET /api/compliance/trigger-rules
Authorization: Bearer {admin_token}
```

**é¢„æœŸå“åº”ç»“æ„**:
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "report_type": "AMLO-1-01",
      "branch_id": null,  // å…¨å±€è§„åˆ™
      "trigger_field": "local_amount",
      "threshold_value": 2000000,
      "is_active": true
    },
    {
      "id": 2,
      "report_type": "BOT_BuyFX",
      "branch_id": 1,  // Branch 1ä¸“ç”¨è§„åˆ™
      "trigger_field": "usd_equivalent",
      "threshold_value": 20000,
      "is_active": true
    },
    {
      "id": 3,
      "report_type": "BOT_BuyFX",
      "branch_id": 2,  // Branch 2ä¸“ç”¨è§„åˆ™ï¼Œé˜ˆå€¼å¯èƒ½ä¸åŒ
      "trigger_field": "usd_equivalent",
      "threshold_value": 25000,
      "is_active": true
    }
  ]
}
```

**éªŒè¯ç‚¹**:
- âœ… å…¨å±€è§„åˆ™ (branch_id=NULL) å­˜åœ¨
- âœ… æ”¯æŒç½‘ç‚¹ç‰¹å®šè§„åˆ™ (branch_id=1, 2, ...)
- âœ… ç›¸åŒç±»å‹çš„è§„åˆ™å¯ä»¥ä¸ºä¸åŒç½‘ç‚¹è®¾ç½®ä¸åŒé˜ˆå€¼

**ä¸šåŠ¡åœºæ™¯**:
```
ç¤ºä¾‹: ä¸åŒç½‘ç‚¹çš„BOTæŠ¥å‘Šé˜ˆå€¼å¯èƒ½ä¸åŒ

Branch 1 (ä¸»è¦ç½‘ç‚¹):
- BOT_BuyFXé˜ˆå€¼: 20,000 USD
- åŸå› : ä¸šåŠ¡é‡å¤§ï¼Œæ ‡å‡†é˜ˆå€¼

Branch 2 (å°å‹ç½‘ç‚¹):
- BOT_BuyFXé˜ˆå€¼: 25,000 USD
- åŸå› : ä¸šåŠ¡é‡å°ï¼Œæé«˜é˜ˆå€¼å‡å°‘æŠ¥å‘Šæ•°é‡
```

**æ•°æ®åº“ç»“æ„**:
```sql
CREATE TABLE trigger_rules (
    id INT PRIMARY KEY,
    report_type VARCHAR(50),
    branch_id INT NULL,  -- NULLè¡¨ç¤ºå…¨å±€è§„åˆ™
    trigger_field VARCHAR(100),
    threshold_value DECIMAL(15,2),
    is_active BOOLEAN,
    FOREIGN KEY (branch_id) REFERENCES branches(id)
);
```

---

### Test 5: æ‰€æœ‰è®°å½•branch_idæ­£ç¡®æ€§ (Branch ID Correctness)

**æµ‹è¯•ç›®çš„**: éªŒè¯æ‰€æœ‰åˆ›å»ºçš„è®°å½•éƒ½æ­£ç¡®è®°å½•äº†branch_id

**æµ‹è¯•å†…å®¹**:

#### 5.1 é¢„çº¦è®°å½• (Reserved_Transaction)
```sql
SELECT id, customer_id, branch_id, created_by
FROM Reserved_Transaction
WHERE customer_id LIKE 'BRANCH1_%';

-- éªŒè¯ç‚¹:
-- 1. branch_id = 1 (ä¸åˆ›å»ºç”¨æˆ·çš„branchä¸€è‡´)
-- 2. created_by = Branch 1ç”¨æˆ·çš„operator_id
```

#### 5.2 äº¤æ˜“è®°å½• (exchange_transactions)
```sql
SELECT id, customer_id, branch_id, operator_id
FROM exchange_transactions
WHERE customer_id LIKE 'BRANCH1_%';

-- éªŒè¯ç‚¹:
-- 1. branch_id = 1
-- 2. operator_id = Branch 1ç”¨æˆ·çš„operator_id
```

#### 5.3 AMLOæŠ¥å‘Š (AMLOReport)
```sql
SELECT id, customer_id, branch_id, transaction_id
FROM AMLOReport
WHERE customer_id LIKE 'BRANCH1_%';

-- éªŒè¯ç‚¹:
-- 1. branch_id = 1
-- 2. transaction_idå…³è”çš„äº¤æ˜“ä¹Ÿæ˜¯branch_id=1
```

#### 5.4 BOTæŠ¥å‘Š (BOT_BuyFX, BOT_SellFXç­‰)
```sql
SELECT id, transaction_id, branch_id, customer_id
FROM BOT_BuyFX
WHERE customer_id LIKE 'BRANCH1_%';

-- éªŒè¯ç‚¹:
-- 1. branch_id = 1
-- 2. transaction_idå…³è”çš„äº¤æ˜“ä¹Ÿæ˜¯branch_id=1
```

**å…³é”®åŸåˆ™**:
> **æ‰€æœ‰ä¸ç½‘ç‚¹ç›¸å…³çš„è®°å½•MUSTåŒ…å«branch_idå­—æ®µ**
>
> åˆ›å»ºè®°å½•æ—¶ï¼Œbranch_idåº”è¯¥ä»ä»¥ä¸‹æ¥æºè·å–ï¼š
> 1. å½“å‰ç™»å½•ç”¨æˆ·çš„branch_id (æœ€å¸¸è§)
> 2. çˆ¶è®°å½•çš„branch_id (å¦‚æŠ¥å‘Šç»§æ‰¿äº¤æ˜“çš„branch_id)
> 3. æ˜ç¡®æŒ‡å®šçš„branch_id (ç®¡ç†å‘˜æ“ä½œ)

---

### Test 6: è·¨ç½‘ç‚¹ç›´æ¥è®¿é—®æ‹’ç» (Cross-Branch Access Denied)

**æµ‹è¯•ç›®çš„**: éªŒè¯Branch 2ç›´æ¥é€šè¿‡IDè®¿é—®Branch 1èµ„æºæ—¶è¢«æ‹’ç»

**æµ‹è¯•åœºæ™¯**:

#### 6.1 å°è¯•ç›´æ¥è®¿é—®é¢„çº¦è¯¦æƒ…
```bash
# Branch 2å°è¯•è®¿é—®Branch 1çš„é¢„çº¦
GET /api/amlo/reservations/{branch1_reservation_id}
Authorization: Bearer {branch2_token}
```

**é¢„æœŸï¼ˆæ­£ç¡®è¡Œä¸ºï¼‰**:
- âœ… è¿”å›403 Forbidden
- âœ… æˆ–è¿”å›404 Not Found
- âœ… æˆ–è¿”å›200ä½†dataä¸ºnull/ç©º

**ä¸åº”è¯¥**:
- âŒ è¿”å›200ä¸”åŒ…å«å®Œæ•´çš„é¢„çº¦æ•°æ®

#### 6.2 å°è¯•å®¡æ ¸å…¶ä»–ç½‘ç‚¹çš„é¢„çº¦
```bash
# Branch 2å°è¯•å®¡æ ¸Branch 1çš„é¢„çº¦
POST /api/amlo/reservations/{branch1_reservation_id}/audit
Authorization: Bearer {branch2_token}
{
  "action": "approve"
}
```

**é¢„æœŸï¼ˆæ­£ç¡®è¡Œä¸ºï¼‰**:
- âœ… è¿”å›403 Forbidden
- âœ… é”™è¯¯æ¶ˆæ¯: "æ‚¨æ— æƒæ“ä½œå…¶ä»–ç½‘ç‚¹çš„æ•°æ®"

#### 6.3 å°è¯•ä¿®æ”¹å…¶ä»–ç½‘ç‚¹çš„è®°å½•
```bash
# Branch 2å°è¯•ä¿®æ”¹Branch 1çš„äº¤æ˜“
PUT /api/exchange/transactions/{branch1_transaction_id}
Authorization: Bearer {branch2_token}
{
  "remarks": "Trying to modify another branch's data"
}
```

**é¢„æœŸï¼ˆæ­£ç¡®è¡Œä¸ºï¼‰**:
- âœ… è¿”å›403 Forbidden
- âœ… æ‹’ç»ä»»ä½•ä¿®æ”¹æ“ä½œ

**åç«¯å®ç°æ£€æŸ¥ç‚¹**:
```python
# åœ¨æ‰€æœ‰æ¶‰åŠbranch_idçš„APIä¸­ï¼Œåº”è¯¥æœ‰è¿™æ ·çš„æ£€æŸ¥
def get_reservation(reservation_id):
    reservation = db.query(Reservation).filter_by(id=reservation_id).first()

    if not reservation:
        return 404, "é¢„çº¦ä¸å­˜åœ¨"

    # å…³é”®: æ£€æŸ¥branch_id
    if reservation.branch_id != current_user.branch_id:
        return 403, "æ‚¨æ— æƒè®¿é—®å…¶ä»–ç½‘ç‚¹çš„æ•°æ®"

    return 200, reservation
```

---

## é¢„æœŸæµ‹è¯•è¾“å‡º (Expected Output)

### æˆåŠŸè¿è¡Œç¤ºä¾‹ (Successful Run)

```
================================================================================
Branch Data Complete Isolation Tests (P2-3)
ç½‘ç‚¹æ•°æ®å®Œå…¨éš”ç¦»æµ‹è¯•
Time: 2025-10-13 17:00:00
================================================================================

[Setup] Branch 1 Login...
  [OK] Branch 1 login successful (Branch ID: 1)

[Setup] Branch 2 Login...
  [OK] Branch 2 login successful (Branch ID: 2)

[Setup] Setting up test data...
  [OK] Test data ready (USD ID: 2)

================================================================================
Test 1: Reservation Data Isolation
æµ‹è¯•1: é¢„çº¦æ•°æ®éš”ç¦»
================================================================================

[Test 1.1] Branch 1 creates reservation...
  [OK] Branch 1 created reservation ID: 123
  Branch ID in record: 1

[Test 1.2] Branch 1 queries own reservations...
  [OK] Branch 1 CAN see its own reservation (expected)

[Test 1.3] Branch 2 queries reservations (should NOT see Branch 1 data)...
  [PASS] âœ“ Branch 2 CANNOT see Branch 1's reservation (isolation working!)
    Branch 2 sees 0 reservations (none from Branch 1)

================================================================================
Test 2: Report Data Isolation
æµ‹è¯•2: æŠ¥å‘Šæ•°æ®éš”ç¦»
================================================================================

[Test 2.1] Branch 1 creates and completes reservation to generate report...
  [OK] Branch 1 created transaction ID: 456

[Test 2.2] Branch 1 queries AMLO reports...
  [OK] Branch 1 found its report ID: 789
  Branch ID in report: 1

[Test 2.3] Branch 2 queries AMLO reports (should NOT see Branch 1 data)...
  [PASS] âœ“ Branch 2 CANNOT see Branch 1's reports (isolation working!)
    Branch 2 sees 0 reports (none from Branch 1)

================================================================================
Test 3: Transaction Data Isolation
æµ‹è¯•3: äº¤æ˜“æ•°æ®éš”ç¦»
================================================================================

[Test 3.1] Branch 1 creates transaction...
  [OK] Branch 1 created transaction ID: 999
  Branch ID in transaction: 1

[Test 3.2] Branch 1 queries own transactions...
  [OK] Branch 1 CAN see its own transaction (expected)

[Test 3.3] Branch 2 queries transactions (should NOT see Branch 1 data)...
  [PASS] âœ“ Branch 2 CANNOT see Branch 1's transactions (isolation working!)
    Branch 2 query returned 0 items (none match Branch 1 transaction)

================================================================================
Test 4: Trigger Rule Branch Isolation
æµ‹è¯•4: è§¦å‘è§„åˆ™ç½‘ç‚¹éš”ç¦»
================================================================================

[Test 4.1] Check trigger rules branch assignment...
  [OK] Found 8 trigger rules
    Global rules (branch_id=NULL): 6
    Branch-specific rules: 2
  [PASS] âœ“ Trigger rules support branch isolation
    Examples of branch-specific rules:
      - BOT_BuyFX (Branch 1)
      - BOT_SellFX (Branch 2)

================================================================================
Test 5: Branch ID Correctness in All Records
æµ‹è¯•5: æ‰€æœ‰è®°å½•branch_idæ­£ç¡®æ€§
================================================================================

[Test 5.1] Check reservation branch_id...
  [OK] Reservation branch_id = 1 (correct)

[Test 5.2] Check transaction branch_id...
  [OK] Transaction branch_id = 1 (correct)

[Test 5.3] Check AMLO report branch_id...
  [OK] Report branch_id = 1 (correct)

[Test 5.4] Summary of branch_id correctness...
  [PASS] âœ“ All records have correct branch_id

================================================================================
Test 6: Cross-Branch Access Denied
æµ‹è¯•6: è·¨ç½‘ç‚¹è®¿é—®æ‹’ç»
================================================================================

[Test 6.1] Branch 2 attempts to access Branch 1 reservation directly...
  [PASS] âœ“ Branch 2 access DENIED (status: 403)
    Cross-branch access properly blocked

================================================================================
Test Results Summary
æµ‹è¯•ç»“æœæ±‡æ€»
================================================================================

ğŸ¢ Branch Data Isolation Tests:
  âœ… PASS - Branch 1 Login
  âœ… PASS - Branch 2 Login
  âœ… PASS - Reservation Data Isolation
  âœ… PASS - Report Data Isolation
  âœ… PASS - Transaction Data Isolation
  âœ… PASS - Trigger Rule Branch Isolation
  âœ… PASS - Branch ID Correctness
  âœ… PASS - Cross-Branch Access Denied

ğŸ“ˆ Statistics:
  Total Tests: 8
  Passed: 8 âœ…
  Failed: 0 âŒ
  Pass Rate: 100.0%

================================================================================
âœ… ALL BRANCH ISOLATION TESTS PASSED!
æ‰€æœ‰ç½‘ç‚¹éš”ç¦»æµ‹è¯•é€šè¿‡!
================================================================================
```

---

## å¸¸è§é—®é¢˜ (Common Issues)

### Q1: Branch 2ç”¨æˆ·ä¸å­˜åœ¨

**ç—‡çŠ¶**:
```
[FAIL] Branch 2 login failed: Invalid credentials
```

**è§£å†³æ–¹æ¡ˆ**:
```sql
-- 1. ç¡®è®¤Branch 2å­˜åœ¨
SELECT * FROM branches WHERE id = 2;

-- 2. å¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»ºBranch 2
INSERT INTO branches (id, name, code, address, status)
VALUES (2, 'Branch 2', 'BR002', 'Test Address', 'active');

-- 3. åˆ›å»ºBranch 2ç”¨æˆ·
INSERT INTO operators (login_code, password_hash, name, branch_id, role_id, status)
VALUES ('branch2_user', '<bcrypt_hash>', 'Branch 2 User', 2, 2, 'active');
```

æˆ–è®©æµ‹è¯•è‡ªåŠ¨åˆ›å»º:
- æµ‹è¯•è„šæœ¬ä¼šå°è¯•ä½¿ç”¨Branch 1ç®¡ç†å‘˜æƒé™åˆ›å»ºBranch 2ç”¨æˆ·
- ç¡®ä¿Branch 1ç”¨æˆ·æœ‰ç”¨æˆ·ç®¡ç†æƒé™

### Q2: Branch 2èƒ½çœ‹åˆ°Branch 1çš„æ•°æ®ï¼ˆéš”ç¦»å¤±è´¥ï¼‰

**ç—‡çŠ¶**:
```
[FAIL] âœ— Branch 2 CAN see Branch 1's reservation (isolation BROKEN!)
```

**å¯èƒ½åŸå› **:
1. **æŸ¥è¯¢SQLæœªåŒ…å«branch_idè¿‡æ»¤**
   ```python
   # é”™è¯¯ç¤ºä¾‹ - æ²¡æœ‰branch_idè¿‡æ»¤
   reservations = db.query(Reservation).all()

   # æ­£ç¡®ç¤ºä¾‹ - æœ‰branch_idè¿‡æ»¤
   reservations = db.query(Reservation).filter_by(
       branch_id=current_user.branch_id
   ).all()
   ```

2. **ä½¿ç”¨äº†å…¨å±€æŸ¥è¯¢æƒé™**
   - æŸäº›ç®¡ç†å‘˜è´¦æˆ·å¯èƒ½æœ‰è·¨ç½‘ç‚¹æŸ¥è¯¢æƒé™
   - æ£€æŸ¥ç”¨æˆ·çš„æƒé™é…ç½®

3. **branch_idæœªæ­£ç¡®è®¾ç½®**
   ```python
   # åˆ›å»ºè®°å½•æ—¶å¿…é¡»è®¾ç½®branch_id
   reservation = Reservation(
       customer_id=data['customer_id'],
       branch_id=current_user.branch_id,  # å…³é”®!
       ...
   )
   ```

**è°ƒè¯•æ­¥éª¤**:
```bash
# 1. æ£€æŸ¥æ•°æ®åº“ä¸­çš„branch_id
SELECT id, customer_id, branch_id FROM Reserved_Transaction;

# 2. æ£€æŸ¥APIè¿”å›çš„branch_id
curl -H "Authorization: Bearer {token}" \
  http://localhost:5001/api/amlo/reservations

# 3. æ£€æŸ¥åç«¯SQLæ—¥å¿—
# ç¡®è®¤WHEREå­å¥åŒ…å«branch_idæ¡ä»¶
```

### Q3: æ‰€æœ‰è®°å½•çš„branch_idéƒ½æ˜¯NULL

**ç—‡çŠ¶**:
```
[FAIL] Reservation branch_id = NULL (expected 1)
```

**åŸå› **: åˆ›å»ºè®°å½•æ—¶æœªè®¾ç½®branch_id

**è§£å†³æ–¹æ¡ˆ**:
```python
# åœ¨æ‰€æœ‰æ•°æ®åˆ›å»ºAPIä¸­æ·»åŠ branch_id
@app.route('/api/amlo/reservations', methods=['POST'])
@token_required
def create_reservation():
    data = request.get_json()

    reservation = Reservation(
        customer_id=data['customer_id'],
        branch_id=g.current_user.branch_id,  # ä»å½“å‰ç”¨æˆ·è·å–
        created_by=g.current_user.id,
        ...
    )

    db.session.add(reservation)
    db.session.commit()
```

### Q4: è·¨ç½‘ç‚¹è®¿é—®æœªè¢«æ‹’ç»

**ç—‡çŠ¶**:
```
[FAIL] âœ— Branch 2 CAN access Branch 1 reservation
```

**åŸå› **: APIæœªæ£€æŸ¥branch_idæƒé™

**è§£å†³æ–¹æ¡ˆ**:
```python
# åœ¨æ‰€æœ‰å•è®°å½•æŸ¥è¯¢APIä¸­æ·»åŠ æƒé™æ£€æŸ¥
@app.route('/api/amlo/reservations/<int:id>', methods=['GET'])
@token_required
def get_reservation(id):
    reservation = Reservation.query.get_or_404(id)

    # å…³é”®: æ£€æŸ¥branchæƒé™
    if reservation.branch_id != g.current_user.branch_id:
        return jsonify({
            'success': False,
            'message': 'æ‚¨æ— æƒè®¿é—®å…¶ä»–ç½‘ç‚¹çš„æ•°æ®'
        }), 403

    return jsonify({
        'success': True,
        'data': reservation.to_dict()
    })
```

### Q5: è§¦å‘è§„åˆ™æœªæŒ‰ç½‘ç‚¹éš”ç¦»

**ç—‡çŠ¶**: æ‰€æœ‰ç½‘ç‚¹ä½¿ç”¨ç›¸åŒçš„è§¦å‘è§„åˆ™ï¼Œæ— æ³•ä¸ªæ€§åŒ–é…ç½®

**è§£å†³æ–¹æ¡ˆ**:
```python
# è§¦å‘è§„åˆ™æŸ¥è¯¢æ—¶æ”¯æŒbranch_id
def get_applicable_rules(report_type, branch_id):
    """è·å–é€‚ç”¨çš„è§¦å‘è§„åˆ™"""
    rules = TriggerRule.query.filter(
        TriggerRule.report_type == report_type,
        TriggerRule.is_active == True,
        # branch_id=NULL(å…¨å±€è§„åˆ™)æˆ–ç­‰äºå½“å‰ç½‘ç‚¹
        or_(
            TriggerRule.branch_id == None,
            TriggerRule.branch_id == branch_id
        )
    ).all()

    # ç½‘ç‚¹ç‰¹å®šè§„åˆ™ä¼˜å…ˆäºå…¨å±€è§„åˆ™
    branch_rules = [r for r in rules if r.branch_id == branch_id]
    global_rules = [r for r in rules if r.branch_id is None]

    return branch_rules if branch_rules else global_rules
```

---

## æ•°æ®åº“è®¾è®¡è¦æ±‚ (Database Design Requirements)

### å…³é”®åŸåˆ™

1. **æ‰€æœ‰ä¸šåŠ¡è¡¨å¿…é¡»åŒ…å«branch_id**
   ```sql
   ALTER TABLE table_name ADD COLUMN branch_id INT NOT NULL;
   ALTER TABLE table_name ADD FOREIGN KEY (branch_id) REFERENCES branches(id);
   ```

2. **ç´¢å¼•ä¼˜åŒ–**
   ```sql
   -- ä¸ºæ‰€æœ‰æŸ¥è¯¢æ·»åŠ branch_idç´¢å¼•
   CREATE INDEX idx_reservations_branch ON Reserved_Transaction(branch_id);
   CREATE INDEX idx_reports_branch ON AMLOReport(branch_id);
   CREATE INDEX idx_transactions_branch ON exchange_transactions(branch_id);
   ```

3. **æ•°æ®åº“è§†å›¾**
   ```sql
   -- å¯ä»¥åˆ›å»ºå½“å‰ç½‘ç‚¹è§†å›¾ç®€åŒ–æŸ¥è¯¢
   CREATE VIEW current_branch_reservations AS
   SELECT * FROM Reserved_Transaction
   WHERE branch_id = @current_branch_id;
   ```

---

## åç«¯å®ç°æ£€æŸ¥æ¸…å• (Backend Implementation Checklist)

### âœ… APIå±‚é¢ (API Layer)

- [ ] æ‰€æœ‰åˆ›å»ºAPIè®¾ç½®æ­£ç¡®çš„branch_id
- [ ] æ‰€æœ‰æŸ¥è¯¢APIè¿‡æ»¤branch_id
- [ ] æ‰€æœ‰å•è®°å½•APIæ£€æŸ¥branchæƒé™
- [ ] æ‰€æœ‰ä¿®æ”¹APIæ£€æŸ¥branchæƒé™
- [ ] æ‰€æœ‰åˆ é™¤APIæ£€æŸ¥branchæƒé™

### âœ… æœåŠ¡å±‚é¢ (Service Layer)

- [ ] æ•°æ®åˆ›å»ºæœåŠ¡è‡ªåŠ¨æ·»åŠ branch_id
- [ ] æŸ¥è¯¢æœåŠ¡é»˜è®¤è¿‡æ»¤branch_id
- [ ] æƒé™æ£€æŸ¥æœåŠ¡éªŒè¯branchæƒé™

### âœ… æ•°æ®åº“å±‚é¢ (Database Layer)

- [ ] æ‰€æœ‰ä¸šåŠ¡è¡¨åŒ…å«branch_idå­—æ®µ
- [ ] branch_idå­—æ®µè®¾ç½®NOT NULLçº¦æŸ
- [ ] branch_idå­—æ®µè®¾ç½®å¤–é”®çº¦æŸ
- [ ] åˆ›å»ºbranch_idç´¢å¼•æé«˜æŸ¥è¯¢æ€§èƒ½

---

## å®‰å…¨æœ€ä½³å®è·µ (Security Best Practices)

### 1. é»˜è®¤æ‹’ç»ç­–ç•¥ (Deny by Default)

```python
# å¦‚æœæ— æ³•ç¡®å®šbranch_idï¼Œæ‹’ç»è®¿é—®
if not reservation.branch_id:
    return 403, "æ•°æ®å¼‚å¸¸: æ— æ³•ç¡®å®šæ‰€å±ç½‘ç‚¹"

if reservation.branch_id != current_user.branch_id:
    return 403, "æƒé™ä¸è¶³"
```

### 2. å®¡è®¡æ—¥å¿— (Audit Logging)

```python
# è®°å½•è·¨ç½‘ç‚¹è®¿é—®å°è¯•
if reservation.branch_id != current_user.branch_id:
    log_security_event(
        event_type='cross_branch_access_attempt',
        user_id=current_user.id,
        branch_id=current_user.branch_id,
        target_branch_id=reservation.branch_id,
        resource_type='reservation',
        resource_id=reservation.id,
        timestamp=datetime.now()
    )
    return 403, "æƒé™ä¸è¶³"
```

### 3. ç®¡ç†å‘˜ä¾‹å¤– (Admin Exception)

```python
# ä»…è¶…çº§ç®¡ç†å‘˜å¯ä»¥è·¨ç½‘ç‚¹æŸ¥è¯¢
def can_access_cross_branch(user):
    return user.role.name == 'super_admin'

# åœ¨æƒé™æ£€æŸ¥ä¸­ä½¿ç”¨
if reservation.branch_id != current_user.branch_id:
    if not can_access_cross_branch(current_user):
        return 403, "æƒé™ä¸è¶³"
```

---

## æµ‹è¯•æ•°æ®æ¸…ç† (Test Data Cleanup)

æµ‹è¯•å®Œæˆåæ¸…ç†æ•°æ®ï¼š

```sql
-- æ¸…ç†Branch 1æµ‹è¯•æ•°æ®
DELETE FROM Reserved_Transaction
WHERE customer_id LIKE 'BRANCH1_%' AND branch_id = 1;

DELETE FROM AMLOReport
WHERE customer_id LIKE 'BRANCH1_%' AND branch_id = 1;

DELETE FROM exchange_transactions
WHERE customer_id LIKE 'BRANCH1_%' AND branch_id = 1;

-- æ¸…ç†Branch 2æµ‹è¯•ç”¨æˆ·ï¼ˆå¯é€‰ï¼‰
DELETE FROM operators
WHERE login_code = 'branch2_user';
```

---

## ç›¸å…³æ–‡æ¡£ (Related Documentation)

- **AMLOå®¡è®¡åŠŸèƒ½æµ‹è¯•**: `README_AMLO_AUDIT_FEATURES.md`
- **BOTæŠ¥å‘Šå®Œæ•´æµ‹è¯•**: `README_ALL_BOT_REPORTS.md`
- **æµ‹è¯•å¥—ä»¶ä¸»æ–‡æ¡£**: `README.md`
- **ç³»ç»Ÿæ¶æ„**: `CLAUDE.md` (é¡¹ç›®æ ¹ç›®å½•)
- **æƒé™ç®¡ç†**: `src/utils/permissions.py`
- **åˆ†æ”¯ç®¡ç†API**: `src/routes/app_branch_management.py`

---

**æœ€åæ›´æ–°**: 2025-10-13
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æµ‹è¯•è¦†ç›–ç‡**: 100% (8é¡¹ç½‘ç‚¹éš”ç¦»åŠŸèƒ½å…¨éƒ¨æµ‹è¯•)
