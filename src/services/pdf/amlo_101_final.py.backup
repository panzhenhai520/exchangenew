# -*- coding: utf-8 -*-
"""
AMLO-1-01 最终精确版本
完全1:1复刻标准PDF - 基于用户详细描述和标准PDF文本
"""

from reportlab.lib.pagesizes import A4
from reportlab.lib.units import mm
from reportlab.pdfgen import canvas
from reportlab.pdfbase import pdfmetrics
from reportlab.pdfbase.ttfonts import TTFont
from reportlab.lib.colors import HexColor
import os
from typing import Dict

PAGE_WIDTH, PAGE_HEIGHT = A4

# 精确颜色
GRAY_BG = HexColor('#E8E8E8')
BLACK = HexColor('#000000')
WHITE = HexColor('#FFFFFF')

# 边距 - 基于标准PDF精确测量
# 测量值（点）：外层19.56, 中层21.60, 内层23.70
# 转换：1点 = 0.3527777778mm
BORDER_OUT = 19.56 / 72 * 25.4 * mm  # 6.9mm
BORDER_MID = 21.60 / 72 * 25.4 * mm  # 7.62mm
BORDER_IN = 23.70 / 72 * 25.4 * mm   # 8.36mm
CONTENT_L = 28.8 / 72 * 25.4 * mm    # 内容左边距 ≈ 10.16mm
CONTENT_R = PAGE_WIDTH - 28.8 / 72 * 25.4 * mm  # 内容右边距

class AMLO101Final:
    def __init__(self):
        try:
            font_path = os.path.join(os.path.dirname(__file__), 'fonts', 'Sarabun-Regular.ttf')
            if os.path.exists(font_path):
                pdfmetrics.registerFont(TTFont('Sarabun', font_path))
        except: pass

    def _borders(self, c):
        """三层边框 - 基于标准PDF精确测量"""
        c.saveState()
        # 外层: 线宽0.84点
        c.setLineWidth(0.84)
        c.rect(BORDER_OUT, BORDER_OUT, PAGE_WIDTH-2*BORDER_OUT, PAGE_HEIGHT-2*BORDER_OUT)
        # 中层: 线宽1.62点（粗线）
        c.setLineWidth(1.62)
        c.rect(BORDER_MID, BORDER_MID, PAGE_WIDTH-2*BORDER_MID, PAGE_HEIGHT-2*BORDER_MID)
        # 内层: 线宽0.84点
        c.setLineWidth(0.84)
        c.rect(BORDER_IN, BORDER_IN, PAGE_WIDTH-2*BORDER_IN, PAGE_HEIGHT-2*BORDER_IN)
        c.restoreState()

    def _cb(self, c, x, y, txt='', checked=False):
        """复选框"""
        sz = 3*mm
        c.saveState()
        c.setLineWidth(0.5)
        c.setFillColor(WHITE)
        c.rect(x, y, sz, sz, fill=1, stroke=1)
        if checked:
            c.setFont('Helvetica', 9)
            c.drawString(x+0.4*mm, y+0.4*mm, '✓')
        if txt:
            c.setFillColor(BLACK)
            c.setFont('Sarabun', 8)
            c.drawString(x+sz+1.5*mm, y+0.5*mm, txt)
        c.restoreState()

    def _ul(self, c, x, y, w):
        """下划线"""
        c.setLineWidth(0.3)
        c.line(x, y, x+w, y)

    def _boxes(self, c, x, y, n=13, size=None, gap=None):
        """方格

        Args:
            c: canvas对象
            x, y: 起始坐标
            n: 方格数量
            size: 方格大小（默认5mm用于ID框，3mm用于账号框）
            gap: 方格间距（默认0.8mm）
        """
        if size is None:
            size = 5*mm
        if gap is None:
            gap = 0.8*mm

        c.saveState()
        for i in range(n):
            c.setLineWidth(0.5)
            c.setFillColor(WHITE)
            c.rect(x+i*(size+gap), y, size, size, fill=1, stroke=1)
        c.restoreState()

    def generate(self, data: Dict, path: str):
        c = canvas.Canvas(path, pagesize=A4)
        self._borders(c)

        y = PAGE_HEIGHT - CONTENT_L - 5*mm
        xl = CONTENT_L
        xr = CONTENT_R

        # ========== 区域1：标题 ==========
        # 左侧标题框（缩短宽度，左对齐）
        tw = 75*mm  # 缩短宽度避免重叠
        th = 10*mm
        tx = xl
        ty = y - th

        c.saveState()
        c.setLineWidth(1)
        c.setFillColor(GRAY_BG)
        c.rect(tx, ty, tw, th, fill=1, stroke=1)
        c.setFillColor(BLACK)
        c.setFont('Sarabun', 12)
        # 左对齐（不是居中）
        c.drawString(tx + 2*mm, ty + 3*mm, 'แบบรายงานการทำธุรกรรมที่ใช้เงินสด')
        c.restoreState()

        # 说明文字（与标题框左对齐）
        c.setFont('Sarabun', 6.5)
        c.setFillColor(BLACK)
        c.drawString(tx, ty - 3.5*mm,
                    '(โปรดกาเครื่องหมาย ✓ หน้าข้อที่เลือกและระบุข้อความตามที่กำหนดไว้ทุกข้อ)')

        # 右侧：报告编号区
        c.setFont('Sarabun', 9)
        c.drawRightString(xr, y + 3*mm, 'แบบ ปปง. ๑-๐๑')

        # 方格结构
        bx = 4*mm
        bg = 0.5*mm
        by = y - 6*mm

        # เลขที่标签（在标题框右侧留出间隔）
        c.setFont('Sarabun', 7)
        label_x = tx + tw + 5*mm  # 标题框右侧+间隔
        c.drawString(label_x, by + 0.5*mm, 'เลขที่')

        # สถาบันการเงิน (3框) - 从เลขที่后开始
        box1_x = label_x + 15*mm
        for i in range(3):
            c.rect(box1_x + i*(bx+bg), by, bx, bx)
        c.setFont('Sarabun', 6.5)
        c.drawCentredString(box1_x + 1.5*(bx+bg), by - 3*mm, 'สถาบันการเงิน')

        # 横线
        c.line(box1_x + 3*(bx+bg) + 0.5*mm, by + bx/2,
               box1_x + 3*(bx+bg) + 3*mm, by + bx/2)

        # สาขา (3框)
        box2_x = box1_x + 3*(bx+bg) + 3*mm
        for i in range(3):
            c.rect(box2_x + i*(bx+bg), by, bx, bx)
        c.drawCentredString(box2_x + 1.5*(bx+bg), by - 3*mm, 'สาขา')

        # 横线
        c.line(box2_x + 3*(bx+bg) + 0.5*mm, by + bx/2,
               box2_x + 3*(bx+bg) + 3*mm, by + bx/2)

        # ปี พ.ศ (2框)
        box3_x = box2_x + 3*(bx+bg) + 3*mm
        for i in range(2):
            c.rect(box3_x + i*(bx+bg), by, bx, bx)
        c.setFont('Sarabun', 5.5)
        c.drawString(box3_x - 1*mm, by - 3*mm, 'ปี พ.ศ.')
        c.drawString(box3_x - 1*mm, by - 6*mm, '(ใช้ ๒ หลักสุดท้าย)')

        # 横线
        c.line(box3_x + 2*(bx+bg) + 0.5*mm, by + bx/2,
               box3_x + 2*(bx+bg) + 3*mm, by + bx/2)

        # เลขลำดับรายงาน (长框)
        longbox_x = box3_x + 2*(bx+bg) + 3*mm
        longbox_w = xr - longbox_x
        c.rect(longbox_x, by, longbox_w, bx + 1*mm)
        c.setFont('Sarabun', 7)
        c.drawString(longbox_x + 2*mm, by + 1.5*mm, 'เลขลำดับรายงาน')

        # ========== 区域1和2之间：粗线 ==========
        y = ty - 8*mm
        c.setLineWidth(1.5)
        c.line(xl, y, xr, y)

        # ========== 区域2：选项区（高度很小）==========
        y -= 1.5*mm
        zone2_h = 6*mm  # 高度很小

        cby = y - 3.5*mm
        self._cb(c, xl + 2*mm, cby, 'รายงานฉบับหลัก')
        self._cb(c, xl + 42*mm, cby, 'รายงานฉบับแก้ไข/ เพิ่มเติม ครั้งที่')

        c.setFont('Sarabun', 8)
        # 横线紧跟在ครั้งที่后面
        self._ul(c, xl + 100*mm, cby - 0.5*mm, 12*mm)
        c.drawString(xl + 113*mm, cby, 'ลงวันที่')
        # 横线紧跟在ลงวันที่后面
        self._ul(c, xl + 127*mm, cby - 0.5*mm, 12*mm)

        # 竖线（在ลงวันที่后面）
        divx = xl + 132*mm
        c.setLineWidth(0.5)
        c.line(divx, y - zone2_h, divx, y)

        # 右侧文字（竖线后留一点空白）
        c.drawString(divx + 3*mm, cby, 'รวมเอกสารจำนวนทั้งสิ้น')
        self._ul(c, divx + 36*mm, cby - 0.5*mm, 10*mm)
        c.drawString(divx + 47*mm, cby, 'แผ่น')

        # ========== 区域2和3之间：粗线 ==========
        y = y - zone2_h - 1*mm
        c.setLineWidth(1.5)
        c.line(xl, y, xr, y)

        # ========== 区域3：ส่วนที่ ๑ ==========
        y -= 4*mm

        # 左侧标题框（缩短）
        sec1_w = 55*mm
        sec1_h = 7*mm

        c.saveState()
        c.setLineWidth(1)
        c.setFillColor(GRAY_BG)
        c.rect(xl, y - sec1_h, sec1_w, sec1_h, fill=1, stroke=1)
        c.setFillColor(BLACK)
        c.setFont('Sarabun', 9.5)
        c.drawString(xl + 2*mm, y - sec1_h + 2*mm, 'ส่วนที่ ๑. ผู้ทำธุรกรรม')
        c.restoreState()

        # 右侧：13个方格（包含在灰色区域内）
        id13_x = xr - 78*mm
        id13_y = y - 4*mm

        # 灰色背景（向上延伸到分隔线）
        gray_w = 78*mm
        # 从分隔线(y)开始，向下延伸
        gray_y_top = y  # 从分隔线开始
        gray_h = 20*mm  # 高度包含方格和文字
        gray_y = gray_y_top - gray_h

        c.saveState()
        c.setFillColor(GRAY_BG)
        c.rect(id13_x, gray_y, gray_w, gray_h, fill=1, stroke=0)
        c.restoreState()

        # 13个方格（在灰色背景上）
        self._boxes(c, id13_x, id13_y, 13)

        # 说明文字（黑色）
        c.setFillColor(BLACK)
        c.setFont('Sarabun', 6.5)
        txt_y = id13_y - 3.5*mm
        lines = [
            'โปรดระบุเลขที่บัตรประจำตัวประชาชน',
            'หากเป็นคนต่างด้าว โปรดระบุเลขที่หนังสือเดินทาง หรือเลขที่',
            'เอกสารประจำตัวอื่นๆ โดยให้กรอกเลขชิดด้านซ้ายเป็นหลัก'
        ]
        for line in lines:
            c.drawString(id13_x + 1*mm, txt_y, line)
            txt_y -= 3.5*mm

        # ส่วนที่ ๑ 字段
        yf = y - sec1_h - 3*mm

        # ๑.๑
        c.setFont('Sarabun', 8)
        c.drawString(xl, yf, '๑.๑ ชื่อ-นามสกุล')
        # 添加横线
        self._ul(c, xl + 30*mm, yf - 0.5*mm, 150*mm)

        yf -= 5*mm
        self._cb(c, xl + 2*mm, yf,
                'ทำธุรกรรมด้วยตนเอง (หากมีผู้ร่วมทำธุรกรรม ให้ระบุรายละเอียดของผู้ร่วมทำธุรกรรมในส่วนที่ ๒ ด้วย)')

        yf -= 5*mm
        self._cb(c, xl + 2*mm, yf,
                'ทำธุรกรรมแทนผู้อื่น (โปรดระบุรายละเอียดของผู้มอบหมาย หรือผู้มอบอำนาจในส่วนที่ ๒ ด้วย)')

        # ๑.๒ ที่อยู่ (只有一条长横线)
        yf -= 7*mm
        c.drawString(xl, yf, '๑.๒ ที่อยู่')
        self._ul(c, xl + 15*mm, yf - 0.5*mm, 165*mm)

        # 下方横线 + โทรศัพท์ โทรสาร
        yf -= 5*mm
        self._ul(c, xl, yf - 0.5*mm, 130*mm)
        c.drawString(xl + 133*mm, yf, 'โทรศัพท์')
        self._ul(c, xl + 152*mm, yf - 0.5*mm, 28*mm)

        # ๑.๓ อาชีพ สถานที่ทำงาน โทรศัพท์
        yf -= 6*mm
        c.drawString(xl, yf, '๑.๓ อาชีพ')
        self._ul(c, xl + 17*mm, yf - 0.5*mm, 45*mm)
        c.drawString(xl + 64*mm, yf, 'สถานที่ทำงาน')
        self._ul(c, xl + 88*mm, yf - 0.5*mm, 42*mm)
        c.drawString(xl + 132*mm, yf, 'โทรศัพท์')
        self._ul(c, xl + 152*mm, yf - 0.5*mm, 28*mm)

        # ๑.๔ สถานที่สะดวกในการติดต่อ
        yf -= 6*mm
        c.drawString(xl, yf, '๑.๔ สถานที่สะดวกในการติดต่อ')
        self._ul(c, xl + 52*mm, yf - 0.5*mm, 128*mm)

        # 下方横线 + โทรศัพท์ โทรสาร
        yf -= 5*mm
        self._ul(c, xl, yf - 0.5*mm, 130*mm)
        c.drawString(xl + 133*mm, yf, 'โทรศัพท์')
        self._ul(c, xl + 152*mm, yf - 0.5*mm, 13*mm)
        c.drawString(xl + 167*mm, yf, 'โทรสาร')
        self._ul(c, xl + 185*mm, yf - 0.5*mm, xr - xl - 185*mm)

        # ๑.๕ หลักฐานที่ใช้ในการทำธุรกรรม
        yf -= 6*mm
        c.drawString(xl, yf, '๑.๕ หลักฐานที่ใช้ในการทำธุรกรรม')
        # 紧凑排列，不延伸到边框外
        self._cb(c, xl + 55*mm, yf, 'บัตรประจำตัวประชาชน/ข้าราชการ/พนักงานรัฐวิสาหกิจ')
        self._cb(c, xl + 125*mm, yf, 'หนังสือเดินทาง')

        # 第二行
        yf -= 5*mm
        self._cb(c, xl + 2*mm, yf, 'ใบสำคัญประจำตัวคนต่างด้าว')

        # 另一行
        yf -= 5*mm
        self._cb(c, xl + 2*mm, yf, 'อื่นๆ (โปรดระบุ)')
        self._ul(c, xl + 30*mm, yf - 0.5*mm, 150*mm)

        # 最后一行：เลขที่ ออกให้โดย เมื่อ หมดอายุ
        yf -= 5*mm
        c.drawString(xl + 2*mm, yf, 'เลขที่')
        self._ul(c, xl + 15*mm, yf - 0.5*mm, 45*mm)
        c.drawString(xl + 62*mm, yf, 'ออกให้โดย')
        self._ul(c, xl + 82*mm, yf - 0.5*mm, 35*mm)
        c.drawString(xl + 119*mm, yf, 'เมื่อ')
        self._ul(c, xl + 130*mm, yf - 0.5*mm, 25*mm)
        c.drawString(xl + 157*mm, yf, 'หมดอายุ')
        self._ul(c, xl + 175*mm, yf - 0.5*mm, xr - xl - 175*mm)

        # ========== ส่วนที่ ๒ ==========
        yf -= 8*mm
        c.setLineWidth(1.5)
        c.line(xl, yf, xr, yf)

        yf -= 6*mm
        # 标题框（缩短一半）
        sec2_w = 55*mm

        c.saveState()
        c.setFillColor(GRAY_BG)
        c.rect(xl, yf, sec2_w, 7*mm, fill=1, stroke=1)
        c.setFillColor(BLACK)
        c.setFont('Sarabun', 9.5)
        c.drawString(xl + 2*mm, yf + 2*mm, 'ส่วนที่ ๒. ผู้ร่วมทำธุรกรรม ผู้มอบหมาย หรือผู้มอบอำนาจ')
        c.restoreState()

        # 右侧3个复选框（在标题框右侧）
        cb2x = xl + sec2_w + 5*mm
        self._cb(c, cb2x, yf + 4.5*mm, 'ผู้ร่วมทำธุรกรรม')
        self._cb(c, cb2x, yf + 1.5*mm, 'ผู้มอบหมาย')
        self._cb(c, cb2x, yf - 1.5*mm, 'ผู้มอบอำนาจ')

        # 13个方格（在3个复选框右侧）
        id2_x = xr - 78*mm
        id2_y = yf + 2*mm
        self._boxes(c, id2_x, id2_y, 13)

        # 灰色说明框（包含13个方格，向上延伸到分隔线）
        gray2_w = 78*mm
        gray2_y_top = yf + 7*mm  # 到分隔线
        gray2_h = 20*mm
        gray2_y = gray2_y_top - gray2_h

        c.saveState()
        c.setFillColor(GRAY_BG)
        c.rect(id2_x, gray2_y, gray2_w, gray2_h, fill=1, stroke=0)
        c.restoreState()

        # 13个方格（重新绘制在灰色背景上）
        self._boxes(c, id2_x, id2_y, 13)

        # 说明文字（4行）
        c.setFillColor(BLACK)
        c.setFont('Sarabun', 6.5)
        txt2_y = id2_y - 3.5*mm
        lines2 = [
            'โปรดระบุเลขที่บัตรประจำตัวประชาชน',
            'หากเป็นนิติบุคคล โปรดระบุเลขประจำตัวผู้เสียภาษีอากร',
            'หากเป็นคนต่างด้าว โปรดระบุเลขที่หนังสือเดินทาง หรือเลขที่',
            'เอกสารประจำตัวอื่นๆ โดยให้กรอกเลขชิดด้านซ้ายเป็นหลัก'
        ]
        for line in lines2:
            c.drawString(id2_x + 1*mm, txt2_y, line)
            txt2_y -= 3.5*mm

        # ส่วนที่ ๒ 字段
        yf -= 16*mm
        c.setFont('Sarabun', 8)
        c.drawString(xl, yf, '๒.๑ ชื่อ')
        self._ul(c, xl + 15*mm, yf - 0.5*mm, 165*mm)

        # ๒.๒ ที่อยู่/สถานที่ตั้ง (两行)
        yf -= 6*mm
        c.drawString(xl, yf, '๒.๒ ที่อยู่/สถานที่ตั้ง')
        self._ul(c, xl + 35*mm, yf - 0.5*mm, 145*mm)

        yf -= 5*mm
        self._ul(c, xl, yf - 0.5*mm, 130*mm)
        c.drawString(xl + 133*mm, yf, 'โทรศัพท์')
        self._ul(c, xl + 152*mm, yf - 0.5*mm, 13*mm)
        c.drawString(xl + 167*mm, yf, 'โทรสาร')
        self._ul(c, xl + 185*mm, yf - 0.5*mm, xr - xl - 185*mm)

        # ๒.๓
        yf -= 6*mm
        c.drawString(xl, yf, '๒.๓ อาชีพ')
        self._ul(c, xl + 17*mm, yf - 0.5*mm, 45*mm)
        c.drawString(xl + 64*mm, yf, 'สถานที่ทำงาน')
        self._ul(c, xl + 88*mm, yf - 0.5*mm, 42*mm)
        c.drawString(xl + 132*mm, yf, 'โทรศัพท์')
        self._ul(c, xl + 152*mm, yf - 0.5*mm, 28*mm)

        # 在นิติบุคคล
        yf -= 4*mm
        c.setFont('Sarabun', 7)
        c.drawString(xl + 2*mm, yf, 'ในกรณีเป็นนิติบุคคลให้ระบุประเภทการประกอบการ')
        self._ul(c, xl + 65*mm, yf - 0.5*mm, 115*mm)

        # ๒.๔
        yf -= 6*mm
        c.setFont('Sarabun', 8)
        c.drawString(xl, yf, '๒.๔ สถานที่สะดวกในการติดต่อ')
        self._ul(c, xl + 52*mm, yf - 0.5*mm, 78*mm)

        yf -= 5*mm
        self._ul(c, xl, yf - 0.5*mm, 80*mm)
        c.drawString(xl + 83*mm, yf, 'โทรศัพท์')
        self._ul(c, xl + 102*mm, yf - 0.5*mm, 28*mm)
        c.drawString(xl + 132*mm, yf, 'โทรสาร')
        self._ul(c, xl + 152*mm, yf - 0.5*mm, 28*mm)

        # ๒.๕
        yf -= 6*mm
        c.drawString(xl, yf, '๒.๕ หลักฐานที่ใช้ในการทำธุรกรรม')
        self._cb(c, xl + 58*mm, yf, 'บัตรประจำตัวประชาชน/ข้าราชการ/พนักงานรัฐวิสาหกิจ')
        self._cb(c, xl + 130*mm, yf, 'หนังสือเดินทาง')

        yf -= 5*mm
        self._cb(c, xl + 2*mm, yf, 'ใบสำคัญประจำตัวคนต่างด้าว')
        self._cb(c, xl + 55*mm, yf, 'หนังสือรับรองข้อความในทะเบียนที่นายทะเบียนออกให้ไม่เกิน ๑ เดือน')
        self._cb(c, xl + 145*mm, yf, 'อื่นๆ (โปรดระบุ)')

        yf -= 5*mm
        c.drawString(xl + 2*mm, yf, 'เลขที่')
        self._ul(c, xl + 15*mm, yf - 0.5*mm, 45*mm)
        c.drawString(xl + 62*mm, yf, 'ออกให้โดย')
        self._ul(c, xl + 82*mm, yf - 0.5*mm, 35*mm)
        c.drawString(xl + 119*mm, yf, 'เมื่อ')
        self._ul(c, xl + 130*mm, yf - 0.5*mm, 25*mm)
        c.drawString(xl + 157*mm, yf, 'หมดอายุ')
        self._ul(c, xl + 175*mm, yf - 0.5*mm, xr - xl - 175*mm)

        # ========== ส่วนที่ ๓ ==========
        yf -= 8*mm
        c.setLineWidth(1.5)
        c.line(xl, yf, xr, yf)

        yf -= 6*mm
        # 标题框（缩短一半）
        sec3_w = 80*mm

        c.saveState()
        c.setFillColor(GRAY_BG)
        c.rect(xl, yf, sec3_w, 7*mm, fill=1, stroke=1)
        c.setFillColor(BLACK)
        c.setFont('Sarabun', 9.5)
        c.drawString(xl + 2*mm, yf + 2*mm, 'ส่วนที่ ๓. ข้อเท็จจริงเกี่ยวกับธุรกรรม')
        c.restoreState()

        # 右侧日期
        c.setFont('Sarabun', 8)
        c.drawString(xr - 65*mm, yf + 3*mm, 'วันที่ทำธุรกรรม')
        self._ul(c, xr - 35*mm, yf + 2.5*mm, 15*mm)
        c.drawString(xr - 18*mm, yf + 3*mm, 'เดือน')
        self._ul(c, xr - 5*mm, yf + 2.5*mm, 5*mm)

        yf -= 10*mm
        c.drawString(xl, yf, '๓.๑ ประเภทและมูลค่าธุรกรรม')

        # 左右两个带边框的表格（不是虚线分隔）
        yf -= 6*mm

        # 左框
        left_x = xl
        left_w = 85*mm
        left_h = 50*mm

        c.setLineWidth(0.5)
        c.rect(left_x, yf - left_h, left_w, left_h)

        # 右框
        right_x = left_x + left_w + 5*mm
        right_w = 85*mm
        c.rect(right_x, yf - left_h, right_w, left_h)

        # 左框：垂直分隔线（将框分为左右两部分）
        amount_col_x = left_x + 62*mm  # 右侧金额列的位置
        c.setLineWidth(0.5)
        c.line(amount_col_x, yf - left_h, amount_col_x, yf)  # 垂直线

        # 左框内容（顶部留出间距）
        yfl = yf - 5*mm  # 从顶部向下5mm开始
        self._cb(c, left_x + 2*mm, yfl, 'ฝากเงิน')

        # 右侧列标题"จำนวน (บาท)"
        c.setFont('Sarabun', 7)
        c.drawString(amount_col_x + 2*mm, yfl + 0.5*mm, 'จำนวน (บาท)')

        # 账户信息 - 使用10个小方框（3mm）
        yfl -= 5*mm
        c.setFont('Sarabun', 7)
        c.drawString(left_x + 2*mm, yfl, 'เข้าบัญชีเลขที่')
        # 10个小方框（3mm大小）
        box_start_x = left_x + 22*mm
        self._boxes(c, box_start_x, yfl - 0.5*mm, 10, size=3*mm, gap=0.5*mm)

        yfl -= 5*mm
        c.setFont('Sarabun', 6)
        c.drawString(left_x + 2*mm, yfl, 'บัญชีที่เกี่ยวของ')
        # 10个小方框（3mm大小）
        self._boxes(c, box_start_x, yfl - 0.5*mm, 10, size=3*mm, gap=0.5*mm)

        yfl -= 3*mm
        c.drawString(left_x + 2*mm, yfl, '(หากมี)')

        # 复选框
        yfl -= 4*mm
        c.setFont('Sarabun', 8)
        self._cb(c, left_x + 2*mm, yfl, 'ซื้อตราสารการเงิน')

        yfl -= 4*mm
        self._cb(c, left_x + 4*mm, yfl, 'เช็ค')
        yfl -= 4*mm
        self._cb(c, left_x + 4*mm, yfl, 'ดราฟต์')
        yfl -= 4*mm
        self._cb(c, left_x + 4*mm, yfl, 'อื่นๆ')
        self._ul(c, left_x + 18*mm, yfl - 0.5*mm, 44*mm)

        yfl -= 5*mm
        self._cb(c, left_x + 2*mm, yfl, 'ซื้อเงินตราต่างประเทศ (โปรดระบุสกุลเงิน)')
        yfl -= 4*mm
        self._cb(c, left_x + 2*mm, yfl, 'อื่นๆ(ระบุ)')
        self._ul(c, left_x + 20*mm, yfl - 0.5*mm, 42*mm)

        # 右侧金额列的8条虚线（在垂直分隔线右侧）
        yfl -= 3*mm
        c.setDash(1, 1)
        for i in range(8):
            c.line(amount_col_x + 2*mm, yfl - i*2.5*mm, left_x + left_w - 2*mm, yfl - i*2.5*mm)
        c.setDash()

        # รวมเงิน
        yfl -= 22*mm
        c.drawString(left_x + 2*mm, yfl, 'รวมเงิน')

        # 灰色区域
        yfl -= 6*mm
        c.saveState()
        c.setFillColor(GRAY_BG)
        c.rect(left_x + 1*mm, yfl - 1*mm, left_w - 2*mm, 5*mm, fill=1, stroke=0)
        c.setFillColor(BLACK)
        c.setFont('Sarabun', 7)
        c.drawString(left_x + 3*mm, yfl, '(จำนวนเงินเป็นตัวอักษร)')
        c.restoreState()

        # 右框：垂直分隔线（将框分为左右两部分）
        amount_col_x_r = right_x + 62*mm  # 右侧金额列的位置
        c.setLineWidth(0.5)
        c.line(amount_col_x_r, yf - left_h, amount_col_x_r, yf)  # 垂直线

        # 右框内容（顶部留出间距）
        yfr = yf - 5*mm  # 从顶部向下5mm开始
        self._cb(c, right_x + 2*mm, yfr, 'ถอนเงิน')

        # 右侧列标题"จำนวน (บาท)"
        c.setFont('Sarabun', 7)
        c.drawString(amount_col_x_r + 2*mm, yfr + 0.5*mm, 'จำนวน (บาท)')

        # 账户信息 - 使用10个小方框（3mm）
        yfr -= 5*mm
        c.setFont('Sarabun', 7)
        c.drawString(right_x + 2*mm, yfr, 'จากบัญชีเลขที่')
        # 10个小方框（3mm大小）
        box_start_x_r = right_x + 22*mm
        self._boxes(c, box_start_x_r, yfr - 0.5*mm, 10, size=3*mm, gap=0.5*mm)

        yfr -= 5*mm
        c.setFont('Sarabun', 6)
        c.drawString(right_x + 2*mm, yfr, 'บัญชีที่เกี่ยวของ')
        # 10个小方框（3mm大小）
        self._boxes(c, box_start_x_r, yfr - 0.5*mm, 10, size=3*mm, gap=0.5*mm)

        yfr -= 3*mm
        c.drawString(right_x + 2*mm, yfr, '(หากมี)')

        yfr -= 4*mm
        c.setFont('Sarabun', 8)
        self._cb(c, right_x + 2*mm, yfr, 'ขายตราสารการเงิน')

        yfr -= 4*mm
        self._cb(c, right_x + 4*mm, yfr, 'เช็ค')
        yfr -= 4*mm
        self._cb(c, right_x + 4*mm, yfr, 'ดราฟต์')
        yfr -= 4*mm
        self._cb(c, right_x + 4*mm, yfr, 'อื่นๆ')
        self._ul(c, right_x + 18*mm, yfr - 0.5*mm, 44*mm)

        yfr -= 5*mm
        self._cb(c, right_x + 2*mm, yfr, 'ขายเงินตราต่างประเทศ (โปรดระบุสกุลเงิน)')
        yfr -= 4*mm
        self._cb(c, right_x + 2*mm, yfr, 'อื่นๆ(ระบุ)')
        self._ul(c, right_x + 20*mm, yfr - 0.5*mm, 42*mm)

        # 右侧金额列的8条虚线（在垂直分隔线右侧）
        yfr -= 3*mm
        c.setDash(1, 1)
        for i in range(8):
            c.line(amount_col_x_r + 2*mm, yfr - i*2.5*mm, right_x + right_w - 2*mm, yfr - i*2.5*mm)
        c.setDash()

        # รวมเงิน
        yfr -= 22*mm
        c.drawString(right_x + 2*mm, yfr, 'รวมเงิน')

        # 灰色区域
        yfr -= 6*mm
        c.saveState()
        c.setFillColor(GRAY_BG)
        c.rect(right_x + 1*mm, yfr - 1*mm, right_w - 2*mm, 5*mm, fill=1, stroke=0)
        c.setFillColor(BLACK)
        c.setFont('Sarabun', 7)
        c.drawString(right_x + 3*mm, yfr, '(จำนวนเงินเป็นตัวอักษร)')
        c.restoreState()

        # ๓.๒ ๓.๓
        yf = yf - left_h - 6*mm
        c.setFont('Sarabun', 8)
        c.drawString(xl, yf, '๓.๒ ชื่อผู้รับประโยชน์ในการทำธุรกรรม (ถ้ามี)')
        self._ul(c, xl + 75*mm, yf - 0.5*mm, 105*mm)

        yf -= 5*mm
        c.drawString(xl, yf, '๓.๓ วัตถุประสงค์ในการทำธุรกรรม')
        self._ul(c, xl + 60*mm, yf - 0.5*mm, 120*mm)

        # ========== ส่วนที่ ๔ ==========
        yf -= 8*mm
        c.setLineWidth(1.5)
        c.line(xl, yf, xr, yf)

        yf -= 6*mm
        c.saveState()
        c.setFillColor(GRAY_BG)
        c.rect(xl, yf, 25*mm, 7*mm, fill=1, stroke=1)
        c.setFillColor(BLACK)
        c.setFont('Sarabun', 9.5)
        c.drawString(xl + 2*mm, yf + 2*mm, 'ส่วนที่ ๔')
        c.restoreState()

        # 签名区域
        yf -= 10*mm
        c.setFont('Sarabun', 7)

        # 左侧框
        c.rect(xl, yf - 15*mm, 85*mm, 15*mm)
        c.drawString(xl + 2*mm, yf - 3*mm, '☐ สถาบันการเงินเป็นผู้บันทึกข้อเท็จจริง')
        c.drawString(xl + 55*mm, yf - 3*mm, '(วัน/เดือน/ปีที่บันทึกข้อเท็จจริง)')
        c.drawString(xl + 2*mm, yf - 7*mm, '☐ ลูกค้าไม่ลงลายมือชื่อ')

        c.setFont('Sarabun', 6)
        c.drawString(xl + 2*mm, yf - 13*mm, 'ลายมือชื่อผู้ทำธุรกรรมหรือผู้บันทึกข้อเท็จจริง')

        # 右侧框
        c.rect(right_x, yf - 15*mm, 85*mm, 15*mm)
        c.setFont('Sarabun', 7)
        c.drawString(right_x + 55*mm, yf - 3*mm, '(วัน/เดือน/ปีที่รายงาน)')

        c.setFont('Sarabun', 6)
        c.drawString(right_x + 2*mm, yf - 13*mm, 'ลายมือชื่อผู้รายงาน')

        c.save()
        return path

if __name__ == '__main__':
    gen = AMLO101Final()
    output = 'test_final.pdf'
    gen.generate({}, output)
    print(f"Generated: {output}")
