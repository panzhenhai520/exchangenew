<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ±‡ç‡å±•ç¤º - æœºé¡¶ç›’</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; font-weight: bold; overflow: hidden; }
        
        .loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); z-index: 1000; color: white; }
        .spinner { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.3); border-top: 5px solid white; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-text { font-size: 24px; margin-bottom: 20px; text-align: center; }
        .loading-status { font-size: 16px; text-align: center; opacity: 0.8; max-width: 600px; line-height: 1.5; }
        .error-message { background: rgba(255, 0, 0, 0.2); border: 1px solid rgba(255, 0, 0, 0.5); border-radius: 10px; padding: 20px; margin-top: 20px; max-width: 500px; }
        
        .rates-display { display: none; width: 100vw; height: 100vh; padding: 15px; font-family: Arial, sans-serif; font-weight: bold; overflow: hidden; position: relative; flex-direction: column; }
        
        .light-theme { background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%); color: #000; }
        .light-theme .rates-table { border: 4px solid #2d5016; background: rgba(255, 255, 255, 0.95); }
        .light-theme .table-header { background: linear-gradient(135deg, #4299e1 0%, #2c5282 100%); color: white; border-bottom: 3px solid #2d5016; }
        .light-theme .rate-row { border-bottom: 2px solid #4a7c23; }
        .light-theme .rate-row.even-row { background: rgba(66, 153, 225, 0.05); }
        .light-theme .rate-row.empty-row { background: rgba(66, 153, 225, 0.02); }
        .light-theme .buy-cell { background: rgba(72, 187, 120, 0.15); }
        .light-theme .sell-cell { background: rgba(245, 101, 101, 0.15); }
        
        .dark-theme { background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%); color: #fff; }
        .dark-theme .rates-table { border: 4px solid #68d391; background: rgba(26, 32, 44, 0.95); }
        .dark-theme .table-header { background: linear-gradient(135deg, #2c5282 0%, #1a365d 100%); color: white; border-bottom: 3px solid #68d391; }
        .dark-theme .rate-row { border-bottom: 2px solid #68d391; }
        .dark-theme .rate-row.even-row { background: rgba(99, 179, 237, 0.05); }
        .dark-theme .rate-row.empty-row { background: rgba(99, 179, 237, 0.02); }
        .dark-theme .buy-cell { background: rgba(72, 187, 120, 0.2); }
        .dark-theme .sell-cell { background: rgba(245, 101, 101, 0.2); }
        .dark-theme .table-header > div:nth-child(2) { background: rgba(255, 255, 0, 0.15); }
        .dark-theme .rate-row > div:nth-child(2) { background: rgba(255, 255, 0, 0.15); }
        .dark-theme .denomination-cell { background: rgba(255, 255, 0, 0.15); }
        
        .branch-info-corner { position: absolute; top: 8px; right: 15px; font-size: 0.7rem; opacity: 0.6; text-align: right; }
        .branch-code { font-weight: bold; }
        .base-currency { font-size: 0.6rem; }
        
        .header-section { text-align: center; margin-bottom: 15px; }
        .main-title { font-size: 1.4rem; font-weight: 900; margin: 0 0 8px 0; letter-spacing: 1px; white-space: nowrap; }
        .info-row { display: flex; justify-content: center; gap: 20px; font-size: 0.8rem; font-weight: bold; flex-wrap: wrap; }
        .info-item { display: flex; align-items: center; gap: 4px; }

        .info-label { font-size: 0.7rem; opacity: 0.8; }
        .info-value { background: rgba(0,0,0,0.1); padding: 2px 6px; border-radius: 3px; font-family: Courier New, monospace; font-size: 0.75rem; }
        .dark-theme .info-value { background: rgba(255,255,255,0.1); }
        
        .rates-table { flex: 1; border-radius: 8px; overflow: hidden; box-shadow: 0 6px 24px rgba(0,0,0,0.15); display: flex; flex-direction: column; }
        .table-header { display: grid; grid-template-columns: 2.0fr 1.5fr 1.4fr 1.4fr; padding: 12px 0; font-size: 1.3rem; font-weight: 900; text-align: center; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
        .table-header > div:nth-child(2) { background: rgba(255, 255, 0, 0.1); }
        .currency-header { display: flex; align-items: center; justify-content: center; font-size: 1.4rem; }
        .denomination-header { display: flex; align-items: center; justify-content: center; font-size: 1.3rem; background: rgba(255, 193, 7, 0.15); }
        .rate-header { display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .rate-type { font-size: 1.3rem; font-weight: 900; }
        .rate-subtitle { font-size: 0.85rem; font-weight: 600; opacity: 0.9; margin-top: 1px; }
        .buy-header { background: rgba(72, 187, 120, 0.25); }
        .sell-header { background: rgba(245, 101, 101, 0.25); }
        
        .table-body { flex: 1; overflow: hidden; }
        .rate-row { display: grid; grid-template-columns: 2.0fr 1.5fr 1.4fr 1.4fr; min-height: 45px; align-items: center; }
        .rate-row > div:nth-child(2) { background: rgba(255, 255, 0, 0.1); }
        .currency-cell { display: flex; align-items: center; padding: 8px 15px; gap: 12px; }
        .flag-container { width: 60px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 6px; overflow: hidden; box-shadow: 0 1px 4px rgba(0,0,0,0.15); background: white; }
        .flag-icon { width: 100%; height: 100%; object-fit: cover; }
        .currency-info { display: flex; flex-direction: column; align-items: flex-start; }
        .currency-code { font-size: 1.6rem; font-weight: 900; letter-spacing: 0.5px; line-height: 1; }
        .currency-name { font-size: 0.75rem; font-weight: 600; opacity: 0.7; margin-top: 2px; line-height: 1; }
        
        .denomination-cell { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            padding: 8px 10px; 
            text-align: center;
            background: rgba(255, 255, 0, 0.1);
        }
        .denomination-range { 
            font-size: 1.0rem; 
            font-weight: 900; 
            letter-spacing: 0.2px; 
            line-height: 1; 
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .denomination-type { 
            font-size: 0.7rem; 
            font-weight: 600; 
            opacity: 0.7; 
            margin-top: 2px; 
            line-height: 1; 
        }
        
        .rate-cell { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            height: 100%; 
            font-size: 1.8rem; 
            font-weight: 900; 
            font-family: 'Arial Black', Arial, sans-serif;
        }
        .rate-value { 
            font-weight: 900; 
            letter-spacing: 0.5px;
        }
        .no-rate { 
            font-size: 1.6rem; 
            opacity: 0.4; 
            font-weight: 900; 
        }
        
        .bottom-info-section { margin-top: 15px; padding: 10px 0; border-top: 1px solid rgba(255,255,255,0.2); }
        .dark-theme .bottom-info-section { border-top: 1px solid rgba(255,255,255,0.15); }
        .light-theme .bottom-info-section { border-top: 1px solid rgba(0,0,0,0.1); }
        .bottom-info-row { display: flex; justify-content: center; align-items: center; gap: 30px; font-size: 0.7rem; flex-wrap: wrap; }
        .info-item.language-controls .info-value { background: rgba(0,123,255,0.15); color: #0056b3; font-size: 0.65rem; }
        .dark-theme .info-item.language-controls .info-value { background: rgba(99,179,237,0.2); color: #63b3ed; }
        .info-item.operation-hints .info-value { background: rgba(255,193,7,0.15); color: #856404; font-size: 0.65rem; }
        .dark-theme .info-item.operation-hints .info-value { background: rgba(255,193,7,0.2); color: #ffc107; }
        .info-item.refresh-status .info-value { background: rgba(40,167,69,0.15); color: #155724; font-size: 0.65rem; }
        .dark-theme .info-item.refresh-status .info-value { background: rgba(40,167,69,0.2); color: #28a745; }
        
        @media (max-width: 1200px) {
            .main-title { font-size: 1.2rem; }
        }
            .info-row { font-size: 0.75rem; gap: 15px; }
            .currency-code { font-size: 1.4rem; }
            .rate-cell { font-size: 1.6rem; }
            .bottom-info-row { font-size: 0.65rem; gap: 20px; }
            .info-item.language-controls .info-value,
            .info-item.operation-hints .info-value,
            .info-item.refresh-status .info-value { font-size: 0.6rem; }
            
            /* ç¡®ä¿é¢å€¼åˆ—åœ¨å°å±å¹•ä¸‹ä¹Ÿä¿æŒå¯¹é½ */
            .table-header { grid-template-columns: 2.0fr 1.5fr 1.4fr 1.4fr; }
            .rate-row { grid-template-columns: 2.0fr 1.5fr 1.4fr 1.4fr; }
        }
        
        @media (max-width: 992px) {
            .table-header { grid-template-columns: 1.8fr 1.4fr 1.3fr 1.3fr; }
            .rate-row { grid-template-columns: 1.8fr 1.4fr 1.3fr 1.3fr; }
            .denomination-range { font-size: 0.9rem; }
        }
        
        @media (max-width: 768px) {
            .table-header { grid-template-columns: 1.6fr 1.3fr 1.2fr 1.2fr; }
            .rate-row { grid-template-columns: 1.6fr 1.3fr 1.2fr 1.2fr; }
            .denomination-range { font-size: 0.8rem; }
            .currency-code { font-size: 1.2rem; }
            .rate-cell { font-size: 1.4rem; }
        }
    </style>
</head>
<body>
    <div class="loading-screen" id="loadingScreen">
        <div class="spinner"></div>
        <div class="loading-text">æ­£åœ¨è·å–æœ€æ–°æ±‡ç‡ä¿¡æ¯...</div>
        <div class="loading-status" id="loadingStatus">è¿æ¥æ±‡ç‡ç®¡ç†ç³»ç»Ÿ...</div>
    </div>
    
    <div class="rates-display" id="ratesDisplay">
        <div class="branch-info-corner">
            <div class="branch-code" id="branchCode"></div>
            <div class="base-currency" id="baseCurrency"></div>
        </div>
        

        
        <div class="header-section">
            <h1 class="main-title">CURRENCY EXCHANGE RATES</h1>
            <div class="info-row">
                <span class="info-item">
                    <span class="info-label">DATE:</span>
                    <span class="info-value" id="displayDate"></span>
                </span>
                <span class="info-item">
                    <span class="info-label">TIME:</span>
                    <span class="info-value" id="displayTime"></span>
                </span>
                <span class="info-item">
                    <span class="info-label">PAGE:</span>
                    <span class="info-value" id="displayPage">1/1</span>
                </span>
            </div>
        </div>
        
        <div class="rates-table">
            <div class="table-header" id="tableHeader">
                <div class="header-cell currency-header">CURRENCY</div>
                <div class="header-cell rate-header buy-header">
                    <div class="rate-type">Buying</div>
                    <div class="rate-subtitle">Bank Notes</div>
                </div>
                <div class="header-cell rate-header sell-header">
                    <div class="rate-type">Selling</div>
                    <div class="rate-subtitle">Bank Notes</div>
                </div>
            </div>
            <div class="table-body" id="ratesTableBody"></div>
        </div>
        
        <div class="bottom-info-section">
            <div class="bottom-info-row">
                <span class="info-item language-controls">
                    <span class="info-value">1: ä¸­æ–‡ | 2: English | 3: à¹„à¸—à¸¢</span>
                </span>
                <span class="info-item operation-hints">
                    <span class="info-value">R: åˆ·æ–° | F11: å…¨å±</span>
                </span>
                <span class="info-item refresh-status">
                    <span class="info-value">è‡ªåŠ¨åˆ·æ–°: <span id="refreshCountdown">3600</span>ç§’åæ›´æ–°</span>
                </span>
            </div>
        </div>
    </div>

<script>
// åŠ¨æ€è·å–æœåŠ¡å™¨åœ°å€ - æ”¯æŒç¯å¢ƒè‡ªåŠ¨æ£€æµ‹
function getServerUrl() {
    // ä¼˜å…ˆæ£€æŸ¥ç¯å¢ƒé…ç½®
    if (typeof window.ENV_CONFIG !== 'undefined' && window.ENV_CONFIG.BACKEND_URL) {
        console.log('[æœåŠ¡å™¨åœ°å€] ä½¿ç”¨ç¯å¢ƒé…ç½®:', window.ENV_CONFIG.BACKEND_URL);
        return window.ENV_CONFIG.BACKEND_URL;
    }

    // æ£€æŸ¥å½“å‰é¡µé¢çš„ä¸»æœºåœ°å€ï¼Œä½¿ç”¨ç«¯å£5001
    const currentHost = window.location.hostname;
    const currentPort = window.location.port;
    const protocol = window.location.protocol;

    console.log('[æœåŠ¡å™¨åœ°å€] å½“å‰é¡µé¢ä¿¡æ¯:', {
        protocol: protocol,
        hostname: currentHost,
        port: currentPort,
        href: window.location.href
    });

    // ä¿®å¤ï¼šå½“ç›´æ¥è®¿é—®æ–‡ä»¶æ—¶hostnameä¸ºç©ºçš„é—®é¢˜
    if (!currentHost || currentHost === '' || currentHost === 'file' || protocol === 'file:') {
        console.log('[æœåŠ¡å™¨åœ°å€] ç›´æ¥è®¿é—®æ–‡ä»¶ï¼Œå°è¯•è‡ªåŠ¨æ£€æµ‹IP');
        // å°è¯•ä»å¸¸è§çš„å¼€å‘æœºå™¨IPä¸­æ£€æµ‹
        const possibleIPs = [
            '192.168.13.56',  // å½“å‰æœºå™¨
            '192.168.13.56',   // æ—§æœºå™¨
            '192.168.1.100',  // å¸¸è§å¼€å‘IP
            '192.168.13.56'       // æœ¬åœ°å›ç¯
        ];

        // ä½¿ç”¨æœ€æ–°çš„IPï¼ˆä¼˜å…ˆä½¿ç”¨192.168.13.56ï¼‰
        const detectedIP = possibleIPs[0];
        console.log('[æœåŠ¡å™¨åœ°å€] ä½¿ç”¨æ£€æµ‹åˆ°çš„IP:', detectedIP);
        return `http://${detectedIP}:5001`;
    }

    // å¦‚æœæœ‰ç«¯å£å·ï¼Œä½¿ç”¨å½“å‰ç«¯å£ï¼Œå¦åˆ™ä½¿ç”¨5001
    const port = currentPort || '5001';
    const serverUrl = currentHost === 'localhost' || currentHost === '192.168.13.56'
        ? `http://192.168.13.56:5001`
        : `http://${currentHost}:${port}`;
    console.log('[æœåŠ¡å™¨åœ°å€] ä½¿ç”¨: ' + serverUrl);
    return serverUrl;
}

// åŠ¨æ€è·å–ç½‘ç‚¹ä»£ç 
function getBranchCode() {
    // ç›´æ¥ä»URLå‚æ•°è·å–ç½‘ç‚¹ä»£ç ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨A005
    const urlParams = new URLSearchParams(window.location.search);
    const branchFromUrl = urlParams.get('branch');
    if (branchFromUrl) {
        console.log('[ç½‘ç‚¹ä»£ç ] ä»URLå‚æ•°è·å–:', branchFromUrl);
        return branchFromUrl;
    }
    
    // é»˜è®¤ä½¿ç”¨A005ç½‘ç‚¹
    console.log('[ç½‘ç‚¹ä»£ç ] ä½¿ç”¨é»˜è®¤å€¼: A005');
    return "A005";
}

const CONFIG = { 
    serverUrl: getServerUrl(), 
    branchCode: getBranchCode(), 
    refreshInterval: 3600000, 
    retryInterval: 300000, 
    maxRetries: 3, 
    itemsPerPage: 12
};

let retryCount = 0, countdownTimer = null, pageTimer = null, timeTimer = null, currentData = null, currentPage = 1, totalPages = 1, currentLanguage = 'zh';

const elements = { 
    loadingScreen: document.getElementById("loadingScreen"), 
    ratesDisplay: document.getElementById("ratesDisplay"), 
    loadingStatus: document.getElementById("loadingStatus"), 
    branchCode: document.getElementById("branchCode"), 
    baseCurrency: document.getElementById("baseCurrency"),
    displayDate: document.getElementById("displayDate"), 
    displayTime: document.getElementById("displayTime"), 
    displayPage: document.getElementById("displayPage"), 
    ratesTableBody: document.getElementById("ratesTableBody"), 
    tableHeader: document.getElementById("tableHeader"), 
    refreshCountdown: document.getElementById("refreshCountdown")
};

// åˆå§‹åŒ–ç½‘ç‚¹ä¿¡æ¯æ˜¾ç¤º
function initializeBranchInfo() {
    elements.branchCode.textContent = CONFIG.branchCode;
}

function updateStatus(message, isError = false) { 
    elements.loadingStatus.innerHTML = isError ? `<div class="error-message">${message}</div>` : message; 
}

// æµ‹è¯•ç½‘ç»œè¿æ¥
async function testNetworkConnection() {
    try {
        const testUrl = `${CONFIG.serverUrl}/api/dashboard/settop-box/auto-url/${CONFIG.branchCode}`;
        console.log('[ç½‘ç»œæµ‹è¯•] æµ‹è¯•URL:', testUrl);
        
        const response = await fetch(testUrl, {
            method: 'GET',
            timeout: 5000,
            headers: {
                'Accept': 'application/json'
            }
        });
        
        if (response.ok) {
            return `è¿æ¥æˆåŠŸ (${response.status})`;
        } else {
            return `è¿æ¥å¤±è´¥ (${response.status})`;
        }
    } catch (error) {
        console.error('[ç½‘ç»œæµ‹è¯•] è¿æ¥é”™è¯¯:', error);
        return `è¿æ¥é”™è¯¯: ${error.message}`;
    }
}

function switchLanguage(lang) {
    console.log('[å¤šè¯­è¨€] åˆ‡æ¢è¯­è¨€åˆ°:', lang);
    currentLanguage = lang;
    const languageNames = {
        'zh': 'ä¸­æ–‡',
        'en': 'English', 
        'th': 'à¹„à¸—à¸¢'
    };
    console.log('[å¤šè¯­è¨€] ç•Œé¢è¯­è¨€æ˜¾ç¤ºå·²æ›´æ–°ä¸º:', languageNames[lang] || 'ä¸­æ–‡');
    
    // é‡æ–°æ˜¾ç¤ºå½“å‰é¡µé¢ä»¥åº”ç”¨æ–°è¯­è¨€
    if (currentData && currentData.rates) {
        console.log('[å¤šè¯­è¨€] é‡æ–°æ¸²æŸ“æ±‡ç‡åˆ—è¡¨...');
        displayCurrentPage();
    } else if (currentData && currentData.denomination_rates) {
        console.log('[å¤šè¯­è¨€] é‡æ–°æ¸²æŸ“é¢å€¼æ±‡ç‡åˆ—è¡¨...');
        // è·å–å½“å‰ä¸»é¢˜
        const currentTheme = currentData.theme || 'light';
        displayDenominationRates(currentData, currentTheme);
    } else if (window.currentDisplayMode === 'denomination' && window.currentDenominationData) {
        console.log('[å¤šè¯­è¨€] é‡æ–°æ¸²æŸ“é¢å€¼æ±‡ç‡åˆ—è¡¨ï¼ˆä»å…¨å±€å˜é‡ï¼‰...');
        // è·å–å½“å‰ä¸»é¢˜
        const currentTheme = window.currentTheme || 'light';
        displayDenominationRates(window.currentDenominationData, currentTheme);
    }
}

// è·å–é¢å€¼æ±‡ç‡å¤šè¯­è¨€ç¿»è¯‘
function getDenominationTranslations(lang) {
    const translations = {
        'zh': {
            currency: 'å¸ç§',
            denomination: 'é¢å€¼',
            buyRate: 'ä¹°å…¥ä»·',
            sellRate: 'å–å‡ºä»·',
            buyRateSubtitle: 'Buy Rate',
            sellRateSubtitle: 'Sell Rate',
            bill: 'çº¸å¸',
            coin: 'ç¡¬å¸',
            unknownCurrency: 'æœªçŸ¥å¸ç§'
        },
        'en': {
            currency: 'Currency',
            denomination: 'Denomination',
            buyRate: 'Buy Rate',
            sellRate: 'Sell Rate',
            buyRateSubtitle: 'Buy Rate',
            sellRateSubtitle: 'Sell Rate',
            bill: 'Banknote',
            coin: 'Coin',
            unknownCurrency: 'Unknown Currency'
        },
        'th': {
            currency: 'à¸ªà¸à¸¸à¸¥à¹€à¸‡à¸´à¸™',
            denomination: 'à¸¡à¸¹à¸¥à¸„à¹ˆà¸²',
            buyRate: 'à¸£à¸²à¸„à¸²à¸‹à¸·à¹‰à¸­',
            sellRate: 'à¸£à¸²à¸„à¸²à¸‚à¸²à¸¢',
            buyRateSubtitle: 'Buy Rate',
            sellRateSubtitle: 'Sell Rate',
            bill: 'à¸˜à¸™à¸šà¸±à¸•à¸£',
            coin: 'à¹€à¸«à¸£à¸µà¸¢à¸',
            unknownCurrency: 'à¸ªà¸à¸¸à¸¥à¹€à¸‡à¸´à¸™à¹„à¸¡à¹ˆà¸—à¸£à¸²à¸š'
        }
    };
    
    return translations[lang] || translations['zh'];
}


function updateDateTime() {
    const now = new Date();
    elements.displayDate.textContent = now.toLocaleDateString("en-CA");
    elements.displayTime.textContent = now.toLocaleTimeString("en-US", { hour: "2-digit", minute: "2-digit", hour12: true });
}

async function fetchRatesData() {
    try {
        console.log('[è¿æ¥ä¿¡æ¯] æœåŠ¡å™¨åœ°å€:', CONFIG.serverUrl);
        console.log('[è¿æ¥ä¿¡æ¯] ç½‘ç‚¹ä»£ç :', CONFIG.branchCode);
        updateStatus("æ­£åœ¨è·å–æ±‡ç‡å±•ç¤ºé“¾æ¥...");
        
        const response = await fetch(`${CONFIG.serverUrl}/api/dashboard/settop-box/auto-url/${CONFIG.branchCode}`);
        
        console.log('[APIå“åº”] çŠ¶æ€ç :', response.status);
        console.log('[APIå“åº”] çŠ¶æ€æ–‡æœ¬:', response.statusText);
        console.log('[APIå“åº”] Content-Type:', response.headers.get('Content-Type'));
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('[APIé”™è¯¯] å“åº”å†…å®¹:', errorText);
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        // æ£€æŸ¥å“åº”æ˜¯å¦ä¸ºJSONæ ¼å¼
        const contentType = response.headers.get('Content-Type') || '';
        if (!contentType.includes('application/json')) {
            const responseText = await response.text();
            console.error('[APIé”™è¯¯] å“åº”ä¸æ˜¯JSONæ ¼å¼:', responseText);
            throw new Error(`æœåŠ¡å™¨è¿”å›äº†éJSONå“åº”: ${contentType}`);
        }
        
        const result = await response.json();
        console.log('[APIå“åº”] å®Œæ•´å“åº”:', result);
        
        if (result.success && result.data) {
            updateStatus("è·å–é“¾æ¥æˆåŠŸï¼Œæ­£åœ¨åŠ è½½æ±‡ç‡æ•°æ®...");
            const url = new URL(result.data.redirect_url, CONFIG.serverUrl);
            // ä»URLè·¯å¾„ä¸­æå–tokenï¼š/display-rates/{token}
            const pathParts = url.pathname.split('/');
            const token = pathParts[pathParts.length - 1]; // è·å–è·¯å¾„æœ€åä¸€éƒ¨åˆ†ä½œä¸ºtoken
            const theme = url.searchParams.get("theme") || "light";
            const language = url.searchParams.get("lang") || "zh"; // æå–è¯­è¨€å‚æ•°
            console.log('[Tokenæå–] å®Œæ•´URL:', result.data.redirect_url);
            console.log('[Tokenæå–] æå–çš„token:', token);
            console.log('[Tokenæå–] ä¸»é¢˜:', theme);
            console.log('[Tokenæå–] è¯­è¨€:', language);
            if (!token) throw new Error("æ— æ³•è·å–è®¿é—®ä»¤ç‰Œ");
            
            // å…ˆè·å–æ±‡ç‡æ•°æ®ï¼Œç„¶åå†è®¾ç½®è¯­è¨€
            console.log('[æ±‡ç‡æ•°æ®] å¼€å§‹è·å–æ±‡ç‡æ•°æ®ï¼Œä½¿ç”¨å®Œæ•´URL:', result.data.redirect_url);
            // æ·»åŠ æ—¶é—´æˆ³å¼ºåˆ¶åˆ·æ–°ç¼“å­˜
            const timestamp = new Date().getTime();
            const fullUrl = `${CONFIG.serverUrl}${result.data.redirect_url}&force_refresh=true&t=${timestamp}`;
            console.log('[æ±‡ç‡æ•°æ®] å®Œæ•´è¯·æ±‚URL:', fullUrl);
            
            const ratesResponse = await fetch(fullUrl, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'Cache-Control': 'no-cache',
                    'Pragma': 'no-cache'
                }
            });
            console.log('[æ±‡ç‡æ•°æ®] çŠ¶æ€ç :', ratesResponse.status);
            console.log('[æ±‡ç‡æ•°æ®] Content-Type:', ratesResponse.headers.get('Content-Type'));
            
            if (!ratesResponse.ok) {
                const errorText = await ratesResponse.text();
                console.error('[æ±‡ç‡æ•°æ®é”™è¯¯] å“åº”å†…å®¹:', errorText);
                throw new Error(`è·å–æ±‡ç‡æ•°æ®å¤±è´¥: HTTP ${ratesResponse.status}: ${errorText}`);
            }
            
            // æ£€æŸ¥å“åº”æ˜¯å¦ä¸ºJSONæ ¼å¼
            const ratesContentType = ratesResponse.headers.get('Content-Type') || '';
            if (!ratesContentType.includes('application/json')) {
                const responseText = await ratesResponse.text();
                console.error('[æ±‡ç‡æ•°æ®é”™è¯¯] å“åº”ä¸æ˜¯JSONæ ¼å¼:', responseText);
                throw new Error(`æ±‡ç‡æ•°æ®å“åº”ä¸æ˜¯JSONæ ¼å¼: ${ratesContentType}`);
            }
            
            const ratesData = await ratesResponse.json();
            console.log('[æ±‡ç‡æ•°æ®] å®Œæ•´å“åº”:', ratesData);
            
            if (ratesData.success) { 
                currentData = ratesData.data; 
                updateStatus("æ•°æ®åŠ è½½å®Œæˆï¼Œæ­£åœ¨æ¸²æŸ“ç•Œé¢...");
                
                // å»¶è¿Ÿæ¸²æŸ“ä»¥ç¡®ä¿æ ·å¼åŠ è½½å®Œæˆ
                setTimeout(() => {
                displayRates(ratesData.data, theme); 
                    updateStatus("ç•Œé¢æ¸²æŸ“å®Œæˆ");
                }, 50);
                
                return true; 
            }
            throw new Error(ratesData.message || "è·å–æ±‡ç‡æ•°æ®å¤±è´¥");
        }
        throw new Error(result.message || "è·å–å±•ç¤ºé“¾æ¥å¤±è´¥");
    } catch (error) {
        console.error("è·å–æ±‡ç‡æ•°æ®å¤±è´¥:", error);
        console.error("é”™è¯¯è¯¦æƒ…:", {
            message: error.message,
            stack: error.stack,
            serverUrl: CONFIG.serverUrl,
            branchCode: CONFIG.branchCode,
            userAgent: navigator.userAgent,
            location: window.location.href
        });
        
        // ç‰¹æ®Šå¤„ç†"Failed to fetch"é”™è¯¯
        let errorMessage = error.message;
        if (error.message === "Failed to fetch") {
            errorMessage = "ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œå¯èƒ½æ˜¯CORSé—®é¢˜æˆ–æœåŠ¡å™¨ä¸å¯è¾¾";
        }
        
        // å°è¯•æµ‹è¯•ç½‘ç»œè¿æ¥
        testNetworkConnection().then(result => {
            let statusMessage = `è·å–å¤±è´¥: ${errorMessage}<br/>è°ƒè¯•ä¿¡æ¯: æœåŠ¡å™¨=${CONFIG.serverUrl}, ç½‘ç‚¹=${CONFIG.branchCode}<br/>ç½‘ç»œæµ‹è¯•: ${result}`;
            
            // å¦‚æœæ˜¯file://åè®®è®¿é—®ï¼Œç»™å‡ºç‰¹æ®Šæç¤º
            if (window.location.protocol === 'file:') {
                statusMessage += `<br/><br/>âš ï¸ æ£€æµ‹åˆ°é€šè¿‡æ–‡ä»¶ç³»ç»Ÿè®¿é—®ï¼Œå»ºè®®é€šè¿‡HTTPæœåŠ¡å™¨è®¿é—®:<br/>http://192.168.13.56:5001/static/Show.html?branch=${CONFIG.branchCode}`;
            }
            
            updateStatus(statusMessage, true);
        }).catch(() => {
            updateStatus(`è·å–å¤±è´¥: ${errorMessage}<br/>è°ƒè¯•ä¿¡æ¯: æœåŠ¡å™¨=${CONFIG.serverUrl}, ç½‘ç‚¹=${CONFIG.branchCode}<br/>ç½‘ç»œæµ‹è¯•: å¤±è´¥`, true);
        });
        
        return false;
    }
}

function displayRates(data, theme = "light") {
    elements.ratesDisplay.className = `rates-display ${theme}-theme`;
    elements.ratesDisplay.style.display = "flex";
    elements.loadingScreen.style.display = "none";
    
    // ç«‹å³åº”ç”¨ä¸»é¢˜æ ·å¼
    document.body.className = `${theme}-theme`;
    
    // ğŸŒŸ åŠ¨æ€é…ç½®æ”¯æŒï¼šä»APIè¯»å–æ˜¾ç¤ºé…ç½®å‚æ•°
    if (data.display_config) {
        console.log('[é…ç½®æ›´æ–°] APIè¿”å›çš„æ˜¾ç¤ºé…ç½®:', data.display_config);
        
        // æ›´æ–°æ¯é¡µè¡Œæ•°
        if (data.display_config.items_per_page && data.display_config.items_per_page > 0) {
            CONFIG.itemsPerPage = data.display_config.items_per_page;
            console.log('[é…ç½®æ›´æ–°] æ¯é¡µè¡Œæ•°æ›´æ–°ä¸º:', CONFIG.itemsPerPage);
        }
        
        // æ›´æ–°åˆ·æ–°é—´éš”ï¼ˆç§’è½¬æ¢ä¸ºæ¯«ç§’ï¼‰
        if (data.display_config.refresh_interval && data.display_config.refresh_interval > 0) {
            CONFIG.refreshInterval = data.display_config.refresh_interval * 1000;
            console.log('[é…ç½®æ›´æ–°] åˆ·æ–°é—´éš”æ›´æ–°ä¸º:', CONFIG.refreshInterval / 1000, 'ç§’');
            
            // ç«‹å³æ›´æ–°åˆ·æ–°å€’è®¡æ—¶æ˜¾ç¤º
            elements.refreshCountdown.textContent = data.display_config.refresh_interval;
        }
    } else {
        console.log('[é…ç½®æ›´æ–°] ä½¿ç”¨é»˜è®¤é…ç½®: æ¯é¡µ', CONFIG.itemsPerPage, 'è¡Œ, åˆ·æ–°é—´éš”', CONFIG.refreshInterval / 1000, 'ç§’');
    }
    
    // æ›´æ–°ç½‘ç‚¹ä¿¡æ¯ï¼šä¼˜å…ˆä½¿ç”¨APIè¿”å›çš„ç½‘ç‚¹ä¿¡æ¯ï¼Œå¦åˆ™ä½¿ç”¨é…ç½®çš„ç½‘ç‚¹ä»£ç 
    if (data.branch && data.branch.code) {
        elements.branchCode.textContent = data.branch.code;
        console.log('[ç½‘ç‚¹ä¿¡æ¯] ä½¿ç”¨APIè¿”å›çš„ç½‘ç‚¹ä»£ç :', data.branch.code);
        // å¦‚æœæœ‰æœ¬å¸ä¿¡æ¯ï¼Œä¹Ÿæ›´æ–°æ˜¾ç¤º
        if (data.branch.base_currency) {
            elements.baseCurrency.textContent = data.branch.base_currency;
        }
    } else {
        elements.branchCode.textContent = CONFIG.branchCode;
        console.log('[ç½‘ç‚¹ä¿¡æ¯] APIæœªè¿”å›ç½‘ç‚¹ä»£ç ï¼Œä½¿ç”¨é…ç½®çš„ç½‘ç‚¹ä»£ç :', CONFIG.branchCode);
    }
    
    // è®¾ç½®æ­£ç¡®çš„è¯­è¨€ï¼šä¼˜å…ˆä½¿ç”¨APIè¿”å›çš„è¯­è¨€è®¾ç½®
    const finalLanguage = data.language || getLanguageFromUrl();
    console.log('[æ•°æ®å¤„ç†] APIè¿”å›çš„è¯­è¨€è®¾ç½®:', data.language);
    console.log('[æ•°æ®å¤„ç†] URLå‚æ•°ä¸­çš„è¯­è¨€:', getLanguageFromUrl());
    console.log('[æ•°æ®å¤„ç†] æœ€ç»ˆä½¿ç”¨çš„è¯­è¨€è®¾ç½®:', finalLanguage);
    console.log('[æ•°æ®å¤„ç†] åˆ‡æ¢å‰çš„å½“å‰è¯­è¨€:', currentLanguage);
    switchLanguage(finalLanguage);
    
    updateDateTime();
    
    // ğŸŒŸ æ£€æŸ¥æ˜¯å¦ä¸ºé¢å€¼æ±‡ç‡æ¨¡å¼
    if (data.has_denominations && data.denomination_rates && data.denomination_rates.length > 0) {
        console.log('[é¢å€¼æ±‡ç‡] æ£€æµ‹åˆ°é¢å€¼æ±‡ç‡æ•°æ®ï¼Œåˆ‡æ¢åˆ°é¢å€¼æ˜¾ç¤ºæ¨¡å¼');
        console.log('[é¢å€¼æ±‡ç‡] é¢å€¼æ±‡ç‡æ•°æ®:', data.denomination_rates);
        displayDenominationRates(data, theme);
    } else {
        console.log('[æ ‡å‡†æ±‡ç‡] ä½¿ç”¨æ ‡å‡†æ±‡ç‡æ˜¾ç¤ºæ¨¡å¼');
        
        // ğŸ”§ ä¿®å¤ï¼šè®¾ç½®å…¨å±€å˜é‡ä»¥ä¾¿ç¿»é¡µå®šæ—¶å™¨ä½¿ç”¨
        window.currentDisplayMode = 'standard';
        window.currentStandardData = data;
        window.currentTheme = theme;
        
    const rates = data.rates || [];
    
    // é‡æ–°è®¡ç®—æ€»é¡µæ•°ï¼ˆé…ç½®æ›´æ–°åï¼‰
    totalPages = Math.ceil(rates.length / CONFIG.itemsPerPage);
    currentPage = 1;
    
    console.log('[é¡µé¢è®¡ç®—] æ€»å¸ç§æ•°:', rates.length);
    console.log('[é¡µé¢è®¡ç®—] æ¯é¡µè¡Œæ•°:', CONFIG.itemsPerPage);
    console.log('[é¡µé¢è®¡ç®—] è®¡ç®—æ€»é¡µæ•°:', totalPages);
    
    displayCurrentPage();
    }
    
    startTimers();
}

function displayCurrentPage() {
    if (!currentData || !currentData.rates) return;
    const rates = currentData.rates;
    const start = (currentPage - 1) * CONFIG.itemsPerPage;
    const end = start + CONFIG.itemsPerPage;
    const currentPageRates = rates.slice(start, end);
    elements.displayPage.textContent = `${currentPage}/${totalPages}`;
    
    // è®¾ç½®æ ‡å‡†æ±‡ç‡çš„è¡¨æ ¼å¤´éƒ¨ï¼ˆä¸åŒ…å«é¢å€¼åˆ—ï¼‰
    elements.tableHeader.innerHTML = `
        <div class="header-cell currency-header">å¸ç§</div>
        <div class="header-cell rate-header buy-header">
            <div class="rate-type">ä¹°å…¥ä»·</div>
            <div class="rate-subtitle">Buy Rate</div>
        </div>
        <div class="header-cell rate-header sell-header">
            <div class="rate-type">å–å‡ºä»·</div>
            <div class="rate-subtitle">Sell Rate</div>
        </div>
    `;
    
    elements.ratesTableBody.innerHTML = "";
    
    // æ¸²æŸ“å®é™…æ±‡ç‡æ•°æ®
    currentPageRates.forEach((rate, index) => {
        const row = document.createElement("div");
        row.className = `rate-row ${index % 2 === 1 ? "even-row" : ""}`;
        
        // æ£€æµ‹æ˜¯å¦é€šè¿‡HTTPæœåŠ¡å™¨è®¿é—®
        const isHttpServer = window.location.protocol === 'http:' || window.location.protocol === 'https:';
        const baseUrl = isHttpServer ? '' : 'http://localhost:5001';
        
        // ğŸŒŸ ä¿®å¤è‡ªå®šä¹‰å¸ç§å›¾æ ‡æ˜¾ç¤ºé€»è¾‘
        let flagSrc;
        if (rate.custom_flag_filename) {
            // ä¼˜å…ˆä½¿ç”¨è‡ªå®šä¹‰å›¾æ ‡
            flagSrc = `${baseUrl}/flags/${rate.custom_flag_filename}`;
            console.log(`[å¸ç§å›¾æ ‡] ${rate.currency_code} ä½¿ç”¨è‡ªå®šä¹‰å›¾æ ‡: ${rate.custom_flag_filename}`);
        } else if (rate.flag_code) {
            // ä½¿ç”¨æ ‡å‡†å›½æ——å›¾æ ‡
            flagSrc = `${baseUrl}/flags/${rate.flag_code.toLowerCase()}.svg`;
            console.log(`[å¸ç§å›¾æ ‡] ${rate.currency_code} ä½¿ç”¨æ ‡å‡†å›¾æ ‡: ${rate.flag_code.toLowerCase()}.svg`);
        } else {
            // ä½¿ç”¨é»˜è®¤å›¾æ ‡
            flagSrc = `${baseUrl}/flags/unknown.svg`;
            console.log(`[å¸ç§å›¾æ ‡] ${rate.currency_code} ä½¿ç”¨é»˜è®¤å›¾æ ‡: unknown.svg`);
        }
        
        const fallbackSrc = `${baseUrl}/images/chart-placeholder.svg`;
        
        // ğŸŒŸ åŠ¨æ€å¤šè¯­è¨€æ”¯æŒï¼šä¼˜å…ˆä½¿ç”¨APIè¿”å›çš„å¤šè¯­è¨€åç§°
        let currencyName = rate.currency_name; // é»˜è®¤åç§°ï¼ˆå‘åå…¼å®¹ï¼‰
        console.log(`[å¸ç§æ¸²æŸ“] ${rate.currency_code}:`);
        console.log(`  é»˜è®¤åç§°: ${rate.currency_name}`);
        console.log(`  å¤šè¯­è¨€æ•°æ®:`, rate.currency_names);
        console.log(`  å½“å‰è¯­è¨€: ${currentLanguage}`);
        
        if (rate.currency_names && rate.currency_names[currentLanguage]) {
            currencyName = rate.currency_names[currentLanguage];
            console.log(`  âœ… æ‰¾åˆ°${currentLanguage}è¯­è¨€æ˜ å°„: ${currencyName}`);
        } else {
            console.log(`  âŒ æ— ${currentLanguage}è¯­è¨€æ˜ å°„ï¼Œä½¿ç”¨é»˜è®¤: ${currencyName}`);
        }
        
        row.innerHTML = `
            <div class="currency-cell">
                <div class="flag-container">
                    <img src="${flagSrc}" alt="${rate.currency_code}" class="flag-icon" onerror="this.src='${fallbackSrc}'">
                </div>
                <div class="currency-info">
                    <div class="currency-code">${rate.currency_code}</div>
                    <div class="currency-name">${currencyName}</div>
                </div>
            </div>
            <div class="rate-cell buy-cell">
                ${rate.buy_rate > 0 ? `<span class="rate-value">${formatRate(rate.buy_rate)}</span>` : '<span class="no-rate">-</span>'}
            </div>
            <div class="rate-cell sell-cell">
                ${rate.sell_rate > 0 ? `<span class="rate-value">${formatRate(rate.sell_rate)}</span>` : '<span class="no-rate">-</span>'}
            </div>
        `;
        elements.ratesTableBody.appendChild(row);
    });
    
    // è¡¥å……ç©ºè¡Œåˆ°æŒ‡å®šè¡Œæ•°
    const currentRowCount = currentPageRates.length;
    const targetRowCount = CONFIG.itemsPerPage;
    console.log('[ç©ºè¡Œè¡¥å……] å½“å‰è¡Œæ•°:', currentRowCount, 'ç›®æ ‡è¡Œæ•°:', targetRowCount);
    
    for (let i = currentRowCount; i < targetRowCount; i++) {
        const emptyRow = document.createElement("div");
        emptyRow.className = `rate-row empty-row ${i % 2 === 1 ? "even-row" : ""}`;
        emptyRow.innerHTML = `
            <div class="currency-cell">
                <div class="currency-info">
                    <div class="currency-code">&nbsp;</div>
                    <div class="currency-name">&nbsp;</div>
                </div>
            </div>
            <div class="rate-cell buy-cell">
                <span class="no-rate">&nbsp;</span>
            </div>
            <div class="rate-cell sell-cell">
                <span class="no-rate">&nbsp;</span>
            </div>
        `;
        elements.ratesTableBody.appendChild(emptyRow);
    }
}

function formatRate(rate) { 
    return Number(rate).toFixed(2); 
}

function startTimers() {
    // ğŸ”§ ä¿®å¤ï¼šå…ˆæ¸…ç†æ‰€æœ‰æ—§å®šæ—¶å™¨ï¼Œé˜²æ­¢å¤šä¸ªå®šæ—¶å™¨åŒæ—¶è¿è¡Œ
    clearTimers();
    
    timeTimer = setInterval(updateDateTime, 1000);
    if (totalPages > 1) {
        // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨CONFIG.refreshIntervalè€Œä¸æ˜¯ç¡¬ç¼–ç çš„10ç§’
        pageTimer = setInterval(() => {
            currentPage = currentPage >= totalPages ? 1 : currentPage + 1;
            // ğŸ”§ ä¿®å¤ï¼šæ ¹æ®å½“å‰æ¨¡å¼è°ƒç”¨æ­£ç¡®çš„æ˜¾ç¤ºå‡½æ•°
            if (window.currentDisplayMode === 'denomination') {
                displayDenominationRates(window.currentDenominationData, window.currentTheme);
            } else {
                displayCurrentPage();
            }
        }, CONFIG.refreshInterval);
    }
    startRefreshCountdown();
}

function startRefreshCountdown() {
    // ğŸ”§ ä¿®å¤ï¼šå…ˆæ¸…ç†æ—§çš„å€’è®¡æ—¶å®šæ—¶å™¨
    if (countdownTimer) {
        clearInterval(countdownTimer);
        countdownTimer = null;
    }
    
    let seconds = CONFIG.refreshInterval / 1000;
    console.log('[å€’è®¡æ—¶] å¼€å§‹å€’è®¡æ—¶ï¼Œåˆå§‹å€¼:', seconds, 'ç§’');
    elements.refreshCountdown.textContent = seconds;
    
    countdownTimer = setInterval(() => {
        seconds--;
        elements.refreshCountdown.textContent = seconds;
        if (seconds <= 0) { 
            clearInterval(countdownTimer); 
            refreshData(); 
        }
    }, 1000);
}

function clearTimers() {
    if (countdownTimer) {
        clearInterval(countdownTimer);
        countdownTimer = null;
    }
    if (pageTimer) {
        clearInterval(pageTimer);
        pageTimer = null;
    }
    if (timeTimer) {
        clearInterval(timeTimer);
        timeTimer = null;
    }
}

async function refreshData() {
    retryCount = 0;
    clearTimers();
    const success = await fetchRatesData();
    if (!success) setTimeout(refreshData, CONFIG.retryInterval);
}

async function attemptFetch() {
    const success = await fetchRatesData();
    if (!success) {
        retryCount++;
        if (retryCount <= CONFIG.maxRetries) {
            updateStatus(`è·å–å¤±è´¥ï¼Œ${CONFIG.retryInterval/60000}åˆ†é’Ÿåé‡è¯• (${retryCount}/${CONFIG.maxRetries})`, true);
            setTimeout(attemptFetch, CONFIG.retryInterval);
        } else {
            updateStatus("å¤šæ¬¡å°è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œç³»ç»ŸçŠ¶æ€<br>ç³»ç»Ÿå°†åœ¨1å°æ—¶åè‡ªåŠ¨é‡è¯•", true);
            setTimeout(() => { 
                retryCount = 0; 
                attemptFetch(); 
            }, CONFIG.refreshInterval);
        }
    }
}

document.addEventListener("keydown", (event) => {
    switch(event.key.toLowerCase()) {
        case "r": refreshData(); break;
        case "f11": document.fullscreenElement ? document.exitFullscreen() : document.documentElement.requestFullscreen(); break;
        case "arrowleft": if (totalPages > 1) { currentPage = currentPage <= 1 ? totalPages : currentPage - 1; displayCurrentPage(); } break;
        case "arrowright": if (totalPages > 1) { currentPage = currentPage >= totalPages ? 1 : currentPage + 1; displayCurrentPage(); } break;
        case "1": switchLanguage('zh'); break;
        case "2": switchLanguage('en'); break;
        case "3": switchLanguage('th'); break;
    }
});

// åˆå§‹åŒ–æ˜¾ç¤º
initializeBranchInfo();

// ä»URLå‚æ•°è·å–è¯­è¨€è®¾ç½®
function getLanguageFromUrl() {
    const urlParams = new URLSearchParams(window.location.search);
    const langFromUrl = urlParams.get('lang');
    return langFromUrl || 'zh'; // é»˜è®¤ä¸­æ–‡
}

// ç¡®ä¿CSSæ ·å¼å·²åŠ è½½
function ensureStylesLoaded() {
    // å¼ºåˆ¶é‡æ–°è®¡ç®—æ ·å¼
    document.body.offsetHeight;
    
    // ç¡®ä¿é¢å€¼åˆ—çš„èƒŒæ™¯è‰²æ ·å¼ç”Ÿæ•ˆ
    const style = document.createElement('style');
    style.textContent = `
        .table-header > div:nth-child(2) { 
            background: rgba(255, 255, 0, 0.1) !important; 
        }
        .rate-row > div:nth-child(2) { 
            background: rgba(255, 255, 0, 0.1) !important; 
        }
        .denomination-cell { 
            background: rgba(255, 255, 0, 0.1) !important; 
        }
        .dark-theme .table-header > div:nth-child(2) { 
            background: rgba(255, 255, 0, 0.15) !important; 
        }
        .dark-theme .rate-row > div:nth-child(2) { 
            background: rgba(255, 255, 0, 0.15) !important; 
        }
        .dark-theme .denomination-cell { 
            background: rgba(255, 255, 0, 0.15) !important; 
        }
    `;
    document.head.appendChild(style);
}

// å¼ºåˆ¶åº”ç”¨é¢å€¼åˆ—èƒŒæ™¯è‰²æ ·å¼
function applyDenominationBackgroundStyles() {
    console.log('[æ ·å¼åº”ç”¨] å¼€å§‹å¼ºåˆ¶åº”ç”¨é¢å€¼åˆ—èƒŒæ™¯è‰²æ ·å¼');
    
    // åº”ç”¨è¡¨å¤´èƒŒæ™¯è‰²
    const headerCells = document.querySelectorAll('.table-header > div:nth-child(2)');
    headerCells.forEach(cell => {
        cell.style.background = 'rgba(255, 255, 0, 0.1)';
        cell.style.position = 'relative';
    });
    
    // åº”ç”¨æ•°æ®è¡ŒèƒŒæ™¯è‰²
    const dataCells = document.querySelectorAll('.rate-row > div:nth-child(2)');
    dataCells.forEach(cell => {
        cell.style.background = 'rgba(255, 255, 0, 0.1)';
        cell.style.position = 'relative';
    });
    
    // åº”ç”¨é¢å€¼å•å…ƒæ ¼èƒŒæ™¯è‰²
    const denominationCells = document.querySelectorAll('.denomination-cell');
    denominationCells.forEach(cell => {
        cell.style.background = 'rgba(255, 255, 0, 0.1)';
    });
    
    console.log('[æ ·å¼åº”ç”¨] é¢å€¼åˆ—èƒŒæ™¯è‰²æ ·å¼åº”ç”¨å®Œæˆ');
}

// ğŸŒŸ é¢å€¼æ±‡ç‡æ˜¾ç¤ºå‡½æ•°
function displayDenominationRates(data, theme = "light") {
    console.log('[é¢å€¼æ±‡ç‡] å¼€å§‹æ˜¾ç¤ºé¢å€¼æ±‡ç‡æ•°æ®:', data);
    
    // éªŒè¯å¿…è¦çš„æ•°æ®
    if (!data.denomination_rates || data.denomination_rates.length === 0) {
        console.error('[é¢å€¼æ±‡ç‡] ç¼ºå°‘é¢å€¼æ±‡ç‡æ•°æ®');
        updateStatus('é¢å€¼æ±‡ç‡æ•°æ®ä¸å®Œæ•´ï¼šç¼ºå°‘é¢å€¼æ±‡ç‡ä¿¡æ¯', true);
        return;
    }
    
    console.log('[é¢å€¼æ±‡ç‡] æ•°æ®éªŒè¯é€šè¿‡ï¼Œå¼€å§‹å¤„ç†é¢å€¼æ±‡ç‡æ•°æ®');
    
    // ç¡®ä¿CSSæ ·å¼å·²åŠ è½½
    ensureStylesLoaded();
    
    // æ›´æ–°è¡¨æ ¼å¤´éƒ¨ä»¥æ”¯æŒé¢å€¼æ˜¾ç¤ºï¼ˆå¤šè¯­è¨€ï¼‰
    const translations = getDenominationTranslations(currentLanguage);
    elements.tableHeader.innerHTML = `
        <div class="header-cell currency-header">${translations.currency}</div>
        <div class="header-cell denomination-header">${translations.denomination}</div>
        <div class="header-cell rate-header buy-header">
            <div class="rate-type">${translations.buyRate}</div>
            <div class="rate-subtitle">${translations.buyRateSubtitle}</div>
        </div>
        <div class="header-cell rate-header sell-header">
            <div class="rate-type">${translations.sellRate}</div>
            <div class="rate-subtitle">${translations.sellRateSubtitle}</div>
        </div>
    `;
    
    // æ¸…ç©ºè¡¨æ ¼å†…å®¹
    elements.ratesTableBody.innerHTML = "";
    
    // æ£€æµ‹æ˜¯å¦é€šè¿‡HTTPæœåŠ¡å™¨è®¿é—®
    const isHttpServer = window.location.protocol === 'http:' || window.location.protocol === 'https:';
    const baseUrl = isHttpServer ? '' : 'http://localhost:5001';
    
    // è·å–é¢å€¼æ±‡ç‡æ•°æ®
    const denominationRates = data.denomination_rates || [];
    
    // æŒ‰å¸ç§åˆ†ç»„
    const currencyGroups = {};
    denominationRates.forEach(rate => {
        const currencyId = rate.currency_id;
        console.log('[é¢å€¼æ±‡ç‡] å¤„ç†é¢å€¼æ±‡ç‡:', rate, 'currency_id:', currencyId);
        if (!currencyId) {
            console.warn('[é¢å€¼æ±‡ç‡] é¢å€¼æ±‡ç‡ç¼ºå°‘currency_id:', rate);
            return;
        }
        if (!currencyGroups[currencyId]) {
            currencyGroups[currencyId] = [];
        }
        currencyGroups[currencyId].push(rate);
    });
    
    console.log('[é¢å€¼æ±‡ç‡] æŒ‰å¸ç§åˆ†ç»„:', currencyGroups);
    
    // å¤„ç†æ¯ä¸ªå¸ç§çš„é¢å€¼æ±‡ç‡ï¼Œå®ç°å¸ç§åˆ†ç»„æ˜¾ç¤º
    let allMergedRates = [];
    let globalIndex = 0;
    
    for (const currencyId in currencyGroups) {
        const currencyRates = currencyGroups[currencyId];
        
        // æŒ‰é¢å€¼å¤§å°æ’åºï¼ˆä»å¤§åˆ°å°ï¼‰
        const sortedRates = currencyRates.sort((a, b) => {
            const aValue = parseFloat(a.denomination_value) || 0;
            const bValue = parseFloat(b.denomination_value) || 0;
            return bValue - aValue;
        });
        
        // åˆå¹¶ç›¸åŒæ±‡ç‡çš„ç›¸é‚»é¢å€¼
        const mergedRates = mergeDenominationRates(sortedRates);
        
        // ä¸ºæ¯ä¸ªåˆå¹¶åçš„é¢å€¼ç»„æ·»åŠ ç´¢å¼•ä¿¡æ¯
        mergedRates.forEach((rateGroup, groupIndex) => {
            rateGroup.global_index = globalIndex++;
            rateGroup.is_first_of_currency = groupIndex === 0; // æ ‡è®°æ˜¯å¦ä¸ºè¯¥å¸ç§çš„ç¬¬ä¸€è¡Œ
        });
        
        allMergedRates = allMergedRates.concat(mergedRates);
    }
    
    console.log('[é¢å€¼æ±‡ç‡] æ‰€æœ‰åˆå¹¶åçš„é¢å€¼æ±‡ç‡:', allMergedRates);
    
    // è®¡ç®—åˆ†é¡µä¿¡æ¯
    totalPages = Math.ceil(allMergedRates.length / CONFIG.itemsPerPage);
    console.log('[é¢å€¼æ±‡ç‡åˆ†é¡µ] æ€»è¡Œæ•°:', allMergedRates.length, 'æ¯é¡µ:', CONFIG.itemsPerPage, 'æ€»é¡µæ•°:', totalPages);
    
    // è·å–å½“å‰é¡µçš„æ•°æ®
    const start = (currentPage - 1) * CONFIG.itemsPerPage;
    const end = start + CONFIG.itemsPerPage;
    const currentPageRates = allMergedRates.slice(start, end);
    
    console.log('[é¢å€¼æ±‡ç‡åˆ†é¡µ] å½“å‰é¡µ:', currentPage, 'æ˜¾ç¤ºè¡Œæ•°:', currentPageRates.length);
    
    // æ›´æ–°é¡µé¢æ˜¾ç¤º
    elements.displayPage.textContent = `${currentPage}/${totalPages}`;
    
    // æ¸²æŸ“å½“å‰é¡µçš„é¢å€¼æ±‡ç‡
    currentPageRates.forEach((rateGroup, index) => {
        const row = document.createElement("div");
        row.className = `rate-row ${index % 2 === 1 ? "even-row" : ""}`;
        
        // éªŒè¯é¢å€¼æ±‡ç‡ç»„æ•°æ®
        if (!rateGroup.denominations || rateGroup.denominations.length === 0) {
            console.warn('[é¢å€¼æ±‡ç‡] è·³è¿‡æ— æ•ˆçš„é¢å€¼ç»„æ•°æ®:', rateGroup);
            return;
        }
        
        // å¼ºåˆ¶åº”ç”¨æ ·å¼
        row.style.display = 'grid';
        row.style.gridTemplateColumns = '2.0fr 1.5fr 1.4fr 1.4fr';
        
        // æ ¼å¼åŒ–é¢å€¼èŒƒå›´æ˜¾ç¤º
        const denominationRange = formatDenominationRange(rateGroup.denominations);
        const translations = getDenominationTranslations(currentLanguage);
        const denominationType = rateGroup.denomination_type === 'bill' ? translations.bill : translations.coin;
        
        // å¸ç§å›¾æ ‡
        let flagSrc;
        if (rateGroup.custom_flag_filename) {
            flagSrc = `${baseUrl}/flags/${rateGroup.custom_flag_filename}`;
        } else if (rateGroup.flag_code) {
            flagSrc = `${baseUrl}/flags/${rateGroup.flag_code.toLowerCase()}.svg`;
        } else {
            flagSrc = `${baseUrl}/flags/unknown.svg`;
        }
        
        const fallbackSrc = `${baseUrl}/images/chart-placeholder.svg`;
        
        // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨ä¸æ ‡å‡†æ±‡ç‡ç›¸åŒçš„å¤šè¯­è¨€æœºåˆ¶
        let currencyName = rateGroup.currency_name; // é»˜è®¤åç§°ï¼ˆå‘åå…¼å®¹ï¼‰
        console.log(`[é¢å€¼æ±‡ç‡å¸ç§æ¸²æŸ“] ${rateGroup.currency_code}:`);
        console.log(`  é»˜è®¤åç§°: ${rateGroup.currency_name}`);
        console.log(`  å¤šè¯­è¨€æ•°æ®:`, rateGroup.currency_names);
        console.log(`  å½“å‰è¯­è¨€: ${currentLanguage}`);
        
        if (rateGroup.currency_names && rateGroup.currency_names[currentLanguage]) {
            currencyName = rateGroup.currency_names[currentLanguage];
            console.log(`  âœ… æ‰¾åˆ°${currentLanguage}è¯­è¨€æ˜ å°„: ${currencyName}`);
        } else {
            console.log(`  âŒ æ— ${currentLanguage}è¯­è¨€æ˜ å°„ï¼Œä½¿ç”¨é»˜è®¤: ${currencyName}`);
        }
        
        // æ ¹æ®æ˜¯å¦ä¸ºè¯¥å¸ç§çš„ç¬¬ä¸€è¡Œæ¥å†³å®šå¸ç§åˆ—çš„æ˜¾ç¤ºå†…å®¹
        const currencyCellContent = rateGroup.is_first_of_currency ? `
            <div class="flag-container">
                <img src="${flagSrc}" alt="${rateGroup.currency_code}" class="flag-icon" onerror="this.src='${fallbackSrc}'">
            </div>
            <div class="currency-info">
                <div class="currency-code">${rateGroup.currency_code}</div>
                <div class="currency-name">${currencyName}</div>
            </div>
        ` : `
            <div class="currency-info">
                <div class="currency-code">&nbsp;</div>
                <div class="currency-name">&nbsp;</div>
            </div>
        `;
        
        row.innerHTML = `
            <div class="currency-cell">
                ${currencyCellContent}
            </div>
            <div class="denomination-cell">
                <div class="denomination-range">${denominationRange}</div>
                <div class="denomination-type">${denominationType}</div>
            </div>
            <div class="rate-cell buy-cell">
                ${rateGroup.buy_rate && rateGroup.buy_rate > 0 ? `<span class="rate-value">${formatRate(rateGroup.buy_rate)}</span>` : '<span class="no-rate">-</span>'}
            </div>
            <div class="rate-cell sell-cell">
                ${rateGroup.sell_rate && rateGroup.sell_rate > 0 ? `<span class="rate-value">${formatRate(rateGroup.sell_rate)}</span>` : '<span class="no-rate">-</span>'}
            </div>
        `;
        elements.ratesTableBody.appendChild(row);
    });
    
    // è¡¥å……ç©ºè¡Œåˆ°æŒ‡å®šè¡Œæ•°
    const currentRowCount = currentPageRates.length;
    const targetRowCount = CONFIG.itemsPerPage;
    
    for (let i = currentRowCount; i < targetRowCount; i++) {
        const emptyRow = document.createElement("div");
        emptyRow.className = `rate-row empty-row ${i % 2 === 1 ? "even-row" : ""}`;
        
        // å¼ºåˆ¶åº”ç”¨æ ·å¼
        emptyRow.style.display = 'grid';
        emptyRow.style.gridTemplateColumns = '2.0fr 1.5fr 1.4fr 1.4fr';
        
        emptyRow.innerHTML = `
            <div class="currency-cell">
                <div class="currency-info">
                    <div class="currency-code">&nbsp;</div>
                    <div class="currency-name">&nbsp;</div>
                </div>
            </div>
            <div class="denomination-cell" style="background: rgba(255, 255, 0, 0.1);">
                <div class="denomination-range">&nbsp;</div>
                <div class="denomination-type">&nbsp;</div>
            </div>
            <div class="rate-cell buy-cell">
                <span class="no-rate">&nbsp;</span>
            </div>
            <div class="rate-cell sell-cell">
                <span class="no-rate">&nbsp;</span>
            </div>
        `;
        elements.ratesTableBody.appendChild(emptyRow);
    }
    
    // é¡µé¢ä¿¡æ¯å·²åœ¨åˆ†é¡µè®¡ç®—ä¸­æ›´æ–°ï¼Œä¸éœ€è¦é‡ç½®
    
    // å¼ºåˆ¶åº”ç”¨èƒŒæ™¯è‰²æ ·å¼
    setTimeout(() => {
        applyDenominationBackgroundStyles();
    }, 100);
    
    console.log('[é¢å€¼æ±‡ç‡] é¢å€¼æ±‡ç‡æ˜¾ç¤ºå®Œæˆï¼ŒåŸå§‹é¢å€¼:', denominationRates.length, 'ä¸ªï¼Œåˆå¹¶å:', allMergedRates.length, 'ç»„');
    
    // ğŸ”§ ä¿®å¤ï¼šè®¾ç½®å…¨å±€å˜é‡ä»¥ä¾¿ç¿»é¡µå®šæ—¶å™¨ä½¿ç”¨
    window.currentDisplayMode = 'denomination';
    window.currentDenominationData = data;
    window.currentTheme = theme;
    
    // ğŸ”§ ä¿®å¤ï¼šå¯åŠ¨å®šæ—¶å™¨ï¼ˆåŒ…æ‹¬ç¿»é¡µå®šæ—¶å™¨ï¼‰
    startTimers();
}

// åˆå¹¶ç›¸åŒæ±‡ç‡çš„ç›¸é‚»é¢å€¼
function mergeDenominationRates(sortedRates) {
    if (sortedRates.length === 0) return [];
    
    const merged = [];
    let currentGroup = {
        denominations: [sortedRates[0]],
        buy_rate: sortedRates[0].buy_rate,
        sell_rate: sortedRates[0].sell_rate,
        denomination_type: sortedRates[0].denomination_type,
        // ä¿ç•™å¸ç§ä¿¡æ¯
        currency_id: sortedRates[0].currency_id,
        currency_code: sortedRates[0].currency_code,
        currency_name: sortedRates[0].currency_name,
        flag_code: sortedRates[0].flag_code,
        custom_flag_filename: sortedRates[0].custom_flag_filename
    };
    
    for (let i = 1; i < sortedRates.length; i++) {
        const current = sortedRates[i];
        
        // æ£€æŸ¥æ˜¯å¦å¯ä»¥åˆå¹¶ï¼šç›¸åŒç±»å‹ã€ç›¸åŒæ±‡ç‡
        if (current.denomination_type === currentGroup.denomination_type &&
            Math.abs(current.buy_rate - currentGroup.buy_rate) < 0.0001 &&
            Math.abs(current.sell_rate - currentGroup.sell_rate) < 0.0001) {
            // å¯ä»¥åˆå¹¶ï¼Œæ·»åŠ åˆ°å½“å‰ç»„
            currentGroup.denominations.push(current);
        } else {
            // ä¸èƒ½åˆå¹¶ï¼Œä¿å­˜å½“å‰ç»„å¹¶å¼€å§‹æ–°ç»„
            merged.push(currentGroup);
            currentGroup = {
                denominations: [current],
                buy_rate: current.buy_rate,
                sell_rate: current.sell_rate,
                denomination_type: current.denomination_type,
                // ä¿ç•™å¸ç§ä¿¡æ¯
                currency_id: current.currency_id,
                currency_code: current.currency_code,
                currency_name: current.currency_name,
                flag_code: current.flag_code,
                custom_flag_filename: current.custom_flag_filename
            };
        }
    }
    
    // æ·»åŠ æœ€åä¸€ä¸ªç»„
    merged.push(currentGroup);
    
    return merged;
}

// æ ¼å¼åŒ–é¢å€¼èŒƒå›´æ˜¾ç¤º
function formatDenominationRange(denominations) {
    if (denominations.length === 1) {
        return formatDenominationValue(denominations[0].denomination_value);
    } else {
        const maxValue = Math.max(...denominations.map(d => d.denomination_value));
        const minValue = Math.min(...denominations.map(d => d.denomination_value));
        return `${formatDenominationValue(maxValue)}-${formatDenominationValue(minValue)}`;
    }
}

// æ ¼å¼åŒ–é¢å€¼æ˜¾ç¤º
function formatDenominationValue(value) {
    // ç¡®ä¿valueæ˜¯æ•°å­—ç±»å‹
    const numValue = parseFloat(value);
    if (isNaN(numValue)) {
        return '0';
    }
    if (numValue >= 1) {
        return numValue.toFixed(0);
    } else {
        return numValue.toFixed(2);
    }
}

// ä¸è¦åœ¨é¡µé¢åŠ è½½æ—¶å°±è®¾ç½®è¯­è¨€ï¼Œè®©APIæ•°æ®å†³å®šè¯­è¨€

// ğŸ”§ æ·»åŠ æ–‡ä»¶åè®®è‡ªåŠ¨è·³è½¬æ£€æµ‹
window.addEventListener("load", function() {
    // æ£€æµ‹æ˜¯å¦é€šè¿‡file://åè®®è®¿é—®
    if (window.location.protocol === 'file:') {
        console.log('[è‡ªåŠ¨è·³è½¬] æ£€æµ‹åˆ°file://åè®®è®¿é—®ï¼Œå‡†å¤‡è‡ªåŠ¨è·³è½¬');
        
        // æ„å»ºHTTPæœåŠ¡å™¨URL
        const httpUrl = `http://192.168.13.56:5001/static/Show.html?branch=${CONFIG.branchCode}`;
        
        // æ˜¾ç¤ºè·³è½¬æç¤º
        updateStatus(`æ£€æµ‹åˆ°é€šè¿‡æ–‡ä»¶ç³»ç»Ÿè®¿é—®ï¼Œ3ç§’åè‡ªåŠ¨è·³è½¬åˆ°HTTPæœåŠ¡å™¨...<br/><br/>å¦‚æœæœªè‡ªåŠ¨è·³è½¬ï¼Œè¯·ç‚¹å‡»ï¼š<a href="${httpUrl}" style="color: #fff; text-decoration: underline;">${httpUrl}</a>`, true);
        
        // 3ç§’åè‡ªåŠ¨è·³è½¬
        setTimeout(() => {
            console.log('[è‡ªåŠ¨è·³è½¬] æ‰§è¡Œè·³è½¬åˆ°:', httpUrl);
            window.location.href = httpUrl;
        }, 3000);
        
        return; // ä¸æ‰§è¡Œåç»­çš„attemptFetch
    }
    
    // æ­£å¸¸HTTPè®¿é—®ï¼Œæ‰§è¡ŒåŸæœ‰é€»è¾‘
    attemptFetch();
});
setInterval(refreshData, CONFIG.refreshInterval);
</script>
</body>
</html> 