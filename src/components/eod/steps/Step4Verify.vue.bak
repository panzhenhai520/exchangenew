<template>
  <div class="step-content">
    <div class="step-header mb-4">
      <p class="text-muted">{{ $t('eod.step4.description') }}</p>
    </div>

    <div v-if="!verificationData" class="text-center py-4">
      <button 
        class="btn btn-primary"
        @click="verifyBalance"
        :disabled="loading || isVerifying"
      >
        <span v-if="isVerifying">
          <span class="spinner-border spinner-border-sm me-2" role="status"></span>
          {{ $t('eod.step4.verifying') }}
        </span>
        <span v-else>
          <font-awesome-icon :icon="['fas', 'balance-scale']" class="me-2" />
          {{ $t('eod.step4.start_verify') }}
        </span>
      </button>
    </div>

    <div v-else>
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h6 class="mb-0">{{ $t('eod.step4.verification_result') }}</h6>
          <div>
            <span class="badge me-2" :class="allMatched ? 'bg-success' : 'bg-warning'">
              {{ allMatched ? $t('eod.step4.all_matched') : $t('eod.step4.has_differences') }}
            </span>
            <span class="badge bg-info">{{ verificationData?.verification_results?.length || 0 }} {{ $t('eod.step4.currencies_unit') }}</span>
          </div>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead class="table-dark-custom">
                <tr>
                  <th>{{ $t('eod.step4.table_header.currency') }}</th>
                  <th class="text-end">{{ $t('eod.step4.table_header.theoretical_balance') }}</th>
                  <th class="text-end">{{ $t('eod.step4.table_header.actual_balance') }}</th>
                  <th class="text-end">{{ $t('eod.step4.table_header.difference') }}</th>
                  <th class="text-center">{{ $t('eod.step4.table_header.verification_result') }}</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="result in verificationData.verification_results" :key="result.currency_id">
                  <td>
                    <div class="d-flex align-items-center">
                                              <currency-flag :code="result.currency_code || 'USD'" class="me-2" />
                      <div>
                        <strong>{{ result.currency_code }}</strong>
                        <span class="text-muted small ms-2">{{ getCurrencyName(result.currency_code) }}</span>
                      </div>
                    </div>
                  </td>
                  <td class="text-end">{{ formatAmount(result.theoretical_balance) }}</td>
                  <td class="text-end">{{ formatAmount(result.actual_balance) }}</td>
                  <td class="text-end" :class="getDifferenceClass(result.difference)">
                    {{ formatDifference(result.difference) }}
                  </td>
                  <td class="text-center">
                    <span v-if="result.is_match" class="badge bg-success">
                      <font-awesome-icon :icon="['fas', 'check']" class="me-1" />
                      {{ $t('eod.step4.matched') }}
                    </span>
                    <span v-else class="badge bg-danger">
                      <font-awesome-icon :icon="['fas', 'times']" class="me-1" />
                      {{ $t('eod.step4.mismatched') }}
                    </span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- 核对统计 -->
          <div class="row mt-4">
            <div class="col-md-4">
              <div class="card bg-light" style="height: 60px;">
                <div class="card-body d-flex align-items-center justify-content-center py-2">
                  <h5 class="text-success mb-0 me-2">{{ matchedCount }}</h5>
                  <span class="mb-0">{{ $t('eod.step4.matched_currencies') }}</span>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card bg-light" style="height: 60px;">
                <div class="card-body d-flex align-items-center justify-content-center py-2">
                  <h5 class="text-danger mb-0 me-2">{{ mismatchedCount }}</h5>
                  <span class="mb-0">{{ $t('eod.step4.mismatched_currencies') }}</span>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card bg-light" style="height: 60px;">
                <div class="card-body d-flex align-items-center justify-content-center py-2">
                  <h5 class="text-info mb-0 me-2">{{ verificationData?.verification_results?.length || 0 }}</h5>
                  <span class="mb-0">{{ $t('eod.step4.total_currencies') }}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- 核对说明 -->
          <div v-if="!allMatched" class="alert alert-warning mt-4">
            <h6 class="alert-heading">
              <font-awesome-icon :icon="['fas', 'exclamation-triangle']" class="me-2" />
              {{ $t('eod.step4.balance_differences_found') }}
            </h6>
            <p class="mb-2">{{ $t('eod.step4.differences_detected_message', { count: mismatchedCount }) }}</p>
            <p class="mb-0">{{ $t('eod.step4.adjustment_suggestion') }}</p>
          </div>

          <!-- 差额处理选择 -->
          <div v-if="!allMatched" class="card mt-4">
            <div class="card-header">
              <h6 class="mb-0">
                <font-awesome-icon :icon="['fas', 'cogs']" class="me-2" />
                {{ $t('eod.step4.difference_handling') }}
              </h6>
            </div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-4">
                  <div class="d-grid">
                    <button 
                      class="btn btn-outline-danger"
                      @click="handleDifferenceAction('cancel')"
                      :disabled="loading || isVerifying"
                    >
                      <font-awesome-icon :icon="['fas', 'times-circle']" class="me-2" />
                      {{ $t('eod.step4.cancel_eod') }}
                    </button>
                    <small class="text-muted mt-1">{{ $t('eod.step4.cancel_eod_desc') }}</small>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="d-grid">
                    <button 
                      class="btn btn-outline-warning"
                      @click="handleDifferenceAction('force')"
                      :disabled="loading || isVerifying"
                    >
                      <font-awesome-icon :icon="['fas', 'exclamation-triangle']" class="me-2" />
                      {{ $t('eod.step4.force_continue') }}
                    </button>
                    <small class="text-muted mt-1">{{ $t('eod.step4.force_continue_desc') }}</small>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="d-grid">
                    <button 
                      class="btn btn-outline-primary"
                      @click="handleDifferenceAction('adjust')"
                      :disabled="loading || isVerifying"
                    >
                      <font-awesome-icon :icon="['fas', 'balance-scale']" class="me-2" />
                      {{ $t('eod.step4.adjust_difference') }}
                    </button>
                    <small class="text-muted mt-1">{{ $t('eod.step4.adjust_difference_desc') }}</small>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div v-else class="alert alert-success mt-4">
            <h6 class="alert-heading">
              <font-awesome-icon :icon="['fas', 'check-circle']" class="me-2" />
              {{ $t('eod.step4.verification_passed') }}
            </h6>
            <p class="mb-0">{{ $t('eod.step4.all_balanced_message') }}</p>
          </div>

          <div class="d-flex justify-content-end mt-4">
            <button 
              class="btn btn-outline-secondary me-2"
              @click="reverify"
              :disabled="loading || isVerifying"
            >
              <font-awesome-icon :icon="['fas', 'sync']" class="me-1" />
              {{ $t('eod.step4.reverify') }}
            </button>
            <button 
              v-if="allMatched"
              class="btn btn-success"
              @click="proceedToNext"
              :disabled="loading || isVerifying"
            >
              <span v-if="isVerifying">
                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                {{ t('eod.step4.processing') }}
              </span>
              <span v-else>
                <font-awesome-icon :icon="['fas', 'check']" class="me-1" />
                {{ $t('eod.step4.complete_verification') }}
              </span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import { ref, computed, onMounted } from 'vue'
import { useI18n } from 'vue-i18n'
import { eodAPI } from '../../../api/eod'
import CurrencyFlag from '../../CurrencyFlag.vue'
import { getCurrencyName } from '@/utils/currencyTranslator'

export default {
  name: 'Step4Verify',
  components: {
    CurrencyFlag
  },
  emits: ['next', 'error'],
  props: {
    eodId: {
      type: [Number, String],
      required: true
    },
    loading: {
      type: Boolean,
      default: false
    }
  },
  setup(props, { emit }) {
    const { t } = useI18n()
    
    // 响应式数据
    const verificationData = ref(null)
    const isVerifying = ref(false)
    
    // 计算属性
    const allMatched = computed(() => {
      if (!verificationData.value?.verification_results) return false
      return verificationData.value.verification_results.every(result => result.is_match)
    })
    
    const matchedCount = computed(() => {
      if (!verificationData.value?.verification_results) return 0
      return verificationData.value.verification_results.filter(result => result.is_match).length
    })
    
    const mismatchedCount = computed(() => {
      if (!verificationData.value?.verification_results) return 0
      return verificationData.value.verification_results.filter(result => !result.is_match).length
    })
    
    // 方法
    const verifyBalance = async () => {
      try {
        isVerifying.value = true
        
        const result = await eodAPI.verifyBalance(props.eodId)
        
        if (result.success) {
          verificationData.value = result
        } else {
          emit('error', result.message || t('eod.step4.verification_failed'))
        }
      } catch (error) {
        console.error('余额核对失败:', error)
        emit('error', error.response?.data?.message || error.message || t('eod.step4.verification_failed'))
      } finally {
        isVerifying.value = false
      }
    }
    
    const reverify = async () => {
      verificationData.value = null
      await verifyBalance()
    }
    
    const proceedToNext = async () => {
      try {
        isVerifying.value = true
        
        // 重新验证余额确保数据最新
        const result = await eodAPI.verifyBalance(props.eodId)
        
        if (result.success) {
          // 等待1秒确保操作完成
          await new Promise(resolve => setTimeout(resolve, 1000))
          
          emit('next', {
            verification_results: result.verification_results,
            all_matched: result.verification_results.every(r => r.is_match),
            step: 5,  // 进入步骤5
            from_api_call: true,  // 标识这是API调用完成
            auto_generate_income_stats: result.verification_results.every(r => r.is_match) // 如果余额一致，自动生成收入统计
          })
        } else {
          emit('error', result.message || t('eod.step4.verification_failed'))
        }
      } catch (error) {
        console.error('完成余额核对失败:', error)
        emit('error', error.response?.data?.message || error.message || t('eod.step4.verification_failed'))
      } finally {
        isVerifying.value = false
      }
    }

    const handleDifferenceAction = async (action) => {
      try {
        isVerifying.value = true
        
        const result = await eodAPI.handleBalanceDifference(props.eodId, action)
        
        if (result.success) {
          if (action === 'cancel') {
            // 取消日结，返回主界面
            emit('cancel', result.message)
          } else if (action === 'force') {
            // 强制继续，进入第5步
            emit('next', {
              verification_results: result.verification_results,
              all_matched: false,
              step: 5,
              from_api_call: true,
              forced_continue: true,
              auto_generate_income_stats: false
            })
          } else if (action === 'adjust') {
            // 差额调节，重新核对
            verificationData.value = result
            if (result.all_match) {
              // 调节后余额一致，进入第5步
              emit('next', {
                verification_results: result.verification_results,
                all_matched: true,
                step: 5,
                from_api_call: true,
                adjusted: true,
                auto_generate_income_stats: true
              })
            }
            // 如果调节后仍有差额，保持在当前界面，用户可以再次选择
          }
        } else {
          emit('error', result.message || t('eod.step4.difference_handling_failed'))
        }
      } catch (error) {
        console.error('差额处理失败:', error)
        emit('error', error.response?.data?.message || error.message || t('eod.step4.difference_handling_failed'))
      } finally {
        isVerifying.value = false
      }
    }
    
    const getDifferenceClass = (difference) => {
      if (difference === 0) return 'text-success'
      if (Math.abs(difference) < 0.01) return 'text-warning'
      return 'text-danger'
    }
    
    const formatAmount = (amount) => {
      if (amount === null || amount === undefined || isNaN(amount)) {
        return '0.00'
      }
      return new Intl.NumberFormat('zh-CN', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(amount)
    }
    
    const formatDifference = (difference) => {
      if (difference === null || difference === undefined || isNaN(difference)) {
        return '0.00'
      }
      if (difference === 0) return '0.00'
      const formatted = formatAmount(Math.abs(difference))
      return difference > 0 ? `+${formatted}` : `-${formatted}`
    }
    
    // 生命周期
    onMounted(() => {
      if (props.eodId) {
        verifyBalance()
      }
    })
    
    return {
      t,
      verificationData,
      isVerifying,
      allMatched,
      matchedCount,
      mismatchedCount,
      verifyBalance,
      reverify,
      proceedToNext,
      handleDifferenceAction,
      getDifferenceClass,
      formatAmount,
      formatDifference,
      getCurrencyName
    }
  }
}
</script>

<style scoped>
.step-content {
  padding: 1rem 0;
}

.step-header h4 {
  color: #495057;
  margin-bottom: 0.5rem;
}

.currency-flag {
  display: inline-block;
  width: 24px;
  height: 18px;
  background: linear-gradient(45deg, #007bff, #0056b3);
  border-radius: 2px;
  text-align: center;
  line-height: 18px;
  color: white;
  font-size: 10px;
  font-weight: bold;
}

.table th {
  border-top: none;
  font-weight: 600;
}

/* 自定义黑色表头样式 */
.table-dark-custom {
  background-color: #212529 !important;
  color: #ffffff !important;
}

.table-dark-custom th {
  background-color: #212529 !important;
  border-color: #32383e !important;
  color: #ffffff !important;
  font-weight: 600;
}

.table-dark-custom th,
.table-dark-custom td {
  border-color: #32383e !important;
}

.card.bg-light {
  border: 1px solid #e9ecef;
}

.badge {
  font-size: 0.75rem;
}
</style> 