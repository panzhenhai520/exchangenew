<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>API Tokenæµ‹è¯•å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 1000px;
            margin: 0 auto;
        }
        h1 { color: #333; }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f9f9f9;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #45a049; }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
            white-space: pre-wrap;
            max-height: 300px;
        }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>ğŸ”§ API Tokenæµ‹è¯•å·¥å…·</h1>

    <div class="section">
        <h3>æµ‹è¯•é…ç½®</h3>
        <label>åç«¯åœ°å€: <input type="text" id="backendUrl" value="http://10.11.32.111:5001" style="width: 300px;"></label>
    </div>

    <div class="section">
        <h3>æ­¥éª¤1: ç™»å½•è·å–Token</h3>
        <button onclick="doLogin()">æ‰§è¡Œç™»å½•</button>
        <div id="loginResult"></div>
    </div>

    <div class="section">
        <h3>æ­¥éª¤2: éªŒè¯Token</h3>
        <button onclick="validateToken()">éªŒè¯Token</button>
        <div id="validateResult"></div>
    </div>

    <div class="section">
        <h3>æ­¥éª¤3: è°ƒç”¨æ±‡ç‡API</h3>
        <button onclick="testRatesAPI()">æµ‹è¯•æ±‡ç‡API</button>
        <div id="ratesResult"></div>
    </div>

    <div class="section">
        <h3>å½“å‰localStorageçŠ¶æ€</h3>
        <button onclick="showStorage()">æ˜¾ç¤ºStorage</button>
        <div id="storageResult"></div>
    </div>

    <script>
        async function doLogin() {
            const resultDiv = document.getElementById('loginResult');
            const backendUrl = document.getElementById('backendUrl').value;
            resultDiv.innerHTML = 'ğŸ”„ æ­£åœ¨ç™»å½•...';

            try {
                const response = await fetch(`${backendUrl}/api/auth/login`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        login_code: 'admin',
                        password: 'admin123',
                        branch_id: 6
                    })
                });

                const data = await response.json();
                console.log('ç™»å½•å“åº”:', data);

                if (response.ok && data.success) {
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    localStorage.setItem('userPermissions', JSON.stringify(data.permissions || []));

                    resultDiv.innerHTML = `
                        <div class="success">âœ… ç™»å½•æˆåŠŸ</div>
                        <div>ç”¨æˆ·: ${data.user.name}</div>
                        <div>è§’è‰²: ${data.user.role_name}</div>
                        <div>Tokenå‰50ä½: ${data.token.substring(0, 50)}...</div>
                        <div>æƒé™æ•°é‡: ${data.permissions.length}</div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="error">âŒ ç™»å½•å¤±è´¥</div><pre>${JSON.stringify(data, null, 2)}</pre>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">âŒ è¯·æ±‚å¤±è´¥: ${error.message}</div>`;
            }
        }

        async function validateToken() {
            const resultDiv = document.getElementById('validateResult');
            const backendUrl = document.getElementById('backendUrl').value;
            const token = localStorage.getItem('token');

            if (!token) {
                resultDiv.innerHTML = '<div class="error">âŒ Tokenä¸å­˜åœ¨,è¯·å…ˆç™»å½•</div>';
                return;
            }

            resultDiv.innerHTML = 'ğŸ”„ éªŒè¯ä¸­...';

            try {
                console.log('å‘é€TokenéªŒè¯è¯·æ±‚...');
                console.log('Token:', token.substring(0, 50) + '...');
                console.log('Authorization header:', `Bearer ${token}`);

                const response = await fetch(`${backendUrl}/api/auth/validate-token`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log('å“åº”çŠ¶æ€:', response.status);
                const data = await response.json();
                console.log('å“åº”æ•°æ®:', data);

                if (response.ok && data.success) {
                    resultDiv.innerHTML = `
                        <div class="success">âœ… TokenéªŒè¯æˆåŠŸ</div>
                        <div>ç”¨æˆ·ID: ${data.user.id}</div>
                        <div>ç”¨æˆ·å: ${data.user.name}</div>
                        <div>æƒé™æ•°é‡: ${data.permissions.length}</div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="error">âŒ éªŒè¯å¤±è´¥ (${response.status})</div><pre>${JSON.stringify(data, null, 2)}</pre>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">âŒ è¯·æ±‚å¤±è´¥: ${error.message}</div>`;
            }
        }

        async function testRatesAPI() {
            const resultDiv = document.getElementById('ratesResult');
            const backendUrl = document.getElementById('backendUrl').value;
            const token = localStorage.getItem('token');

            if (!token) {
                resultDiv.innerHTML = '<div class="error">âŒ Tokenä¸å­˜åœ¨,è¯·å…ˆç™»å½•</div>';
                return;
            }

            resultDiv.innerHTML = 'ğŸ”„ è°ƒç”¨ä¸­...';

            try {
                console.log('=== è°ƒç”¨æ±‡ç‡API ===');
                console.log('URL:', `${backendUrl}/api/rates/available_currencies`);
                console.log('Token:', token.substring(0, 50) + '...');
                console.log('Authorization:', `Bearer ${token}`);

                const response = await fetch(`${backendUrl}/api/rates/available_currencies`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log('å“åº”çŠ¶æ€:', response.status);
                const data = await response.json();
                console.log('å“åº”æ•°æ®:', data);

                if (response.ok) {
                    if (data.success) {
                        resultDiv.innerHTML = `
                            <div class="success">âœ… APIè°ƒç”¨æˆåŠŸ</div>
                            <div>è´§å¸æ•°é‡: ${data.currencies ? data.currencies.length : 0}</div>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        `;
                    } else {
                        resultDiv.innerHTML = `
                            <div class="error">âš ï¸ APIè¿”å›success=false</div>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        `;
                    }
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">âŒ APIè°ƒç”¨å¤±è´¥ (${response.status})</div>
                        <div>è¿™è¡¨ç¤ºTokenéªŒè¯å¤±è´¥!</div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">âŒ è¯·æ±‚å¤±è´¥: ${error.message}</div>`;
            }
        }

        function showStorage() {
            const resultDiv = document.getElementById('storageResult');
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');
            const permissions = localStorage.getItem('userPermissions');

            let html = '';
            html += `<div><strong>Token:</strong> ${token ? 'âœ… ' + token.substring(0, 50) + '...' : 'âŒ ä¸å­˜åœ¨'}</div>`;
            html += `<div><strong>User:</strong> ${user ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}</div>`;
            html += `<div><strong>Permissions:</strong> ${permissions ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨'}</div>`;

            if (user) {
                try {
                    const userObj = JSON.parse(user);
                    html += `<pre>User:\n${JSON.stringify(userObj, null, 2)}</pre>`;
                } catch (e) {
                    html += `<div class="error">Userè§£æå¤±è´¥: ${e.message}</div>`;
                }
            }

            if (permissions) {
                try {
                    const perms = JSON.parse(permissions);
                    html += `<div><strong>æƒé™æ•°é‡:</strong> ${perms.length}</div>`;
                    html += `<pre>Permissions:\n${JSON.stringify(perms, null, 2)}</pre>`;
                } catch (e) {
                    html += `<div class="error">Permissionsè§£æå¤±è´¥: ${e.message}</div>`;
                }
            }

            resultDiv.innerHTML = html;
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºstorage
        window.onload = () => {
            showStorage();
        };
    </script>
</body>
</html>
