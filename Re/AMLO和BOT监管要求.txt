一、系统是多网点的系统，所有数据表要记录当前网点，当前网点是在用户登录的时候选择的，登录后数据存入本地 localstorage，其中包含网点编号，网点的基础货币（本币）信息。

1.1 所有的新增功能，都要基于网点进行记录，新增的表格，报告，都需要有网点字段，统计查询，条件设置都要基于当前用户所登录的网点进行设置和查询，没有网点信息会造成查询结果混乱。

1.2 总的功能要求：中文，英文，泰文 三种语言的支持，所有新增功能的UI中的文字信息，无论是在新的一页上还是在原来的页面上，需要延续原有的结构化的多语言翻译配置文件进行配置。置于 src/i18n/modules/新模块 下，采用多语言键值结构化管理；后端也保留枚举/状态多语言键，前端渲染时转换。生成的AMOL报告，BOT报告，都有三种版本，要充分考虑数据库设计时要支持字段名称有三种语言，report_fields表定义的字段一定要覆盖所有AMOL和BOT报表中的字段。


二、基础数据
2.1 参考รายงาน ปปง 1-01 ซื้อขายเกิน 500,000 บาท ยกเว้นเงินบาทแลก.pdf,รายงาน ปปง 1-02 ซื้อขายเกิน 800,000 บาท ยกเว้นเงินบาทแลก.pdf,รายงาน ปปง 1-03  ซื้อขายระหว่างนิติบุคลล.pdf 的三种pdf报表的内容和BOT_BuyFX 、BOT_SellFX、BOT_Provider、BOT_Provider四张截图报表的内容 完成。

由于要生成上述这些报表，所以需要进行mysql数据库的表结构设计，在原来数据库表基础上需要新增加相应的表，用于保存这些pdf中需要显示的内容。每一种报告需要填写的字段具体参见 รายงาน ปปง 1-01 ซื้อขายเกิน 500,000 บาท ยกเว้นเงินบาทแลก.pdf,รายงาน ปปง 1-02 ซื้อขายเกิน 800,000 บาท ยกเว้นเงินบาทแลก.pdf,รายงาน ปปง 1-03  ซื้อขายระหว่างนิติบุคลล.pdf、BOT_BuyFX 、BOT_SellFX、BOT_Provider、BOT_Provider的填写字段，你要进行分析和综合，最后新增一张report_fields表用于记录覆盖这些报告中的所有字段信息，字段名，字段类型，字段长度，字段中文名，英文名，泰语名，填写顺序，是否必填，报告类型（1-01.pdf,1-02.pdf,1-03.pdf、BOT_BuyFX 、BOT_SellFX、BOT_Provider、BOT_Provider）。注意，某些字段可能适用于多个报告例如姓名，证件号，交易流水号等，很可能每个报告都需要填写。在需要时要能够根据【报告类型】和填写顺序提取对应的字段构造填写表单，供用户输入保存。

2.2 兑换时根据报告类型，提取report_fields表中对应该报告需要填写的字段，根据设定的填写顺序，自动生成填写表单，填写后用于生成对应的报告pdf文件，表单中的数据需要写入到一张新的 Report_Check 表中，并且严格按照1-01,1-02,1-03的pdf格式生成对应的pdf文件，用于审计这笔交易。这个兑换审核任务表除了有pdf定义中的填写字段外，还需要包含下面的固定字段（如果report_fields中有定义则忽略）：
报告流水号、交易流水号、交易日期、兑换类型（包含，普通兑换，大额兑换，房产抵押兑换）
根据兑换类型，写入相应的用户信息,包括：1.普通兑换只写入姓名、证件、电话；    2.大额兑换还要写 职业、工作单位、联系地址、证件有效期；3.金额、4.币种、5.报告类型 (1-01、1-02、1-03）、6.操作员、7.操作日期、8.审核人员、9.审核日期、10.当前状态（待审批 / 已上报 / 驳回）

三、增加功能 A,B,C,D

-------------------------------------------------------------------------
功能A：

在原来【规范管理】页面的 【余额报警】 后面需要新增【交易报告】页面，在交易报告中可以新增和维护 交易报告类型、定义触发报告的条件。目前默认新增三种报告类型：
CTR（现金交易报告, ปปง.1-01），ATR（资产交易报告, ปปง.1-02），STR（可疑交易报告, ปปง.1-03)。每一种报告都可以维护和修改报告的名称，触发的条件，根据报告类型，结合report_fields表就能得到需要填写的字段有哪些，例如：
CTR报告： 金额大于等于500万的，必须填写CTR报告，报告格式1-01. 
ATR报告：金额大于等于800万的，必须填写ATR报告。报告格式1-02.
STR报告： 在交易时被勾选了可疑的，必须触发 STR报告，报告格式1-03.
怎么判断可疑：输入兑换人证件信息后，自动检查兑换人历史兑换信息，总共兑换了多少次，兑换的总金额是多少。
                         然后去匹配触发条件：符合兑换频率定义的(一个月几次或一年几次), 金额符合（总的兑换金额大于多少阈值），资金来源为 【抵押房产】或【变卖土地】的，触发STR报告。              
注意：上述条件需要设计为自定义的，可以选择字段，使用并且，或者 ，大于，小于，等于等 阈值组合条件来对多个字段进行组合。也就是能设置report_fields表中的字段的各种组合条件，
用于监控是否命中了触发报告的条件。

-------------------------------------------------------------------------
功能B：

1.普通兑换中，输入兑换人证件信息后，需要自动检查兑换人历史兑换信息。系统需要调用 【触发报告检查的 api】 判断是否需要填写报告。为了这个目的，需要有一个传入用户证件号或企业税号能查询兑换历史记录的API。
这个API返回 需要填写报告/已填写报告/不需要填写报告，如果是已经填写报告，还需要返回报告的审核状态( 已上报，待审核，审核通过，被驳回 )，如果是不需要填写报告返回0

2.如果同一个人多次兑换，兑换的金额合计超过了 指定的阈值的本币时，需要自动标记为可疑，并给出提示信息为【该用户累加兑换超过了   元，应填报1-03报告】，并根据【是否允许继续兑换】的设置决定是否继续完成交易。

3.不管是按【面值兑换】还是【标准兑换】，当兑换计算出的本币金额大于200万时，在页面上自动显示【兑换类型】（必填），默认填入【大额兑换】 （兑换类型分为大额兑换，资产抵押兑换），如果选择了资产抵押兑换，需要在按照资产抵押兑换的报告要求，填写资产抵押兑换报告需要填报的字段（不动产详情）具体根据report_fields表中的报告类型，生成填报表单Repform。

4，兑换信息命中了【规范管理】-【交易报告】中定义的阈值组合条件的（参见功能A的定义），只进行试算，不进行实际的兑换，而是另外走新的分支流程，弹出【兑换预约】页面，根据自动生成的填报表单Repform，填写相关信息，生成pdf报告，并且完成预约。例如：命中大额兑换的，需要在普通兑换基础上增加扩展填写字段（职业、工作单位、联系地址、证件有效期，资金来源）。（资金来源表可以自己维护【默认请加入抵押房产，变卖土地，其他三种】）具体需要填写的内容要参考1-01,1-02,1-03中报告的内容。

5.完成兑换预约后，预约信息存到新的兑换预约表 Reserved_Transaction 。这张Reserved_Transaction表需要记录用户的兑换交易需求，外币种类，兑换方向，兑换金额，成为【功能C】的审核内容 (见功能C说明)

6.在面值兑换或标准兑换输入客户信息的页面上，输入用户身份证号码或企业税号之后，系统调用 【触发报告检查的API】，判断返回值：
   6.1 如果返回值=0表示不需要填写报告，不触发AMLO报告逻辑，则按常规流程继续结算打印收据。
   6.2 如果是需要填写报告，且审核状态不等于已审核的，则出现【预约审核情况】显示审核状态（已上报，待审核，被驳回 ）这些状态属于不能继续完成的兑换，提示后终止兑换。
   6.3 如果是需要填写报告，且审核状态等于【已审核】的，则可以调出功能C 中审核完成的信息，检查本次交易是否符合之前预约兑换的金额。（符合：兑换的金额小于等于审批同意的金额，不符合：本次兑换的金额大于审批同意的金额），符合的可以继续完成交易，正常写入交易流水记录，并且新增写入【兑换类型】，【审批流水号】字段，根据审批流水号，能查看该审批流水号对应的审批记录。完成兑换的预约兑换，都是大额交易，根据报告类型，立即静默生成完全匹配1-01,1-02,1-03的格式的pdf文件，pdf文件名为：审计流水号_check.pdf，写入一张AMOLReport表，表中存以下字段：
预约兑换表ID（Reserved_Transaction表的唯一ID), pdf文件名，创建时间，是否上报，交易时间，报告类型（CTR/ATR/STR），上报时间,

----------------------------------------------------------------------------

功能C：

1.在主菜单中新增 【AMLO审计】菜单，使用权限是 网点管理员，下拉【预约兑换审核】、【AMOL报告】功能
【预约兑换审核】可以查询兑换审核任务表Reserved_Transaction表，进行审核。Reserved_Transaction表 存储了所有命中了【规范管理】-【交易报告】设置的条件的预约兑换交易信息，（默认一个时间条件：从当日到一个月前的期间） 供管理员审核。审核时能根据填写的Repform表单内容，补充填写相关信息，做出审核结果的标记（已审核，被驳回）
另外，用户信息，pdf文件名、预约兑换的交易方向，交易金额等信息都在Reserved_Transaction表中，在审计页面中可以对这些关键信息进行查询，页面需要有【历史交易】按钮，查询该用户的所有历史交易记录。

2.【AMLO审计】页面中的的预约兑换交易记录，其状态可以设置为【待审批 /已审核 /被驳回/已交易/已上报】五种。兑换界面输入Repform表单信息后，产生的就是待审批记录Reserved_Transaction，表里最先记录输入表单时的时间，这个时间就是报告时间。待审批可以转为 已审核，或被驳回，只有状态处于已交易的记录可以改为已上报状态。并记录对应发生状态改变的时间和操作人员，例如，审核时间或驳回时间，交易时间，上报时间，审核人（已审核或被驳回的操作人），上报人等。

3.审核通过的预约兑换记录可以反审核成为待审核状态。记录反审核人，反审核时间。

4.【AMLO报告】功能显示AMLOReport表中的记录，并且用AMLO表中的交易时间和当日日期对比，计算时间差，状态=未上报的记录呈现蓝色，对于时间差超过1天且状态不等于【已上报】的，标记为红色醒目提示【请立即上报】，改为上报状态后，红色消失。

--------------------------------------------------------------------------------


功能D：

首先，需要根据BOT_BuyFX 、BOT_SellFX、BOT_Provider、BOT_Provider几张截图报表，设计相应的表（表名与报表名称相同）用于存放这些表的数据。
另外，这几张表，需要有一个交易流水号用于关联交易流水表的ID(TranscationID)，还需要有BOT生成日期字段（createtime），是否使用FCD账户字段（useFCD）。

主导航菜单增加【合规报告】下拉【报告生成条件】（包括设置生成BOT的条件，生成FCD账户报告的条件）、【T+1上报】、【BOT报告查询】、【FCD报告查询】三个子菜单。
在兑换交易流水表中增加两个int类型字段BOTflag和FCDflag，需要有默认值=0。

1.【报告生成条件】页面，设置合规报告生成的条件 ，条件为：大于指定币种的多少交易金额，则立即生成BOT报表。
有4种条件：
  1.1 用户按买入外币情况下触发填写 BOT_BuyFX 的条件，打印收据之后，需要检查这个触发条件，按指定条件的币种及汇率换算交易金额，
达到触发条件的补充填写更多信息，静默生成BOT_BuyFX报告
  1.2 用户卖出外币情况下触发填写 BOT_SellFX 的条件， 打印收据之后，需要检查这个触发条件，按指定条件的币种及汇率换算交易金额，
达到触发条件的补充填写更多信息，静默生成BOT_SellFX报告
  1.3 网点使用余额调节功能增加外币，触发填写BOT_Provider的条件，确认调节改变库存之前，检查触发条件，按指定条件的币种及汇率换算交易金额，
达到触发条件补充填写更多信息，生成BOT_Provider 报告。
  1.4 交易兑换时，付款方式勾选了FCD账户 ，且 设置FCD账户交易变动金额大于多少币种(例如>5万美元), 时立即提交FCD报告，兑换交易完成后，打印收据之前，按指定条件的币种及汇率换算交易金额，
达到触发条件补充填写更多信息，生成BOT_FCD 报告。

2.兑换结算完成，填写用户信息和备注的页面，需要增加一个勾选项，
对于买入外币的交易来说，勾选项为：是否将交易的外币存入FCD账户。
对于卖出外币的交易来说，勾选项为：交易的外币是否从FCD账户支付。
如果勾选项被选中，且符合填写FCD报告的条件，兑换交易完成后，打印收据之前，需要调用 一个API服务。
API服务的传入参数有四个：
  2.1 是否涉及FCD账户交易，
  2.2 交易方向是买入还是卖出外币
  2.3 交易的本币金额
  2.4 交易验证金额 
        注意交易验证金额不一定=交易的本币金额。要看【报告生成条件】中定义的币种，如果币种就是本币，那么交易验证金额=交易的本币金额，
       如果【报告生成条件】中定义的币种是美金，则需要用交易的本币对美金的汇率，把交易的本币金额换算成美金，才是交易验证金额。

API接收到这4个参数，用于判断是否符合报告生成条件中设置的对应条件，判断方法：
根据买入还是卖出的方向，用交易的验证金额比较BOT_BuyFX条件或BOT_SellFX条件，如果满足条件返回BOTflag=1 
根据是否勾选了FCD账户交易（useFCD），用交易的验证金额比较BOT_FCD条件，如果满足条件返回FCDflag=1

3. 根据API返回的信息，写入交易流水记录时，还需要写入BOTflag和FCDflag字段。如果BOTflag=1,根据买入还是卖出格式，立即静默生成BOT报表，如果FCDflag=1，立即静默生成FCD报表
生成的BOT报表和FCD报表在【T+1上报】菜单打开的页面要能直接看到，页面默认显示BOT和FCD报表的时间条件为：BOT报表，FCD报表的生成时间大于操作当日减一天，小于等于操作当日。
可导出一个多sheet格式EXCE文件，见Re目录下的BOT( Save Excel, PDF, Bot).xlsx。

4.【BOT报告查询】 页面：选择时间段，然后查询在该时间段的所有BOTflag=0 的交易流水，根据买入还是卖出的方向进行汇总，生成BOT_BuyFx,BOT_SellFX报表数据，并写入生成时间和状态(已报，未报）
5.【FCD报告查询】页面：选择时间段，然后查询在该时间段的所有 useFCD=1, 且FCTflag=0 的交易流水，根据买入还是卖出的方向进行汇总。生成BOT_FCD报表数据，并写入生成时间(已报，未报）
6.  状态=未上报的【BOT报告查询】【FCD报告查询】记录颜色呈现蓝色，生成时间 和 当前时间差超过1天且状态不等于【已上报】的，标记为红色醒目提示【请立即上报】，改为上报状态后，红色消失。

--------------------------------------------------------------------------------


补充说明：

1.只有500万和800万两个本币阈值需要填写报告。200万阈值是一个累计出来的阈值，用于标记属于可疑的兑换，阈值是可以自定义的。可以把200万定义成500万就一致了，如果不一致，风控更有层次。
2.同一人累计兑换，是指 证件号相同的兑换。时间窗口需要自定义，内容审核最近__ 月。兑换标按下单时的汇率进行计算。
3.如果兑换的本币金额大于800万，并且选择了资产抵押兑换，则触发1-02.这样的条件要能在报告类型定义触发报告条件的地方设置。
4.预约兑换不计入交易流水和日结库存，也不预占库存。由网点自行入库足够的本币金额，完成兑换。预约兑换的内容不写入交易流水表，写新建的Reserved_Transaction 表。
5.无论是普通兑换还是面值兑换，输入兑换人证件信息之后，除了自动调用API检测是否触发报告条件之外，还应该有一个查询【历史交易】功能，能查询这个用户总共兑换了多少次，每次兑换了多少金额，兑换时间，兑换总额
7.主菜单新增的审计功能，下拉菜单有【预约兑换审核】、【用户交易查询】、【大额交易查询】，预约兑换审核就是【功能C】的描述。 【用户交易查询】是从兑换用户的角度， 输入用户身份证号码或企业税号之后，查询出所有历史交易。【大额交易查询】是从兑换金额的角度，输入兑换金额后，查询出满足兑换金额下限和上限条件的交易查询上述查询的表格记录过多的情况下需要自动分页，并支持跨分页检索。
8.兑换交易要记录当日的序列号，例如7，表示当日第7笔交易，这个在之前的兑换交易流水写入时，没有记录这个序列号，需要增加一个顺序号字段【seqno】，兑换交易完成时补充写入。
9.功能B的AMLO报告 和功能C的 BOT报告，都有在打印收据之前，检查对应的触发条件，判断是否要生成对应的报告，AMLO报告和BOT报告可能会同时产生（例如，BOT报告单笔>2万美金触发，AMOL报告单笔>200万触发，触发生成AMLO报告的兑换交易，一定也会触发生成BOT报告的流程）。
10.根据report_fields表中的报告类型（1-01,1-02,1-03，BOT_SellFX,BOT_BuyFX,BOT_FCD,BOT_Provider）提取字段及定义的顺序，动态生成 Repform 填写表单的逻辑，应该设计为独立的模块和组件，方便在别的项目中调用




