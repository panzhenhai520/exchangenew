# äº¤æ˜“æ–¹å‘å’ŒAMLOè§¦å‘æ¡ä»¶ä¿®å¤

**æ—¥æœŸ**: 2025-10-29
**é—®é¢˜**:
1. äº¤æ˜“æ–¹å‘é€»è¾‘é”™è¯¯ - PDFé‡‘é¢å¡«å†™ä½ç½®é”™è¯¯
2. AMLOè§¦å‘æ¡ä»¶å¼‚å¸¸ - ä¹°å…¥ä»»ä½•é‡‘é¢éƒ½è§¦å‘ï¼Œå–å‡ºåƒä¸‡ä¸è§¦å‘

---

## ä¿®å¤1: äº¤æ˜“æ–¹å‘é€»è¾‘ï¼ˆâœ… å·²å®Œæˆï¼‰

### é—®é¢˜æè¿°
ä¹‹å‰é”™è¯¯åœ°ç†è§£äº† `direction` å­—æ®µçš„å«ä¹‰ï¼Œé”™è¯¯åœ°è¿›è¡Œäº†"åè½¬"æ“ä½œï¼Œå¯¼è‡´ï¼š
- ä¹°å…¥äº¤æ˜“çš„é‡‘é¢å¡«åœ¨å³æ ï¼ˆé”™è¯¯ï¼‰
- å–å‡ºäº¤æ˜“çš„é‡‘é¢å¡«åœ¨å³æ ï¼ˆé”™è¯¯ï¼‰

### æ ¹æœ¬åŸå› 
**ç³»ç»Ÿä»ç½‘ç‚¹è§’åº¦è®¾è®¡**ï¼Œ`direction` å­—æ®µå·²ç»æ˜¯ç½‘ç‚¹è§†è§’ï¼Œä¸éœ€è¦è½¬æ¢ï¼

- `direction='buy'` = ç½‘ç‚¹ä¹°å…¥å¤–å¸ = å¤–å¸æµå…¥ = å·¦æ  (fill_48, fill_50)
- `direction='sell'` = ç½‘ç‚¹å–å‡ºå¤–å¸ = å¤–å¸æµå‡º = å³æ  (fill_49, fill_51)

### ä¿®å¤å†…å®¹

**æ–‡ä»¶**: `src/services/pdf/amlo_data_mapper.py` (lines 258-272)

**ä¿®æ”¹å‰** (é”™è¯¯):
```python
# âš ï¸ CRITICAL: directionå­—æ®µæ˜¯ä»ã€å®¢æˆ·è§†è§’ã€‘ï¼Œéœ€è¦åè½¬ä¸ºç½‘ç‚¹è§†è§’
# direction='buy'  = å®¢æˆ·ä¹°å…¥å¤–å¸ = ç½‘ç‚¹å–å‡ºå¤–å¸ = å¤–å¸æµå‡º = å³æ 
# direction='sell' = å®¢æˆ·å–å‡ºå¤–å¸ = ç½‘ç‚¹ä¹°å…¥å¤–å¸ = å¤–å¸æµå…¥ = å·¦æ 

is_institution_buy = (direction == 'sell')   # ç½‘ç‚¹ä¹°å…¥ï¼ˆå®¢æˆ·å–ï¼‰ = å·¦æ  âŒ é”™è¯¯ï¼
is_institution_sell = (direction == 'buy')   # ç½‘ç‚¹å–å‡ºï¼ˆå®¢æˆ·ä¹°ï¼‰ = å³æ  âŒ é”™è¯¯ï¼
```

**ä¿®æ”¹å** (æ­£ç¡®):
```python
# âš ï¸ CRITICAL: directionå­—æ®µå·²ç»æ˜¯ã€ç½‘ç‚¹è§†è§’ã€‘ï¼Œæ— éœ€è½¬æ¢
# direction='buy'  = ç½‘ç‚¹ä¹°å…¥å¤–å¸ = å¤–å¸æµå…¥ = å·¦æ  (fill_48, fill_50)
# direction='sell' = ç½‘ç‚¹å–å‡ºå¤–å¸ = å¤–å¸æµå‡º = å³æ  (fill_49, fill_51)

is_buy = (direction == 'buy')    # ç½‘ç‚¹ä¹°å…¥ = å·¦æ  âœ… æ­£ç¡®
is_sell = (direction == 'sell')  # ç½‘ç‚¹å–å‡º = å³æ  âœ… æ­£ç¡®
```

---

## ä¿®å¤2: AMLOè§¦å‘æ¡ä»¶æ£€æŸ¥ï¼ˆâ³ éœ€è¦æµ‹è¯•éªŒè¯ï¼‰

### æ•°æ®åº“ä¸­çš„è§¦å‘è§„åˆ™

é€šè¿‡æ£€æŸ¥æ•°æ®åº“ `trigger_rules` è¡¨ï¼Œå‘ç°å½“å‰æœ‰2æ¡AMLO-1-01è§¦å‘è§„åˆ™ï¼š

#### è§„åˆ™1: ID=16 (é«˜é£é™©æƒ…å†µ - ä¼˜å…ˆçº§æ›´é«˜)
```json
{
  "logic": "OR",
  "conditions": [
    {
      "logic": "AND",
      "conditions": [
        {"field": "total_amount", "operator": ">=", "value": 1000000},
        {"field": "customer_age", "operator": ">=", "value": 65}
      ]
    },
    {
      "logic": "AND",
      "conditions": [
        {"field": "total_amount", "operator": ">=", "value": 1500000},
        {"field": "payment_method", "operator": "==", "value": "cash"}
      ]
    }
  ]
}
```

**è§¦å‘æ¡ä»¶**:
- (100ä¸‡æ³°é“¢ AND å®¢æˆ·å¹´é¾„â‰¥65å²)
- OR (150ä¸‡æ³°é“¢ AND ç°é‡‘æ”¯ä»˜)

#### è§„åˆ™2: ID=13 (å¸¸è§„è§¦å‘)
```json
{
  "logic": "AND",
  "conditions": [
    {"field": "total_amount", "operator": ">=", "value": 5000000}
  ]
}
```

**è§¦å‘æ¡ä»¶**:
- 500ä¸‡æ³°é“¢åŠä»¥ä¸Š

### è§„åˆ™åˆ†æ

**âœ… è§„åˆ™æœ¬èº«æ˜¯æ­£ç¡®çš„**:
1. æ²¡æœ‰é™åˆ¶ `direction` å­—æ®µ - ä¹°å…¥å’Œå–å‡ºéƒ½ä¼šæ£€æŸ¥
2. é˜ˆå€¼è®¾ç½®åˆç† - 500ä¸‡æ³°é“¢æ˜¯ä¸»è¦é˜ˆå€¼

### å¯èƒ½çš„é—®é¢˜åŸå› 

#### é—®é¢˜1: ä¹°å…¥æ–¹å‘ä»»ä½•é‡‘é¢éƒ½è§¦å‘
å¯èƒ½çš„åŸå› ï¼š
1. **å®¢æˆ·å¹´é¾„æ•°æ®é—®é¢˜**: å¦‚æœå‰ç«¯ä¼ é€’çš„ `customer_age >= 65`ï¼Œä¸”é‡‘é¢â‰¥100ä¸‡ï¼Œä¼šè§¦å‘è§„åˆ™16
2. **æ”¯ä»˜æ–¹å¼æ•°æ®é—®é¢˜**: å¦‚æœ `payment_method='cash'` ä¸”é‡‘é¢â‰¥150ä¸‡ï¼Œä¼šè§¦å‘è§„åˆ™16

**æ£€æŸ¥æ–¹æ³•**:
```javascript
// å‰ç«¯æäº¤æ—¶æ£€æŸ¥è¿™äº›å­—æ®µçš„å€¼
console.log('customer_age:', customer_age);
console.log('payment_method:', payment_method);
console.log('total_amount:', total_amount);
```

#### é—®é¢˜2: å–å‡ºæ–¹å‘å‡ åƒä¸‡ä¸è§¦å‘
å¯èƒ½çš„åŸå› ï¼š
1. **é‡‘é¢å­—æ®µé—®é¢˜**: `total_amount` å¯èƒ½æ²¡æœ‰æ­£ç¡®ä¼ é€’
2. **æ•°æ®ç±»å‹é—®é¢˜**: `total_amount` å¯èƒ½æ˜¯å­—ç¬¦ä¸²è€Œä¸æ˜¯æ•°å­—

**ä¿®å¤å»ºè®®**: æ£€æŸ¥ `validation.py` ä¸­ä¼ é€’ç»™è§„åˆ™å¼•æ“çš„æ•°æ®

---

## æµ‹è¯•éªŒè¯æ¸…å•

### 1. äº¤æ˜“æ–¹å‘æµ‹è¯•

**æµ‹è¯•A: ç½‘ç‚¹ä¹°å…¥å¤–å¸ï¼ˆdirection='buy'ï¼‰**
```
è¾“å…¥:
- æ–¹å‘: ä¹°å…¥
- å¸ç§: USD
- é‡‘é¢: 1000 USD (å‡è®¾æ±‡ç‡35ï¼Œæœ¬å¸35000 THB)

é¢„æœŸ:
- AMLOæŠ¥å‘Šé‡‘é¢åœ¨ LEFT æ  (fill_48, fill_50)
- æ—¥å¿—æ˜¾ç¤º: [AMLODataMapper] Mapping: buy=True (LEFT)
```

**æµ‹è¯•B: ç½‘ç‚¹å–å‡ºå¤–å¸ï¼ˆdirection='sell'ï¼‰**
```
è¾“å…¥:
- æ–¹å‘: å–å‡º
- å¸ç§: USD
- é‡‘é¢: 1000 USD (æœ¬å¸35000 THB)

é¢„æœŸ:
- AMLOæŠ¥å‘Šé‡‘é¢åœ¨ RIGHT æ  (fill_49, fill_51)
- æ—¥å¿—æ˜¾ç¤º: [AMLODataMapper] Mapping: sell=True (RIGHT)
```

### 2. AMLOè§¦å‘æ¡ä»¶æµ‹è¯•

**æµ‹è¯•C: ä¹°å…¥100ä¸‡æ³°é“¢ï¼ˆä¸åº”è¯¥è§¦å‘ï¼Œé™¤éæ»¡è¶³é«˜é£é™©æ¡ä»¶ï¼‰**
```
è¾“å…¥:
- æ–¹å‘: ä¹°å…¥
- é‡‘é¢: 1000000 THB
- å®¢æˆ·å¹´é¾„: 30å²
- æ”¯ä»˜æ–¹å¼: bank_transfer

é¢„æœŸ:
- ä¸è§¦å‘AMLOï¼ˆé‡‘é¢<500ä¸‡ï¼Œä¸æ»¡è¶³é«˜é£é™©æ¡ä»¶ï¼‰
- æ—¥å¿—æ˜¾ç¤º: [RuleEngine.check_triggers] å…±åŒ¹é… 0 æ¡è§„åˆ™
```

**æµ‹è¯•D: ä¹°å…¥600ä¸‡æ³°é“¢ï¼ˆåº”è¯¥è§¦å‘ï¼‰**
```
è¾“å…¥:
- æ–¹å‘: ä¹°å…¥
- é‡‘é¢: 6000000 THB

é¢„æœŸ:
- è§¦å‘AMLO-1-01ï¼ˆæ»¡è¶³è§„åˆ™13: â‰¥500ä¸‡ï¼‰
- æ—¥å¿—æ˜¾ç¤º: [RuleEngine.check_triggers] å…±åŒ¹é… 1 æ¡è§„åˆ™
- æ—¥å¿—æ˜¾ç¤º: [RuleEngine.check_triggers] æœ€é«˜ä¼˜å…ˆçº§è§„åˆ™: AMLO-1-01å¸¸è§„è§¦å‘
```

**æµ‹è¯•E: å–å‡º600ä¸‡æ³°é“¢ï¼ˆåº”è¯¥è§¦å‘ï¼‰**
```
è¾“å…¥:
- æ–¹å‘: å–å‡º
- é‡‘é¢: 6000000 THB

é¢„æœŸ:
- è§¦å‘AMLO-1-01ï¼ˆæ»¡è¶³è§„åˆ™13: â‰¥500ä¸‡ï¼‰
- ä¸ä¹°å…¥æ–¹å‘ç»“æœç›¸åŒ
```

**æµ‹è¯•F: ä¹°å…¥200ä¸‡æ³°é“¢ + å®¢æˆ·65å²ä»¥ä¸Šï¼ˆåº”è¯¥è§¦å‘é«˜é£é™©è§„åˆ™ï¼‰**
```
è¾“å…¥:
- æ–¹å‘: ä¹°å…¥
- é‡‘é¢: 2000000 THB
- å®¢æˆ·å¹´é¾„: 70å²

é¢„æœŸ:
- è§¦å‘AMLO-1-01ï¼ˆæ»¡è¶³è§„åˆ™16é«˜é£é™©ï¼‰
- æ—¥å¿—æ˜¾ç¤ºåŒ¹é…è§„åˆ™: AMLO-1-01é«˜é£é™©æƒ…å†µ
```

---

## åç«¯æ—¥å¿—æ£€æŸ¥

é‡å¯åç«¯åï¼Œæ‰§è¡Œäº¤æ˜“æ—¶åº”è¯¥çœ‹åˆ°ä»¥ä¸‹æ—¥å¿—ï¼š

### æ­£å¸¸çš„æ—¥å¿—æµç¨‹

```
# 1. äº¤æ˜“éªŒè¯å¼€å§‹
ğŸ” éªŒè¯APIæ”¶åˆ°è¯·æ±‚: {...}
ğŸ” å¼€å§‹æ£€æŸ¥ä½™é¢ - exchange_type: buy, amount: 1000

# 2. æ£€æŸ¥AMLOè§¦å‘æ¡ä»¶
ğŸ” æ£€æŸ¥AMLOè§¦å‘æ¡ä»¶ï¼Œæ•°æ®: {
  'customer_id': '...',
  'direction': 'buy',
  'currency_code': 'USD',
  'total_amount': Decimal('35000'),
  ...
}

# 3. è§„åˆ™å¼•æ“è¯„ä¼°
[RuleEngine.check_triggers] ========== å¼€å§‹æ£€æŸ¥è§¦å‘æ¡ä»¶ ==========
[RuleEngine.check_triggers] æŠ¥å‘Šç±»å‹: AMLO-1-01
[RuleEngine.check_triggers] æŸ¥è¯¢åˆ° 2 æ¡å¯ç”¨çš„è§„åˆ™

# 4. è¯„ä¼°æ¯æ¡è§„åˆ™
[RuleEngine.check_triggers] --- è¯„ä¼°è§„åˆ™ 16: AMLO-1-01é«˜é£é™©æƒ…å†µ ---
[RuleEngine.check_triggers] è§„åˆ™åŒ¹é…ç»“æœ: NOT_MATCHED
[RuleEngine.check_triggers] æœªåŒ¹é…çš„æ¡ä»¶: [...]

[RuleEngine.check_triggers] --- è¯„ä¼°è§„åˆ™ 13: AMLO-1-01å¸¸è§„è§¦å‘ ---
[RuleEngine.check_triggers] è§„åˆ™åŒ¹é…ç»“æœ: NOT_MATCHED
[RuleEngine.check_triggers] æœªåŒ¹é…çš„æ¡ä»¶: [total_amount: 35000 < 5000000]

# 5. æœ€ç»ˆç»“æœ
[RuleEngine.check_triggers] ========== è¯„ä¼°å®Œæˆ ==========
[RuleEngine.check_triggers] å…±åŒ¹é… 0 æ¡è§„åˆ™
â„¹ï¸ AMLO-1-01 æœªè§¦å‘
```

### å¦‚æœè§¦å‘ï¼Œåº”è¯¥çœ‹åˆ°ï¼š

```
[RuleEngine.check_triggers] è§„åˆ™åŒ¹é…ç»“æœ: MATCHED
[RuleEngine.check_triggers] [OK] è§„åˆ™ 13 åŒ¹é…æˆåŠŸï¼Œæ·»åŠ åˆ°ç»“æœåˆ—è¡¨
[RuleEngine.check_triggers] å…±åŒ¹é… 1 æ¡è§„åˆ™
[RuleEngine.check_triggers] æœ€é«˜ä¼˜å…ˆçº§è§„åˆ™: AMLO-1-01å¸¸è§„è§¦å‘ (ID: 13)
âœ… AMLO-1-01 è§¦å‘!
```

---

## PDFç”Ÿæˆæ—¥å¿—æ£€æŸ¥

å¦‚æœè§¦å‘AMLOå¹¶ç”ŸæˆPDFï¼Œåº”è¯¥çœ‹åˆ°ï¼š

```
[AMLODataMapper] Direction (institution): buy
[AMLODataMapper] Mapping: buy=True (LEFT), sell=False (RIGHT)
[AMLODataMapper] LEFT column (buy): fill_48/fill_50 = 35000.00
```

æˆ–

```
[AMLODataMapper] Direction (institution): sell
[AMLODataMapper] Mapping: buy=False (LEFT), sell=True (RIGHT)
[AMLODataMapper] RIGHT column (sell): fill_49/fill_51 = 35000.00
```

---

## é‡å¯æµ‹è¯•æ­¥éª¤

```bash
# 1. é‡å¯åç«¯
python src/main.py

# 2. æµ‹è¯•ä¹°å…¥100ä¸‡ï¼ˆä¸åº”è§¦å‘ï¼‰
# - å‰ç«¯é€‰æ‹©"ä¹°å…¥"
# - è¾“å…¥é‡‘é¢ç¡®ä¿æœ¬å¸ç­‰å€¼ < 500ä¸‡
# - æäº¤äº¤æ˜“
# - æ£€æŸ¥ï¼šä¸åº”è¯¥æç¤ºéœ€è¦AMLOæŠ¥å‘Š

# 3. æµ‹è¯•ä¹°å…¥600ä¸‡ï¼ˆåº”è¯¥è§¦å‘ï¼‰
# - å‰ç«¯é€‰æ‹©"ä¹°å…¥"
# - è¾“å…¥é‡‘é¢ç¡®ä¿æœ¬å¸ç­‰å€¼ >= 500ä¸‡
# - æäº¤äº¤æ˜“
# - æ£€æŸ¥ï¼šåº”è¯¥æç¤ºéœ€è¦AMLOæŠ¥å‘Šï¼Œå¹¶å¯ä»¥åˆ›å»ºé¢„çº¦

# 4. æµ‹è¯•å–å‡º600ä¸‡ï¼ˆåº”è¯¥è§¦å‘ï¼‰
# - å‰ç«¯é€‰æ‹©"å–å‡º"
# - è¾“å…¥é‡‘é¢ç¡®ä¿æœ¬å¸ç­‰å€¼ >= 500ä¸‡
# - æäº¤äº¤æ˜“
# - æ£€æŸ¥ï¼šåº”è¯¥æç¤ºéœ€è¦AMLOæŠ¥å‘Š

# 5. ç”ŸæˆAMLOæŠ¥å‘ŠPDFï¼Œæ£€æŸ¥é‡‘é¢ä½ç½®
# - ä¹°å…¥äº¤æ˜“ â†’ é‡‘é¢åœ¨å·¦æ 
# - å–å‡ºäº¤æ˜“ â†’ é‡‘é¢åœ¨å³æ 
```

---

## å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨

### è°ƒè¯•æ­¥éª¤

1. **å¯ç”¨è¯¦ç»†æ—¥å¿—**:
   - è®¾ç½® `LOG_LEVEL=DEBUG` in `.env`
   - é‡å¯åç«¯

2. **æ£€æŸ¥å‰ç«¯ä¼ é€’çš„æ•°æ®**:
   ```javascript
   // åœ¨å‰ç«¯æ§åˆ¶å°æŸ¥çœ‹æäº¤çš„æ•°æ®
   console.log('Validation request:', data);
   ```

3. **æ£€æŸ¥è§„åˆ™å¼•æ“æ¥æ”¶çš„æ•°æ®**:
   - æŸ¥çœ‹åç«¯æ—¥å¿—ä¸­çš„ `[RuleEngine.check_triggers] äº¤æ˜“æ•°æ®:` éƒ¨åˆ†
   - ç¡®è®¤ `total_amount`, `customer_age`, `payment_method` çš„å€¼

4. **æ‰‹åŠ¨æµ‹è¯•è§„åˆ™å¼•æ“**:
   ```python
   cd /d/Code/ExchangeNew
   python -c "
   import sys
   sys.path.insert(0, 'src')
   from services.repform.rule_engine import RuleEngine
   from services.db_service import DatabaseService

   session = DatabaseService.get_session()

   # æµ‹è¯•æ•°æ®
   data = {
       'total_amount': 6000000,
       'customer_age': 30,
       'payment_method': 'cash',
       'direction': 'buy'
   }

   result = RuleEngine.check_triggers(session, 'AMLO-1-01', data)
   print(f'è§¦å‘: {result[\"triggered\"]}')
   print(f'åŒ¹é…è§„åˆ™: {result[\"trigger_rules\"]}')
   "
   ```

---

## æ€»ç»“

| é¡¹ç›® | çŠ¶æ€ |
|-----|------|
| **ä¿®å¤äº¤æ˜“æ–¹å‘é€»è¾‘** | âœ… å·²å®Œæˆ |
| **æ£€æŸ¥AMLOè§¦å‘è§„åˆ™** | âœ… è§„åˆ™æ­£ç¡® |
| **æµ‹è¯•éªŒè¯** | â³ éœ€è¦ç”¨æˆ·æµ‹è¯• |

**ä¿®æ”¹çš„æ–‡ä»¶**:
- `src/services/pdf/amlo_data_mapper.py` (lines 258-272, 316-317)

**ä¸‹ä¸€æ­¥**:
1. é‡å¯åç«¯
2. æŒ‰ç…§æµ‹è¯•æ¸…å•é€ä¸€æµ‹è¯•
3. å¦‚æœé—®é¢˜ä»å­˜åœ¨ï¼ŒæŸ¥çœ‹è¯¦ç»†æ—¥å¿—å¹¶æä¾›åé¦ˆ

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-10-29
**ä¿®å¤äººå‘˜**: Claude Code Assistant
